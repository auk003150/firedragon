<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>å¤§å‘èˆç«é¾ AR å°éŠæˆ²ï¼ˆHIRO Marker ç‰ˆ, jsartoolkit5ï¼‰</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; color:#fff; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans HK","Noto Sans CJK","PingFang HK","Heiti TC",Arial,sans-serif; touch-action:manipulation; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .wrap { position:relative; width:100%; height:100vh; overflow:hidden; background:#000; }
    video#cam { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; z-index:1; pointer-events:none; }
    img#bg { position:absolute; inset:0; width:100%; height:100%; object-fit:cover; mix-blend-mode:lighten; opacity:1; z-index:2; pointer-events:none; }
    canvas#game { position:absolute; inset:0; width:100%; height:100%; z-index:3; pointer-events:none; }
    .ui { position:absolute; left:0; right:0; top:0; display:grid; gap:6px; padding:10px 12px; background:linear-gradient(180deg,rgba(0,0,0,.5),rgba(0,0,0,0)); z-index:10; }
    .topbar { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .hudbar { display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .btn { background:#e11d48; border:none; color:#fff; border-radius:10px; padding:10px 14px; font-weight:700; box-shadow:0 4px 12px rgba(225,29,72,.35); cursor:pointer; }
    .btn.ghost { background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.2); box-shadow:none; }
    .chip { background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.2); border-radius:999px; padding:6px 10px; font-size:14px; }
    .hint { position:absolute; left:0; right:0; top:50%; transform:translateY(-50%); text-align:center; padding:0 16px; color:#ffd166; font-weight:700; text-shadow:0 2px 10px rgba(0,0,0,.7); z-index:4; pointer-events:none; }
    .ok { color:#22c55e; } .bad { color:#f97316; }
    .panel-backdrop { position:absolute; inset:0; background:rgba(0,0,0,.4); z-index:98; opacity:0; pointer-events:none; transition:opacity .2s; }
    .panel-backdrop.open { opacity:1; pointer-events:auto; }
    .panel { position:absolute; top:0; right:0; height:100%; width:min(420px,92vw); background:rgba(17,24,39,.9); backdrop-filter:blur(10px); border-left:1px solid rgba(255,255,255,.12); transform:translateX(100%); transition:transform .25s; z-index:99; color:#fff; overflow:auto; -webkit-overflow-scrolling:touch; }
    .panel.open { transform:translateX(0); }
    .panel header { position:sticky; top:0; background:rgba(17,24,39,.95); padding:12px; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,.1); }
    .panel .section { padding:12px; display:grid; gap:12px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .mini { padding:8px 10px; font-weight:600; font-size:12px; border-radius:8px; background:rgba(0,0,0,.45); border:1px solid rgba(255,255,255,.2); color:#fff; cursor:pointer; }
    .danger { background:#7f1d1d; border-color:rgba(255,255,255,.25); }
    .sliderRow { display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; }
    .val { font-variant-numeric:tabular-nums; color:#fcd34d; min-width:40px; text-align:right; }
  </style>
</head>
<body>
  <div class="wrap">
    <video id="cam" playsinline autoplay muted></video>
    <img id="bg" alt="èƒŒæ™¯" src="image_1.png" />
    <canvas id="game"></canvas>

    <div class="ui">
      <div class="topbar">
        <button id="startBtn" class="btn" type="button">é–‹å§‹</button>
        <button id="menuBtn" class="btn ghost" type="button" aria-haspopup="true" aria-controls="panel">â‰¡ é¸å–®</button>
      </div>
      <div class="hudbar">
        <div class="chip">åˆ†æ•¸ï¼š<span id="score">0</span></div>
        <div class="chip">Comboï¼š<span id="combo">0</span></div>
        <div class="chip">æ™‚é–“ï¼š<span id="time">60</span>s</div>
      </div>
    </div>

    <div id="panelBackdrop" class="panel-backdrop" aria-hidden="true"></div>
    <aside id="panel" class="panel" aria-hidden="true">
      <header>
        <h2>è¨­å®š</h2>
        <button id="closePanel" class="btn ghost" type="button" aria-label="é—œé–‰">âœ•</button>
      </header>
      <div class="section">
        <div class="row">
          <div class="label">é¡é ­</div>
          <div class="controls"><button id="toggleFacing" class="mini" type="button">åˆ‡æ›é¡é ­</button></div>
        </div>
        <div class="row">
          <div class="label">é¡åƒ</div>
          <div class="controls"><button id="toggleMirror" class="mini" type="button">é¡åƒï¼šé—œ</button></div>
        </div>
        <div class="row">
          <div class="label">è¢å¹•</div>
          <div class="controls"><button id="fullscreenBtn" class="mini" type="button">å…¨å±</button></div>
        </div>
        <div class="row">
          <div class="label">éŠæˆ²</div>
          <div class="controls"><button id="resetBtn" class="mini danger" type="button">é‡ç½®</button></div>
        </div>
      </div>
      <div class="section" style="border-top:1px solid rgba(255,255,255,.1)">
        <div class="sliderRow">
          <div class="label">ç›®æ¨™å¯†åº¦</div>
          <div class="controls"><input id="density" type="range" min="1" max="10" value="4" /><span id="densityVal" class="val">4</span></div>
        </div>
        <div class="sliderRow">
          <div class="label">é€Ÿåº¦</div>
          <div class="controls"><input id="speed" type="range" min="1" max="10" value="5" /><span id="speedVal" class="val">5</span></div>
        </div>
      </div>
      <div class="section" style="border-top:1px solid rgba(255,255,255,.1)">
        <p style="margin:0; font-size:12px; color:#cbd5e1">
          è«‹æŠŠ HIRO Markerï¼ˆé»‘æ¡†ç™½åº•ã€å…§æœ‰ Hiro å­—æ¨£ï¼‰æ”¾å…¥é¡é ­ã€‚åµæ¸¬æˆåŠŸå¾Œï¼Œç«é¾é ­æœƒè·Ÿéš¨å…¶ä¸­å¿ƒã€‚
        </p>
      </div>
    </aside>

    <div id="hint" class="hint">æŒ‰ã€Œé–‹å§‹ã€å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚å°‡ HIRO æ”¾åˆ°é¡é ­ä¸­ã€‚</div>
  </div>

  <!-- jsartoolkit5ï¼ˆæ”¯æ´ HIRO/KANJI markerï¼‰ -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/jsartoolkit5/build/artoolkit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/jsartoolkit5/build/artoolkit.api.js"></script>

  <script>
    // DOM
    const video = document.getElementById('cam');
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d', { alpha: true });

    const startBtn = document.getElementById('startBtn');
    const menuBtn = document.getElementById('menuBtn');
    const panel = document.getElementById('panel');
    const panelBackdrop = document.getElementById('panelBackdrop');
    const closePanelBtn = document.getElementById('closePanel');

    const toggleFacingBtn = document.getElementById('toggleFacing');
    const toggleMirrorBtn = document.getElementById('toggleMirror');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const resetBtn = document.getElementById('resetBtn');

    const scoreEl = document.getElementById('score');
    const comboEl = document.getElementById('combo');
    const timeEl = document.getElementById('time');
    const hintEl = document.getElementById('hint');

    const densEl = document.getElementById('density');
    const speedEl = document.getElementById('speed');
    const densityVal = document.getElementById('densityVal');
    const speedVal = document.getElementById('speedVal');

    // ç‹€æ…‹
    let running = false, gameOver = false;
    let W=0, H=0, dpr=1;
    let score=0, combo=0, timeLeft=60, timerId=null;

    let useEnvironment = true;
    let mirrored = false;
    let currentStream = null;

    // jsartoolkit5 ç‰©ä»¶
    let arController = null;
    let hiroPatternId = -1;

    // å½±åƒå·¥ä½œç•«å¸ƒï¼ˆæä¾›çµ¦ artoolkitï¼‰
    const workCanvas = document.createElement('canvas');
    const wctx = workCanvas.getContext('2d', { willReadFrequently: true });

    // ç«é¾ç´ æ
    const dragonImg = new Image();
    dragonImg.src = 'image_2.png';
    let dragonImgReady = false;
    dragonImg.onload = () => { dragonImgReady = true; };

    const sprite = { drawWidth: 90, drawHeight: 90, headAnchorX: 0.6, headAnchorY: 0.6, fineOffsetX: 0, fineOffsetY: -0.1 };

    // éŠæˆ²è³‡æ–™
    const goodList = ['ç¦','æ˜¥','è²¡','å®‰','æ—º','å‰','ç¥¥','è³€','é¾','å¹´'];
    const badList  = ['âš½','ğŸ”','ğŸ§','ğŸ§Š','ğŸ§¼','ğŸº','ğŸ’¡','ğŸ“','ğŸ§½','ğŸ§¯'];
    const items=[]; const MAX_ITEMS=14;

    // ç²’å­ï¼ˆå–®ä¸€å®šç¾©ï¼Œé¿å…é‡è¤‡å®£å‘Šï¼‰
    const particles=[]; const MAX_PARTICLES=1200;

    // ç•«å¸ƒå°ºå¯¸
    let resizeTimer=null;
    function resize() {
      const doResize = () => {
        dpr = Math.min(window.devicePixelRatio || 1, 2);
        const rect = canvas.getBoundingClientRect();
        W = rect.width; H = rect.height;
        canvas.width = Math.round(W * dpr);
        canvas.height = Math.round(H * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
      };
      clearTimeout(resizeTimer); resizeTimer=setTimeout(doResize,50);
    }
    window.addEventListener('resize', resize, { passive:true });
    window.addEventListener('orientationchange', () => setTimeout(resize,150), { passive:true });
    resize();

    // æ”¯æ´æª¢æŸ¥
    function supported(){
      const ok = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
      if(!ok){ hintEl.textContent='æ­¤è£ç½®æˆ–ç€è¦½å™¨ä¸æ”¯æ´ç›¸æ©Ÿã€‚è«‹ç”¨ Chrome/Safari ä¸¦ç¢ºä¿ HTTPSã€‚'; hintEl.className='hint bad'; }
      if(location.protocol!=='https:' && location.hostname!=='localhost'){ hintEl.textContent='è«‹ä½¿ç”¨ HTTPS ç¶²ç«™ä»¥é–‹å•Ÿç›¸æ©Ÿæ¬Šé™ã€‚'; hintEl.className='hint bad'; }
      if(typeof ARController === 'undefined'){ hintEl.textContent='ARToolKit æœªè¼‰å…¥ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ–æ”¹æœ¬åœ°å¼•ç”¨ã€‚'; hintEl.className='hint bad'; }
      return ok && typeof ARController !== 'undefined';
    }

    // ç›¸æ©Ÿ
    async function stopStream(){ if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); currentStream=null; } }
    async function initCamera(){
      const kinds=[
        { width:{ideal:1280}, height:{ideal:720} },
        { width:{ideal:960}, height:{ideal:540} },
        { width:{ideal:640}, height:{ideal:480} }
      ];
      const facing = useEnvironment ? { ideal:'environment' } : { ideal:'user' };
      let lastErr=null;
      await stopStream();
      for(const res of kinds){
        try{
          const stream=await navigator.mediaDevices.getUserMedia({ audio:false, video:{...res, facingMode:facing} });
          currentStream=stream; video.srcObject=stream; video.playsInline=true;
          await video.play().catch(()=>{});
          applyMirror();
          return true;
        }catch(err){ lastErr=err; }
      }
      console.error('Camera init failed:', lastErr);
      hintEl.textContent='ç›¸æ©Ÿç„¡æ³•å•Ÿå‹•ï¼Œè«‹æª¢æŸ¥æ¬Šé™/ç€è¦½å™¨è¨­å®šæˆ–æ”¹ç”¨å…¶ä»–è£ç½®ã€‚'; hintEl.className='hint bad';
      return false;
    }
    function applyMirror(){ video.style.transform = mirrored ? 'scaleX(-1)' : 'none'; toggleMirrorBtn.textContent = `é¡åƒï¼š${mirrored?'é–‹':'é—œ'}`; }

    // åˆå§‹åŒ– ARController èˆ‡è¼‰å…¥ HIRO Pattern
    async function initAR() {
      const vw = video.videoWidth|0, vh = video.videoHeight|0;
      if (vw===0 || vh===0) return false;

      const processScale = 0.9; // æé«˜ç©©å®šæ€§
      workCanvas.width = Math.max(320, Math.round(vw*processScale));
      workCanvas.height = Math.max(240, Math.round(vh*processScale));

      return new Promise((resolve) => {
        const cameraParam = new ARCameraParam();
        cameraParam.onload = function() {
          arController = new ARController(workCanvas.width, workCanvas.height, cameraParam);
          arController.setPatternDetectionMode(artoolkit.AR_TEMPLATE_MATCHING_COLOR); // HIRO ç”¨å½©è‰²æ¨¡æ¿åŒ¹é…è¼ƒç©©
          // ä»¥ CDN æä¾›çš„ HIRO pattern
          arController.loadMarker('https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/data/patt.hiro', function(id) {
            hiroPatternId = id;
            resolve(true);
          });
        };
        cameraParam.load();
      });
    }

    // åµæ¸¬ HIRO ä¸­å¿ƒ
    function detectHiroCenter() {
      const vw = video.videoWidth|0, vh = video.videoHeight|0;
      if (vw===0 || vh===0 || !arController || hiroPatternId<0) return null;

      wctx.drawImage(video, 0, 0, workCanvas.width, workCanvas.height);
      const imageData = wctx.getImageData(0, 0, workCanvas.width, workCanvas.height);
      arController.process(imageData);

      const markerCount = arController.getMarkerNum();
      let best = null;

      for (let i=0; i<markerCount; i++){
        const markerId = arController.getMarkerId(i);
        if (markerId === hiroPatternId) {
          const corners = [];
          for (let j=0; j<4; j++) {
            const pos = arController.getCornerByIndex(i, j);
            corners.push({ x: pos.x, y: pos.y });
          }
          best = { id: markerId, corners };
          break;
        }
      }
      if (!best) return null;

      let cx = 0, cy = 0;
      for (const p of best.corners) { cx += p.x; cy += p.y; }
      cx/=4; cy/=4;
      if (mirrored) cx = workCanvas.width - cx;

      const px = cx / workCanvas.width * W;
      const py = cy / workCanvas.height * H;
      return { x: px, y: py };
    }

    // éŠæˆ²ï¼šç›®æ¨™ã€ç²’å­ã€ç¹ªè£½
    function spawnItem(){
      const isGood = Math.random()<0.6;
      const src = isGood ? goodList : badList;
      const text = src[Math.floor(Math.random()*src.length)];
      const size = 28 + Math.random()*18;
      const margin = 28 + size;
      const x = margin + Math.random()*(W - margin*2);
      const y = 80 + Math.random()*(H - 160);
      const speed = parseInt(speedEl.value,10);
      const vx = (Math.random()-0.5)*speed;
      const vy = (Math.random()-0.5)*speed;
      const ttl = 12 + Math.random()*10;
      items.push({ x,y,vx,vy,text,size,isGood,ttl });
    }
    function ensureItems(){ const target = parseInt(densEl.value,10)*3; while(items.length<Math.min(MAX_ITEMS,target)) spawnItem(); }
    function updateItems(dt){
      for(let i=items.length-1;i>=0;i--){
        const it=items[i]; it.x+=it.vx; it.y+=it.vy; it.ttl-=dt;
        if(it.x<20||it.x>W-20) it.vx*=-1;
        if(it.y<60||it.y>H-60) it.vy*=-1;
        if(it.ttl<=0) items.splice(i,1);
      } ensureItems();
    }
    function drawItems(ctx){
      for(const it of items){
        ctx.save();
        ctx.font=`700 ${it.size}px system-ui, "Noto Color Emoji", "Apple Color Emoji"`;
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.shadowColor = it.isGood ? 'rgba(255,215,0,0.9)' : 'rgba(255,90,0,0.7)';
        ctx.shadowBlur = 12;
        ctx.fillStyle = it.isGood ? '#ffd166' : '#ff6b6b';
        ctx.fillText(it.text, it.x, it.y);
        ctx.restore();
      }
    }

    function spawnIncenseParticles(pos, dir, count=6){
      for(let i=0;i<count;i++){
        if(particles.length >= MAX_PARTICLES) break;
        const angle=Math.atan2(dir.y,dir.x) + (Math.random()*0.8 - 0.4);
        const speed=40 + Math.random()*120;
        const vx=Math.cos(angle)*speed;
        const vy=Math.sin(angle)*speed - Math.random()*20;
        particles.push({
          x: pos.x + (Math.random()*6-3),
          y: pos.y + (Math.random()*6-3),
          vx, vy,
          life: 0.45 + Math.random()*0.35,
          age: 0,
          size: 2 + Math.random()*2.5,
          hue: 20 + Math.random()*20
        });
      }
    }
    function updateParticles(dt){
      for(let i=particles.length-1;i>=0;i--){
        const p=particles[i];
        p.age += dt; p.x += p.vx*dt; p.y += p.vy*dt; p.vy += 20*dt;
        if(p.age >= p.life) particles.splice(i,1);
      }
    }
    function drawParticles(ctx){
      ctx.save(); ctx.globalCompositeOperation='lighter';
      for(const p of particles){
        const t=p.age/p.life; const alpha=1-t;
        const size=p.size*(0.8+0.4*(1-t));
        ctx.fillStyle=`hsla(${p.hue},90%,${60 - t*30}%,${alpha})`;
        ctx.beginPath(); ctx.arc(p.x,p.y,size,0,Math.PI*2); ctx.fill();
      }
      ctx.restore();
    }

    function drawDragon(ctx, head){
      if(!dragonImgReady) return;
      const imgW=sprite.drawWidth, imgH=sprite.drawHeight;
      ctx.save(); ctx.translate(head.x, head.y);
      const dx = -imgW*sprite.headAnchorX + (sprite.fineOffsetX||0);
      const dy = -imgH*sprite.headAnchorY + (sprite.fineOffsetY ? sprite.fineOffsetY*imgH : 0);
      ctx.translate(dx, dy);
      ctx.drawImage(dragonImg, 0, -imgH*0.5, imgW, imgH);
      spawnIncenseParticles({x:0,y:0},{x:1,y:0},8);
      ctx.restore();
    }

    function circleHit(ax,ay,bx,by,r){ const dx=ax-bx, dy=ay-by; return (dx*dx+dy*dy)<=r*r; }
    function handleCollisions(head){
      for(let i=items.length-1;i>=0;i--){
        const it=items[i];
        const radius=Math.max(24, sprite.drawHeight*0.35);
        if(circleHit(head.x,head.y,it.x,it.y,radius)){
          if(it.isGood){ combo++; const bonus=10+Math.min(60,combo*2); score+=bonus; flash('+ '+bonus,it.x,it.y,true); }
          else { combo=0; score=Math.max(0, score-15); flash('âˆ’ 15',it.x,it.y,false); }
          items.splice(i,1); scoreEl.textContent=score; comboEl.textContent=combo;
        }
      }
    }

    const floatTexts=[];
    function flash(text,x,y,ok){ floatTexts.push({text,x,y,ok,t:0}); }
    function drawFloatTexts(dt){
      for(let i=floatTexts.length-1;i>=0;i--){
        const f=floatTexts[i]; f.t+=dt; const alpha=Math.max(0,1-f.t/1.2); const dy=-f.t*40;
        ctx.save(); ctx.globalAlpha=alpha; ctx.font='800 22px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillStyle=f.ok?'#22c55e':'#f97316'; ctx.fillText(f.text,f.x,f.y+dy); ctx.restore();
        if(alpha<=0.01) floatTexts.splice(i,1);
      }
    }

    let lastTime=performance.now();
    let headPos={x:0,y:0}, headSmooth={x:0,y:0};
    const smoothing=0.28;

    function tick(now){
      const dt = Math.min(0.033, (now-lastTime)/1000); lastTime=now;
      ctx.clearRect(0,0,W,H);

      const m = detectHiroCenter();
      if(m){
        headPos=m;
        headSmooth.x = headSmooth.x + (headPos.x - headSmooth.x) * smoothing || headPos.x;
        headSmooth.y = headSmooth.y + (headPos.y - headSmooth.y) * smoothing || headPos.y;
        hintEl.textContent='å·²åµæ¸¬åˆ° HIRO Markerï¼èˆå‹•ç«é¾ï¼'; hintEl.className='hint ok';
      }else{
        hintEl.textContent='æœªåµæ¸¬åˆ° HIROï¼Œè«‹æ­£å°ç›¸æ©Ÿã€ä¿æŒå¹³æ•´èˆ‡å…‰ç·šå‡å‹»ã€‚'; hintEl.className='hint bad';
      }

      updateItems(dt); drawItems(ctx);
      const head = { x: headSmooth.x || W/2, y: headSmooth.y || H/2 };
      drawDragon(ctx, head);

      updateParticles(dt); drawParticles(ctx);
      handleCollisions(head); drawFloatTexts(dt);

      if(running && !gameOver) requestAnimationFrame(tick);
    }

    function startGameLoop(){
      if(running) return;
      running=true; gameOver=false; lastTime=performance.now();
      ensureItems();
      clearInterval(timerId); timeLeft=60; timeEl.textContent=timeLeft;
      timerId=setInterval(()=>{ timeLeft--; timeEl.textContent=timeLeft;
        if(timeLeft<=0){ clearInterval(timerId); running=false; gameOver=true; hintEl.textContent=`æ™‚é–“åˆ°ï¼ç¸½åˆ†ï¼š${score}`; hintEl.className='hint'; startBtn.disabled=false; }
      },1000);
      requestAnimationFrame(tick);
    }

    async function startAll(){
      if(!supported()) return;
      startBtn.disabled=true;
      try{
        const okCam = await initCamera();
        if(!okCam){ startBtn.disabled=false; return; }
        // ç­‰å¾… video å–å¾—å°ºå¯¸
        await new Promise(r => {
          const chk=()=> (video.videoWidth>0? r(): setTimeout(chk,50));
          chk();
        });
        const okAR = await initAR();
        if(!okAR){
          hintEl.textContent='AR åˆå§‹åŒ–å¤±æ•—ã€‚'; hintEl.className='hint bad'; startBtn.disabled=false; return;
        }
        startGameLoop();
      }catch(err){
        console.error(err);
        hintEl.textContent='åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ HTTPS/é¡é ­/ç¶²è·¯ã€‚';
        hintEl.className='hint bad';
        startBtn.disabled=false;
      }
    }

    // UI ç¶å®š
    startBtn.addEventListener('click', startAll, { passive:true });
    toggleFacingBtn.addEventListener('click', async ()=>{ useEnvironment=!useEnvironment; await initCamera(); });
    toggleMirrorBtn.addEventListener('click', ()=>{ mirrored=!mirrored; applyMirror(); });
    fullscreenBtn.addEventListener('click', ()=>{
      const el=document.documentElement;
      if(!document.fullscreenElement){ (el.requestFullscreen&&el.requestFullscreen())||(el.webkitRequestFullscreen&&el.webkitRequestFullscreen()); }
      else { (document.exitFullscreen&&document.exitFullscreen())||(document.webkitExitFullscreen&&document.webkitExitFullscreen()); }
    });
    resetBtn.addEventListener('click', async ()=>{
      score=0; combo=0; scoreEl.textContent=score; comboEl.textContent=combo;
      items.length=0; ensureItems();
      headPos={x:W/2,y:H/2}; headSmooth={x:headPos.x,y:headPos.y};
      hintEl.textContent='é‡ç½®å®Œæˆï¼ŒæŒ‰ã€Œé–‹å§‹ã€é‡æ–°å•Ÿå‹•ç›¸æ©Ÿã€‚'; hintEl.className='hint';
      running=false; gameOver=false; clearInterval(timerId); timeLeft=60; timeEl.textContent=timeLeft;
      startBtn.disabled=false; await stopStream();
    });

    function openPanel(){ panel.classList.add('open'); panelBackdrop.classList.add('open'); panel.setAttribute('aria-hidden','false'); panelBackdrop.setAttribute('aria-hidden','false'); }
    function closePanel(){ panel.classList.remove('open'); panelBackdrop.classList.remove('open'); panel.setAttribute('aria-hidden','true'); panelBackdrop.setAttribute('aria-hidden','true'); }
    menuBtn.addEventListener('click', openPanel);
    panelBackdrop.addEventListener('click', closePanel);
    closePanelBtn.addEventListener('click', closePanel);

    function bindVal(input, labelEl){ const sync=()=> labelEl.textContent=input.value; input.addEventListener('input', sync); sync(); }
    bindVal(densEl, densityVal); bindVal(speedEl, speedVal);

    // åˆå§‹é ­éƒ¨ä½ç½®
    let headPosInit = {x: W/2, y: H/2};
    let headSmoothInit = {x: headPosInit.x, y: headPosInit.y};
    headPos = headPosInit;
    headSmooth = headSmoothInit;
  </script>
</body>
</html>
