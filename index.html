<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Êñ∞Êò•Â§ßÂùëËàûÁÅ´ÈæçÈÅäÊà≤ (Short Dragon)</title>

  <style>
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      overflow: hidden; font-family: system-ui, -apple-system, "Microsoft YaHei", sans-serif;
      background: #000;
    }

    /* Background MP4 */
    #bg-video {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: 0;
      opacity: 0.85;
      pointer-events: none;
    }

    /* Camera background */
    #video {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
      opacity: 0.15;
      z-index: 1;
    }

    /* UI layer */
    #ui-layer {
      position: absolute; inset: 0;
      pointer-events: none;
      z-index: 10;
      overflow: hidden;
    }

    #score-board, #timer-board {
      position: absolute; top: 16px;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px 16px;
      border-radius: 14px;
      font-size: 18px;
      font-weight: 800;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.25);
      pointer-events: none;
    }
    #score-board { left: 16px; color: #ffeb3b; text-shadow: 0 0 5px #ff5722; }
    #timer-board { right: 16px; color: #fff; }

    /* Game area for bubbles */
    #game-area { position: absolute; inset: 0; z-index: 5; pointer-events: none; }

    /* Cursor (dragon head) - REVERTED TO ORIGINAL SIZE */
    #aim-cursor {
      position: absolute; width: 160px; height: 160px;
      transform: translate(-50%, -50%);
      display: none;
      justify-content: center; align-items: center;
      z-index: 20;
      pointer-events: none;
    }

    /* Dragon body container */
    #dragon-body-container { position: absolute; inset: 0; pointer-events: none; z-index: 15; }

    /* --- Straw texture --- */
    .straw-texture {
      background-color: #d4b483;
      background-image:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4) 0%, transparent 50%),
        linear-gradient(to bottom, rgba(0,0,0,0.1), transparent 20%, transparent 80%, rgba(0,0,0,0.4)),
        repeating-linear-gradient(85deg, transparent 0px, transparent 2px, rgba(93, 64, 55, 0.3) 3px, transparent 4px),
        repeating-linear-gradient(95deg, transparent 0px, transparent 3px, rgba(141, 110, 99, 0.4) 4px, transparent 6px),
        repeating-linear-gradient(0deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 1px, transparent 1px, transparent 5px);
      border: 1px solid #8d6e63;
      box-shadow: inset 0 0 10px rgba(62, 39, 35, 0.5);
    }

    /* --- Dragon head --- */
    .dragon-head-group { position: relative; width: 120px; height: 120px; animation: float-head 2s ease-in-out infinite; }
    .dh-skull { position: absolute; top: 25px; left: 20px; width: 80px; height: 60px; border-radius: 25px 25px 15px 15px; z-index: 5; }
    .dh-snout { position: absolute; top: 50px; left: 10px; width: 90px; height: 40px; border-radius: 30px; z-index: 6; }
    .dh-snout::before, .dh-snout::after { content: ''; position: absolute; bottom: 10px; width: 14px; height: 14px; background: #3e2723; border-radius: 50%; box-shadow: inset 0 0 5px #000; }
    .dh-snout::before { left: 15px; } .dh-snout::after { right: 15px; }
    .dh-jaw { position: absolute; bottom: 10px; left: 30px; width: 60px; height: 35px; border-radius: 0 0 25px 25px; z-index: 4; animation: chew 1s ease-in-out infinite alternate; }
    .dh-eye {
      position: absolute; top: 20px; width: 24px; height: 24px;
      background: radial-gradient(circle, #fff 40%, #cfd8dc 100%);
      border-radius: 50%;
      border: 3px solid #3e2723;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.9);
      z-index: 7;
    }
    .eye-left { left: 5px; } .eye-right { right: 5px; }
    .dh-horn { position: absolute; top: -25px; width: 15px; height: 55px; border-radius: 8px; transform-origin: bottom center; z-index: 3; }
    .horn-left { left: 15px; transform: rotate(-25deg); } .horn-right { right: 15px; transform: rotate(25deg); }
    .dh-whisker { position: absolute; top: 60px; width: 70px; height: 50px; border-top: 5px solid #a1887f; border-radius: 50%; z-index: 2; opacity: 0.9; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
    .whisker-left { right: 85px; transform: rotate(20deg); } .whisker-right { left: 85px; transform: rotate(-20deg); }

    /* --- Incense effects --- */
    @keyframes incense-flicker {
      0% { opacity: 0.8; transform: translate(-50%, -50%) scale(0.95); filter: drop-shadow(0 0 1px rgba(255,61,0,0.5)); }
      50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); filter: drop-shadow(0 0 3px rgba(255,200,0,0.8)); }
      100% { opacity: 0.9; transform: translate(-50%, -50%) scale(1.0); filter: drop-shadow(0 0 2px rgba(255,61,0,0.6)); }
    }
    @keyframes smoke-rise {
      0% { opacity: 0; transform: translate(-50%, 0) scale(0.5); }
      50% { opacity: 0.5; }
      100% { opacity: 0; transform: translate(-50%, -80px) scale(2.5); }
    }
    @keyframes float-head { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    @keyframes chew { 0% { transform: translateY(0); } 100% { transform: translateY(5px); } }

    .incense-glow { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
    .incense-particles {
      position: absolute; width: 4px; height: 4px;
      background: radial-gradient(circle, #fff 20%, #ff3d00 100%);
      border-radius: 50%;
      top: 40%; left: 50%;
      box-shadow:
        0 -35px 2px #ff9100, 10px -32px 1px #ff3d00, -10px -32px 2px #ff3d00,
        20px -28px 1px #ff9100, -20px -28px 2px #ff3d00, 30px -20px 1px #ff3d00, -30px -20px 2px #ff9100;
      filter: drop-shadow(0 0 4px #ff3d00);
      animation: incense-flicker 0.12s infinite alternate;
      transform: translate(-50%, -50%);
    }
    .smoke-effect {
      position: absolute; top: -40px; left: 50%; width: 15px; height: 15px;
      background: rgba(220,220,220,0.4); border-radius: 50%;
      box-shadow: 0 0 25px 15px rgba(220,220,220,0.4);
      transform: translateX(-50%);
      animation: smoke-rise 2.5s infinite linear;
      z-index: 1;
    }

    /* --- Dragon body segments --- */
    .dragon-body-segment {
      position: absolute; width: 70px; height: 70px;
      transform: translate(-50%, -50%);
      display: none; z-index: 15;
      will-change: transform, left, top;
      pointer-events: none;
    }
    .segment-core {
      position: absolute; left: 50%; top: 50%;
      width: 22px; height: 22px;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background:
        radial-gradient(circle, rgba(255,255,255,0.25) 0%, rgba(0,0,0,0) 55%),
        radial-gradient(circle, #d4b483 0%, #b08b55 70%, #6d4c41 100%);
      box-shadow: inset 0 0 10px rgba(62,39,35,0.55), 0 0 10px rgba(255,120,0,0.12);
      border: 1px solid rgba(141,110,99,0.7);
    }
    .incense-stick {
      position: absolute; left: 50%; top: 50%;
      width: 3px; height: var(--len, 40px);
      transform-origin: 50% 100%;
      transform: translate(-50%, -100%) rotate(var(--rot, 0deg));
      border-radius: 2px;
      background: linear-gradient(to top, #7a4b2a 0%, #c58a55 50%, #f2d0a6 100%);
      filter: drop-shadow(0 0 1px rgba(0,0,0,0.5));
      opacity: 0.95;
    }
    .incense-stick::after {
      content: '';
      position: absolute; left: 50%; top: -8px;
      width: 6px; height: 6px;
      transform: translateX(-50%);
      border-radius: 50%;
      background: radial-gradient(circle, #fff 10%, #ffeb3b 35%, #ff3d00 100%);
      box-shadow: 0 0 10px rgba(255, 180, 0, 0.9), 0 0 18px rgba(255, 61, 0, 0.65);
      animation: incense-flicker var(--flicker, 0.12s) infinite alternate;
    }
    .segment-glow {
      position: absolute; left: 50%; top: 50%;
      width: 120px; height: 120px;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255, 87, 34, 0.16) 0%, rgba(255, 87, 34, 0.08) 35%, transparent 70%);
      filter: blur(8px);
      pointer-events: none;
      opacity: 0.8;
    }
    .dragon-tail {
      position: absolute; width: 90px; height: 90px;
      transform: translate(-50%, -50%);
      display: none; z-index: 14;
      will-change: transform, left, top;
      pointer-events: none;
    }
    .tail-core {
      position: absolute; left: 50%; top: 55%;
      width: 20px; height: 20px;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: radial-gradient(circle, #caa26f 0%, #8d6e63 70%, #3e2723 100%);
      box-shadow: inset 0 0 10px rgba(62,39,35,0.6);
    }
    .tail-stick {
      position: absolute; left: 50%; top: 55%;
      width: 3px; height: var(--len, 55px);
      transform-origin: 50% 100%;
      transform: translate(-50%, -100%) rotate(var(--rot, 0deg));
      border-radius: 2px;
      background: linear-gradient(to top, #6d3d1f 0%, #c07a3e 60%, #f6d7b8 100%);
      opacity: 0.95;
    }
    .tail-stick::after {
      content: '';
      position: absolute; left: 50%; top: -9px;
      width: 7px; height: 7px;
      transform: translateX(-50%);
      border-radius: 50%;
      background: radial-gradient(circle, #fff 10%, #ffeb3b 35%, #ff3d00 100%);
      box-shadow: 0 0 12px rgba(255, 200, 0, 0.95), 0 0 20px rgba(255, 61, 0, 0.65);
      animation: incense-flicker 0.14s infinite alternate;
    }

    /* Bubbles */
    .floating-item {
      position: absolute;
      font-size: 40px;
      font-weight: 900;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 70px; height: 70px;
      border-radius: 50%;
      background-color: #fff9d1;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
      z-index: 6;
      will-change: transform, left, top;
      user-select: none;
    }
    .good-item { color: #d32f2f; border: 3px solid #d32f2f; }
    .bad-item  { color: #333;   border: 3px solid #555; }

    .score-popup {
      position: absolute;
      font-size: 34px;
      font-weight: 900;
      text-shadow: 1px 1px 0 #fff;
      animation: floatUp 0.8s ease-out forwards;
      z-index: 25;
      pointer-events: none;
    }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-60px); } }

    /* Overlays */
    .overlay-screen {
      position: absolute; inset: 0;
      background: rgba(0,0,0,0.82);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 40;
      pointer-events: auto;
      color: #fff;
      text-align: center;
      padding: 18px;
    }
    .overlay-screen button {
      pointer-events: auto;
      padding: 14px 34px;
      font-size: 20px;
      background: #d32f2f;
      color: #fff;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      margin-top: 16px;
      font-weight: 900;
      box-shadow: 0 0 15px rgba(255,82,82,0.8);
      transition: transform 0.1s;
    }
    .overlay-screen button:active { transform: scale(0.97); }

    #mute-btn {
      position: absolute; bottom: 16px; right: 16px;
      z-index: 50;
      background: rgba(255,255,255,0.5);
      border: none;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 22px;
      cursor: pointer;
      pointer-events: auto;
      user-select: none;
    }
  </style>
</head>

<body>
  <!-- Looping mp4 background -->
  <video id="bg-video" autoplay muted loop playsinline preload="auto">
    <source src="animated.mp4" type="video/mp4" />
  </video>

  <!-- Audio -->
  <audio id="bgm" loop src="bgm.mp3"></audio>
  <audio id="sfx-collect" src="Collect.mp3"></audio>
  <audio id="sfx-crunch" src="Crunch.mp3"></audio>
  <audio id="sfx-end" src="end.mp3"></audio>

  <!-- Webcam -->
  <video id="video" playsinline autoplay muted></video>

  <div id="ui-layer">
    <div id="score-board">ÂàÜÊï∏: <span id="score">0</span></div>
    <div id="timer-board">ÊôÇÈñì: <span id="timer">60</span></div>

    <div id="dragon-body-container"></div>

    <div id="aim-cursor">
      <div class="dragon-head-group">
        <div class="smoke-effect"></div>
        <div class="dh-horn horn-left straw-texture"></div>
        <div class="dh-horn horn-right straw-texture"></div>
        <div class="dh-whisker whisker-left"></div>
        <div class="dh-whisker whisker-right"></div>
        <div class="dh-skull straw-texture"></div>
        <div class="dh-jaw straw-texture"></div>
        <div class="dh-snout straw-texture"></div>
        <div class="dh-eye eye-left"></div>
        <div class="dh-eye eye-right"></div>
        <div class="incense-glow"><div class="incense-particles"></div></div>
      </div>
    </div>

    <div id="game-area"></div>
    <button id="mute-btn" title="Mute/unmute">üîä</button>

    <div id="start-screen" class="overlay-screen">
      <h1 style="color:#ffeb3b; text-shadow: 0 0 10px #ff5722; font-size: 38px; margin:0;">üî• Â§ßÂùëËàûÁÅ´Èæç (Short) üî•</h1>
      <p style="font-size: 16px; color: #ddd; margin: 10px 0 0;">
        Áî®„ÄåÂè≥ÊâãÊâãËÖï„ÄçÊéßÂà∂ÈæçÈ†≠Êî∂ÈõÜÂêâÁ••Â≠óÔºÅ<br>ÈÅøÈñã Emoji Ê≥°Ê≥°„ÄÇ
      </p>
      <button id="startBtn">Ëµ∑ÈæçÔºÅ(Start)</button>
      <div id="err" style="margin-top:10px; display:none;"></div>
    </div>

    <div id="game-over-screen" class="overlay-screen" style="display:none;">
      <h1 style="margin:0 0 10px;">ÊôÇÈñìÂà∞ÔºÅ</h1>
      <p style="margin:0;">ÊúÄÁµÇÂàÜÊï∏: <span id="final-score" style="font-size: 40px; font-weight: 900; color: #ffeb3b;">0</span></p>
      <button id="restartBtn2">ÂÜçËàû‰∏ÄÊ¨°</button>
    </div>
  </div>

  <script type="module">
    import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

    const MODEL_URL = "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task";

    const goodWords = ['Á¶è', 'Êò•', 'Ë≤°', 'ÂÆâ', 'Êó∫', 'Âêâ', 'Á••', 'Ë≥Ä', 'È¶¨', 'Âπ¥'];
    const badWords  = ['‚öΩ', 'üçî', 'üéß', 'üßä', 'üßº', 'üç∫', 'üí°', 'üìé', 'üßΩ', 'üßØ'];

    const GAME_SECONDS = 60;
    const GOOD_POINTS = 10;
    const BAD_POINTS  = -5;

    const START_GOOD = 6;
    const START_BAD  = 4;

    const SMOOTHING = 0.22;

    /* --- REVERTED CONSTANTS FOR FULL SIZE --- */
    const HEAD_R = 60;         // Back to 60
    const ITEM_R = 35;

    /* --- CHANGED: REDUCED SEGMENT COUNT --- */
    const bodySegmentCount = 5; // Reduced from 14 to 5
    
    const bodySpacing = 26;    // Back to 26
    const sticksPerSegment = 28;
    const stickLenMin = 26;    // Back to 26
    const stickLenMax = 46;    // Back to 46

    const video = document.getElementById('video');
    const bgVideo = document.getElementById('bg-video');

    const gameArea = document.getElementById('game-area');
    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const aimCursor = document.getElementById('aim-cursor');
    const dragonBodyContainer = document.getElementById('dragon-body-container');

    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const finalScoreEl = document.getElementById('final-score');
    const startBtn = document.getElementById('startBtn');
    const restartBtn2 = document.getElementById('restartBtn2');
    const errEl = document.getElementById('err');

    const sounds = {
      bgm: document.getElementById('bgm'),
      collect: document.getElementById('sfx-collect'),
      crunch: document.getElementById('sfx-crunch'),
      end: document.getElementById('sfx-end')
    };
    let isMuted = false;
    let isGameRunning = false;

    sounds.bgm.volume = 0.3;
    sounds.collect.volume = 0.85;
    sounds.crunch.volume = 0.85;
    sounds.end.volume = 0.75;

    function playSound(name) {
      if (isMuted) return;
      const a = sounds[name];
      if (!a) return;
      a.currentTime = 0;
      a.play().catch(() => {});
    }
    function setMuted(m) {
      isMuted = m;
      const btn = document.getElementById('mute-btn');
      btn.textContent = isMuted ? 'üîá' : 'üîä';
      if (isMuted) { sounds.bgm.pause(); }
      else { if (isGameRunning) sounds.bgm.play().catch(()=>{}); }
    }
    document.getElementById('mute-btn').addEventListener('click', () => setMuted(!isMuted));

    // Ensure bg video plays
    bgVideo.muted = true;

    // Game vars
    let score = 0;
    let timeLeft = GAME_SECONDS;
    let items = [];
    let timerInterval = null;

    let gameWidth = window.innerWidth;
    let gameHeight = window.innerHeight;

    let cursor = { x: -100, y: -100, visible: false };
    let mirror = true; // webcam is mirrored

    // Dragon body arrays
    const bodySegments = [];
    const bodyPositions = [];

    function buildIncenseSegment(isTail=false) {
      const seg = document.createElement('div');
      seg.classList.add(isTail ? 'dragon-tail' : 'dragon-body-segment');

      if (!isTail) {
        const glow = document.createElement('div');
        glow.className = 'segment-glow';
        seg.appendChild(glow);

        const core = document.createElement('div');
        core.className = 'segment-core';
        seg.appendChild(core);

        for (let i = 0; i < sticksPerSegment; i++) {
          const stick = document.createElement('div');
          stick.className = 'incense-stick';
          const rot = (360 / sticksPerSegment) * i + (Math.random() * 10 - 5);
          const len = stickLenMin + Math.random() * (stickLenMax - stickLenMin);
          const flicker = (0.09 + Math.random() * 0.08).toFixed(2) + 's';
          stick.style.setProperty('--rot', rot + 'deg');
          stick.style.setProperty('--len', len + 'px');
          stick.style.setProperty('--flicker', flicker);
          seg.appendChild(stick);
        }
      } else {
        const core = document.createElement('div');
        core.className = 'tail-core';
        seg.appendChild(core);

        const tailSticks = 36;
        for (let i = 0; i < tailSticks; i++) {
          const stick = document.createElement('div');
          stick.className = 'tail-stick';
          const rot = (360 / tailSticks) * i + (Math.random() * 12 - 6);
          // Reverted tail stick length for full size
          const len = 40 + Math.random() * 28; 
          stick.style.setProperty('--rot', rot + 'deg');
          stick.style.setProperty('--len', len + 'px');
          seg.appendChild(stick);
        }
      }
      return seg;
    }

    function initDragonBody() {
      dragonBodyContainer.innerHTML = '';
      bodySegments.length = 0;
      bodyPositions.length = 0;

      for (let i = 0; i < bodySegmentCount; i++) {
        const el = buildIncenseSegment(false);
        // Reverted scale logic
        const scale = 1 - (i * 0.022);
        el.dataset.baseScale = scale.toFixed(3);
        dragonBodyContainer.appendChild(el);
        bodySegments.push(el);
        bodyPositions.push({ x: -100, y: -100, a: 0 });
      }

      const tail = buildIncenseSegment(true);
      // Reverted tail scale
      tail.dataset.baseScale = '0.72';
      dragonBodyContainer.appendChild(tail);
      bodySegments.push(tail);
      bodyPositions.push({ x: -100, y: -100, a: 0 });
    }

    function updateDragonBody(headX, headY) {
      let targetX = headX;
      let targetY = headY;

      for (let i = 0; i < bodySegments.length; i++) {
        const segment = bodySegments[i];
        const currentPos = bodyPositions[i];

        const dx = targetX - currentPos.x;
        const dy = targetY - currentPos.y;
        const d = Math.sqrt(dx*dx + dy*dy);
        const angle = Math.atan2(dy, dx);

        if (d > bodySpacing) {
          const moveDist = d - bodySpacing;
          currentPos.x += Math.cos(angle) * moveDist * 0.55;
          currentPos.y += Math.sin(angle) * moveDist * 0.55;
        }

        const prevA = currentPos.a || angle;
        let da = angle - prevA;
        if (da > Math.PI) da -= Math.PI * 2;
        if (da < -Math.PI) da += Math.PI * 2;
        currentPos.a = prevA + da * 0.25;

        segment.style.display = 'block';
        segment.style.left = currentPos.x + 'px';
        segment.style.top = currentPos.y + 'px';

        const baseScale = parseFloat(segment.dataset.baseScale || '1');
        const deg = (currentPos.a * 180 / Math.PI) + 90;
        segment.style.transform = `translate(-50%, -50%) rotate(${deg}deg) scale(${baseScale})`;

        targetX = currentPos.x;
        targetY = currentPos.y;
      }
    }

    // MediaPipe
    let handLandmarker = null;
    let lastVideoTime = -1;
    let wristN = { x: 0.5, y: 0.65 };

    async function initCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
    }

    async function initHandLandmarker() {
      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
      );
      handLandmarker = await HandLandmarker.createFromOptions(vision, {
        baseOptions: { modelAssetPath: MODEL_URL },
        runningMode: "VIDEO",
        numHands: 2,
        minHandDetectionConfidence: 0.5,
        minHandPresenceConfidence: 0.5,
        minTrackingConfidence: 0.5
      }); 
    }

    function updateWristFromLandmarks(result) {
      cursor.visible = false;
      if (!result || !result.landmarks || result.landmarks.length === 0) return;

      let idx = 0;
      if (result.handednesses && result.handednesses.length) {
        const rightIndex = result.handednesses.findIndex(h =>
          h && h[0] && String(h[0].categoryName).toLowerCase() === "right"
        );
        if (rightIndex >= 0) idx = rightIndex;
      }

      const lm = result.landmarks[idx];
      if (!lm || !lm[0]) return;

      let x = lm[0].x;
      let y = lm[0].y;
      if (mirror) x = 1 - x;

      wristN.x = wristN.x + (x - wristN.x) * SMOOTHING;
      wristN.y = wristN.y + (y - wristN.y) * SMOOTHING;

      cursor.x = wristN.x * gameWidth;
      cursor.y = wristN.y * gameHeight;
      cursor.visible = true;
    }

    function spawnItems(count, type) {
      for (let i = 0; i < count; i++) {
        const el = document.createElement('div');
        el.classList.add('floating-item', type === 'good' ? 'good-item' : 'bad-item');

        el.textContent = type === 'good'
          ? goodWords[Math.floor(Math.random() * goodWords.length)]
          : badWords[Math.floor(Math.random() * badWords.length)];

        el.dataset.kind = type;
        el.dataset.points = String(type === 'good' ? GOOD_POINTS : BAD_POINTS);

        gameArea.appendChild(el);

        const size = 70;
        items.push({
          element: el,
          x: Math.random() * (gameWidth - size),
          y: Math.random() * (gameHeight - size),
          vx: (Math.random() - 0.5) * 2.8,
          vy: (Math.random() - 0.5) * 2.8,
          width: size, height: size,
          active: true
        });
      }
    }

    function handleHit(item) {
      const pts = parseInt(item.element.dataset.points, 10);
      score += pts;
      scoreEl.textContent = String(score);

      if (pts > 0) playSound('collect');
      else playSound('crunch');

      const popup = document.createElement('div');
      popup.classList.add('score-popup');
      popup.textContent = pts > 0 ? `+${pts}` : String(pts);
      popup.style.color = pts > 0 ? '#2e7d32' : '#d32f2f';
      popup.style.left = item.x + 'px';
      popup.style.top = item.y + 'px';
      gameArea.appendChild(popup);
      setTimeout(() => popup.remove(), 800);

      item.active = false;
      item.element.style.opacity = '0';

      setTimeout(() => {
        if (!isGameRunning) return;
        item.active = true;
        item.element.style.opacity = '1';
        item.x = Math.random() * (gameWidth - item.width);
        item.y = Math.random() * (gameHeight - item.height);

        const kind = item.element.dataset.kind;
        item.element.textContent = kind === 'good'
          ? goodWords[Math.floor(Math.random() * goodWords.length)]
          : badWords[Math.floor(Math.random() * badWords.length)];
      }, 450);
    }

    function loop() {
      if (!isGameRunning) return;

      if (video.readyState >= 2 && handLandmarker) {
        if (video.currentTime !== lastVideoTime) {
          const res = handLandmarker.detectForVideo(video, performance.now());
          updateWristFromLandmarks(res);
          lastVideoTime = video.currentTime;
        }
      }

      if (cursor.visible) {
        aimCursor.style.display = 'flex';
        aimCursor.style.left = cursor.x + 'px';
        aimCursor.style.top = cursor.y + 'px';
        updateDragonBody(cursor.x, cursor.y);
      } else {
        aimCursor.style.display = 'none';
        bodySegments.forEach(seg => seg.style.display = 'none');
      }

      for (const item of items) {
        if (!item.active) continue;

        item.x += item.vx;
        item.y += item.vy;

        if (item.x <= 0 || item.x >= gameWidth - item.width) item.vx *= -1;
        if (item.y <= 0 || item.y >= gameHeight - item.height) item.vy *= -1;

        item.x = Math.max(0, Math.min(item.x, gameWidth - item.width));
        item.y = Math.max(0, Math.min(item.y, gameHeight - item.height));

        item.element.style.left = item.x + 'px';
        item.element.style.top = item.y + 'px';

        if (cursor.visible) {
          const cx = item.x + item.width / 2;
          const cy = item.y + item.height / 2;
          const dx = cursor.x - cx;
          const dy = cursor.y - cy;
          if ((dx*dx + dy*dy) < (HEAD_R + ITEM_R) ** 2) handleHit(item);
        }
      }

      requestAnimationFrame(loop);
    }

    function startGame() {
      errEl.style.display = 'none';

      bgVideo.play().catch(()=>{});

      score = 0;
      timeLeft = GAME_SECONDS;
      scoreEl.textContent = '0';
      timerEl.textContent = String(GAME_SECONDS);

      gameArea.innerHTML = '';
      items = [];
      isGameRunning = true;

      initDragonBody();
      spawnItems(6, 'good');
      spawnItems(4, 'bad');

      startScreen.style.display = 'none';
      gameOverScreen.style.display = 'none';

      if (!isMuted) sounds.bgm.play().catch(() => {});

      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft -= 1;
        timerEl.textContent = String(timeLeft);
        if (timeLeft <= 0) endGame();
      }, 1000);

      loop();
    }

    function endGame() {
      isGameRunning = false;
      clearInterval(timerInterval);
      timerInterval = null;

      sounds.bgm.pause();
      sounds.bgm.currentTime = 0;
      playSound('end');

      finalScoreEl.textContent = String(score);
      gameOverScreen.style.display = 'flex';
    }

    window.addEventListener('resize', () => {
      gameWidth = window.innerWidth;
      gameHeight = window.innerHeight;
    });

    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      try {
        await initCamera();
        await initHandLandmarker();
        startGame();
      } catch (e) {
        errEl.style.display = 'block';
        errEl.textContent = String(e && e.message ? e.message : e);
      } finally {
        startBtn.disabled = false;
      }
    });

    restartBtn2.addEventListener('click', () => startGame());
  </script>
</body>
</html>
