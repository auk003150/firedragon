<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Hiro Marker AR Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <!-- AR.js for A-Frame -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
  
  <style>
    html, body { margin: 0; padding: 0; overflow: hidden; }
    body { font-family: system-ui, -apple-system, "Helvetica Neue", Arial, sans-serif; }
    
    /* UI Overlay */
    .overlay {
      position: fixed;
      top: 0; left: 0; right: 0;
      display: flex; justify-content: space-between; align-items: flex-start;
      padding: 12px 16px;
      background: linear-gradient(180deg, rgba(0,0,0,0.65), rgba(0,0,0,0));
      color: #fff; z-index: 10; pointer-events: none;
      font-size: 14px;
    }
    
    .score-board {
      background: rgba(255, 193, 7, 0.9);
      color: #000;
      padding: 8px 16px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      border: 2px solid #fff;
    }

    .hint {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      padding: 10px 14px;
      background: linear-gradient(0deg, rgba(0,0,0,0.8), rgba(0,0,0,0));
      color: #fff; z-index: 10; text-align: center;
      font-size: 13px; pointer-events: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
    
    .badge {
      background: rgba(255,255,255,0.12);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      pointer-events: auto;
      margin-bottom: 5px;
      display: inline-block;
    }
    
    .link {
      color: #9ad6ff; text-decoration: underline; pointer-events: auto;
    }

    /* ç¢°æ’æ™‚çš„æµ®å‹•åˆ†æ•¸å‹•ç•« */
    .float-score {
      position: absolute;
      font-weight: bold;
      font-size: 24px;
      animation: fadeUp 1s forwards;
      pointer-events: none;
      z-index: 20;
    }
    
    @keyframes fadeUp {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
    }

    @media (max-width: 640px) {
      .overlay { font-size: 13px; padding: 10px 12px; }
      .hint { font-size: 12px; padding: 8px 12px; }
    }
  </style>

  <script>
    // éŠæˆ²æ•¸æ“š
    const GOOD_WORDS = ['ç¦', 'æ˜¥', 'è²¡', 'å®‰', 'æ—º', 'å‰', 'ç¥¥', 'è³€', 'é¾', 'å¹´'];
    const BAD_WORDS = ['âš½', 'ğŸ”', 'ğŸ§', 'ğŸ§Š', 'ğŸ§¼', 'ğŸº', 'ğŸ’¡', 'ğŸ“', 'ğŸ§½', 'ğŸ§¯'];
    
    let score = 0;
    let markerVisible = false;

    // è¨»å†Šä¸€å€‹çµ„ä»¶ä¾†è™•ç†éŠæˆ²é‚è¼¯
    AFRAME.registerComponent('game-logic', {
      init: function () {
        this.marker = document.querySelector('#hiro-marker');
        this.scene = document.querySelector('a-scene');
        
        // ç›£è½ Marker ç‹€æ…‹
        this.marker.addEventListener('markerFound', () => {
          markerVisible = true;
          document.getElementById('status-text').innerText = "éŠæˆ²é€²è¡Œä¸­ï¼ç§»å‹•æ¨™è¨˜å»æ’æ“Šæ–‡å­—";
          document.getElementById('status-text').style.color = "#4caf50";
        });
        this.marker.addEventListener('markerLost', () => {
          markerVisible = false;
          document.getElementById('status-text').innerText = "å°‹æ‰¾ Hiro æ¨™è¨˜ä¸­...";
          document.getElementById('status-text').style.color = "#ff9800";
        });

        // å®šæ™‚ç”Ÿæˆç‰©é«” (æ¯ 1.2 ç§’)
        setInterval(() => {
          if (document.hidden) return; 
          this.spawnItem();
        }, 1200);
      },

      tick: function () {
        if (!markerVisible) return;

        const playerObj = document.querySelector('#player-box');
        const playerPos = new THREE.Vector3();
        playerObj.object3D.getWorldPosition(playerPos);

        const items = document.querySelectorAll('.floating-item');
        items.forEach(item => {
          if (item.getAttribute('data-hit') === 'true') return; 

          const itemPos = new THREE.Vector3();
          item.object3D.getWorldPosition(itemPos);

          const distance = playerPos.distanceTo(itemPos);

          // ç¢°æ’è·é›¢é–¾å€¼
          if (distance < 0.7) {
            this.handleCollision(item);
          }
        });
      },

      spawnItem: function () {
        const isGood = Math.random() > 0.4;
        const textSet = isGood ? GOOD_WORDS : BAD_WORDS;
        const text = textSet[Math.floor(Math.random() * textSet.length)];
        const color = isGood ? '#FFD700' : '#FF5252';

        const el = document.createElement('a-entity');
        el.setAttribute('class', 'floating-item');
        el.setAttribute('data-type', isGood ? 'good' : 'bad');
        el.setAttribute('data-hit', 'false');

        // --- ä½ç½®èˆ‡ç§»å‹•é‚è¼¯ä¿®æ”¹ ---
        
        // 1. è¨­å®šåˆå§‹ä½ç½®
        // X: å·¦å³ç¯„åœ (-3 åˆ° 3)
        // Y: ä¸Šä¸‹ç¯„åœ (-1 åˆ° 3)
        // Z: æ·±åº¦å›ºå®šåœ¨ -2 åˆ° -4 ä¹‹é–“ (é€™æ¨£å¤§å°çœ‹èµ·ä¾†æ¯”è¼ƒä¸€è‡´ï¼Œä¸”åœ¨æ‰‹è‡‚å¯åŠç¯„åœå…§)
        const startX = (Math.random() - 0.5) * 6;
        const startY = (Math.random() - 0.5) * 4 + 1; 
        const fixedZ = - (Math.random() * 2 + 2); // Z è»¸å›ºå®šï¼Œä¸åƒèˆ‡å‹•ç•«è®ŠåŒ–

        el.setAttribute('position', `${startX} ${startY} ${fixedZ}`);

        // 2. è¨­å®šæ¼‚æµ®ç›®æ¨™ä½ç½® (ä¸Šä¸‹å·¦å³éš¨æ©Ÿç§»å‹•)
        // æˆ‘å€‘è®“å®ƒåœ¨åˆå§‹ä½ç½®çš„åŸºç¤ä¸Šï¼Œéš¨æ©Ÿåç§»ä¸€é»é»
        const moveX = (Math.random() - 0.5) * 3; // å·¦å³æ¼‚ç§»å¹…åº¦
        const moveY = (Math.random() - 0.5) * 3; // ä¸Šä¸‹æ¼‚ç§»å¹…åº¦

        // 3. è¨­å®šå‹•ç•«
        // property: position
        // to: æ–°çš„ X, Y, ä½† Z ä¿æŒä¸è®Š (é€™æ¨£è¦–è¦ºå°ºå¯¸å°±ä¸æœƒè®Š)
        // dir: alternate (ä¾†å›ç§»å‹•ï¼Œåƒåœ¨æ¼‚æµ®)
        // loop: true (å¾ªç’°)
        // easing: easeInOutSine (å¹³æ»‘çš„æ­£å¼¦æ³¢ç§»å‹•)
        el.setAttribute('animation', `
          property: position; 
          to: ${startX + moveX} ${startY + moveY} ${fixedZ}; 
          dur: ${3000 + Math.random() * 2000}; 
          easing: easeInOutSine; 
          loop: true; 
          dir: alternate
        `);
        
        // ç¹ªè£½æ–‡å­—
        el.setAttribute('canvas-text', `text: ${text}; color: ${color}`);
        
        // 12ç§’å¾Œè‡ªå‹•æ¶ˆå¤±ï¼Œé¿å…å ´æ™¯ç‰©ä»¶éå¤š
        setTimeout(() => {
          if (el.parentNode) el.parentNode.removeChild(el);
        }, 12000);

        // å§‹çµ‚é¢å‘ç›¸æ©Ÿ
        el.setAttribute('look-at', '[camera]');

        this.scene.appendChild(el);
      },

      handleCollision: function (item) {
        item.setAttribute('data-hit', 'true');
        const type = item.getAttribute('data-type');
        
        let points = 0;
        if (type === 'good') {
          points = 15;
          score += 15;
          // åƒåˆ°æ™‚è®Šå¤§æ¶ˆå¤± (åƒ…ä½œç‚ºåé¥‹å‹•ç•«)
          item.setAttribute('animation__hit', 'property: scale; to: 2 2 2; dur: 200; easing: easeOutQuad');
          item.setAttribute('animation__fade', 'property: opacity; to: 0; dur: 200; easing: easeOutQuad');
        } else {
          points = -5;
          score -= 5;
          // æ‰£åˆ†æ™‚ç¸®å°æ¶ˆå¤±
          item.setAttribute('animation__hit', 'property: scale; to: 0.1 0.1 0.1; dur: 200; easing: easeInQuad');
        }

        document.getElementById('score-val').innerText = score;
        this.showFloatingScore(points);

        setTimeout(() => {
          if (item.parentNode) item.parentNode.removeChild(item);
        }, 200);
      },

      showFloatingScore: function(points) {
        const div = document.createElement('div');
        div.className = 'float-score';
        div.innerText = points > 0 ? `+${points}` : points;
        div.style.color = points > 0 ? '#4caf50' : '#f44336';
        div.style.left = '50%';
        div.style.top = '50%';
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1000);
      }
    });

    // æ–‡å­—è²¼åœ–çµ„ä»¶
    AFRAME.registerComponent('canvas-text', {
      schema: {
        text: {type: 'string', default: ''},
        color: {type: 'string', default: '#FFF'},
        width: {type: 'number', default: 256},
        height: {type: 'number', default: 256}
      },
      init: function () {
        this.canvas = document.createElement('canvas');
        this.canvas.width = this.data.width;
        this.canvas.height = this.data.height;
        this.ctx = this.canvas.getContext('2d');
        this.draw();
        
        const texture = new THREE.CanvasTexture(this.canvas);
        const material = new THREE.MeshBasicMaterial({
          map: texture,
          transparent: true,
          side: THREE.DoubleSide
        });
        const geometry = new THREE.PlaneGeometry(1, 1);
        this.mesh = new THREE.Mesh(geometry, material);
        this.el.setObject3D('mesh', this.mesh);
      },
      draw: function() {
        const ctx = this.ctx;
        const w = this.canvas.width;
        const h = this.canvas.height;
        ctx.clearRect(0, 0, w, h);
        
        ctx.beginPath();
        ctx.arc(w/2, h/2, w/2 - 10, 0, 2 * Math.PI);
        ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        ctx.fill();
        ctx.strokeStyle = this.data.color;
        ctx.lineWidth = 10;
        ctx.stroke();

        ctx.font = 'bold 140px "Microsoft JhengHei", Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = this.data.color;
        ctx.fillText(this.data.text, w/2, h/2 + 15);
      }
    });

    // é¢å‘ç›¸æ©Ÿçµ„ä»¶
    AFRAME.registerComponent('look-at', {
      schema: { type: 'selector' },
      tick: function () {
        if (this.data) {
          this.el.object3D.lookAt(this.data.object3D.position);
        }
      }
    });
  </script>
</head>
<body>
  <div class="overlay">
    <div>
      <div class="badge">Hiro Marker éŠæˆ²</div>
      <div id="status-text" style="font-size: 12px; color: #ff9800;">å°‹æ‰¾ Hiro æ¨™è¨˜ä¸­...</div>
    </div>
    <div class="score-board">
      åˆ†æ•¸: <span id="score-val">0</span>
    </div>
  </div>
  
  <div class="hint">
    ç§»å‹• Hiro æ¨™è¨˜å»æ’æ“Šæ¼‚æµ®çš„å­—ï¼<br/>
    <span style="color:#FFD700">å‰åˆ©å­— +15åˆ†</span> | <span style="color:#FF5252">é›œç‰© -5åˆ†</span><br/>
    <a class="link" href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/aframe/examples/marker-training/examples/pattern-files/pattern-hiro.png" target="_blank">ä¸‹è¼‰ Hiro åœ–</a>
  </div>

  <a-scene
    game-logic
    vr-mode-ui="enabled: false"
    embedded
    renderer="logarithmicDepthBuffer: true; antialias: true;"
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono; maxDetectionRate: 30;"
  >
    <a-entity light="type: ambient; color: #ffffff; intensity: 0.7"></a-entity>
    <a-entity light="type: directional; color: #ffffff; intensity: 0.8" position="-1 1 0"></a-entity>

    <!-- Hiro æ¨™è¨˜ (ç©å®¶) -->
    <a-marker id="hiro-marker" preset="hiro">
      <a-box id="player-box" 
             position="0 0.5 0" 
             depth="0.8" height="0.8" width="0.8"
             material="color: #4FC3F7; opacity: 0.5; transparent: true"
             animation="property: rotation; to: 0 360 0; loop: true; dur: 3000; easing: linear">
      </a-box>
      <a-sphere position="0 0.5 0" radius="0.2" color="#fff"></a-sphere>
    </a-marker>

    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>
