<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>å¤§å‘èˆç«é¾ AR å°éŠæˆ²ï¼ˆè²¼åœ–ç‰ˆï¼‰</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: #000; color: #fff; overflow: hidden;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans HK","PingFang HK",Arial,sans-serif;
    }
    .wrap { position: relative; width: 100%; height: 100%; }
    video#cam, img#bg, canvas#game {
      position: absolute; inset: 0; width: 100%; height: 100%;
      object-fit: cover;
    }
    video#cam { transform: scaleX(-1); }
    img#bg { pointer-events: none; opacity: .2; mix-blend-mode: lighten; }
    canvas#game { pointer-events: none; }
    .ui {
      position: absolute; left: 0; right: 0; top: 0;
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 12px; gap: 8px;
      background: linear-gradient(180deg, rgba(0,0,0,.5), rgba(0,0,0,0));
    }
    .btn {
      background: #e11d48; color: #fff; border: 0; border-radius: 10px;
      padding: 10px 14px; font-weight: 700; box-shadow: 0 4px 12px rgba(225,29,72,.35);
    }
    .hud { display: flex; gap: 10px; align-items: center; font-weight: 700; text-shadow: 0 2px 6px rgba(0,0,0,.6);}
    .chip { background: rgba(0,0,0,.45); border: 1px solid rgba(255,255,255,.2); border-radius: 999px; padding: 6px 10px; font-size: 14px;}
    .bar {
      position: absolute; left: 12px; right: 12px; bottom: 12px;
      display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
      background: rgba(0,0,0,.35); border: 1px solid rgba(255,255,255,.1);
      border-radius: 12px; padding: 10px;
    }
    .range-group { display: flex; align-items: center; gap: 8px; color: #ddd; font-size: 12px; }
    input[type="range"] { width: 120px; }
    .hint {
      position: absolute; left: 0; right: 0; top: 50%; transform: translateY(-50%);
      text-align: center; padding: 0 16px; color: #ffd166; font-weight: 700;
      text-shadow: 0 2px 10px rgba(0,0,0,.7);
    }
    .ok { color: #22c55e; }
    .bad { color: #f97316; }
  </style>
</head>
<body>
  <div class="wrap">
    <video id="cam" playsinline muted autoplay></video>
    <img id="bg" alt="å¤§å‘èˆç«é¾èƒŒæ™¯" src="" />
    <canvas id="game"></canvas>

    <div class="ui">
      <button id="startBtn" class="btn">é–‹å§‹</button>
      <div class="hud">
        <div class="chip">åˆ†æ•¸ï¼š<span id="score">0</span></div>
        <div class="chip">Comboï¼š<span id="combo">0</span></div>
        <div class="chip">æ™‚é–“ï¼š<span id="time">60</span>s</div>
      </div>
      <button id="resetBtn" class="btn" style="background:#334155">é‡ç½®</button>
    </div>

    <div class="bar">
      <div class="range-group">
        Hmin <input id="hMin" type="range" min="0" max="360" value="330">
        Hmax <input id="hMax" type="range" min="0" max="360" value="20">
      </div>
      <div class="range-group">
        Smin <input id="sMin" type="range" min="0" max="100" value="50">
        Vmin <input id="vMin" type="range" min="0" max="100" value="40">
      </div>
      <div class="range-group">
        éˆæ•åº¦ <input id="sens" type="range" min="0" max="100" value="60">
      </div>
      <div class="range-group">
        ç›®æ¨™å¯†åº¦ <input id="density" type="range" min="1" max="10" value="4">
      </div>
      <div class="range-group">
        é€Ÿåº¦ <input id="speed" type="range" min="1" max="10" value="5">
      </div>
    </div>

    <div id="hint" class="hint">æŒ‰ã€Œé–‹å§‹ã€å…è¨±ç›¸æ©Ÿæ¬Šé™ã€‚è«‹ä»¥ç´…è‰²é¾å…¬ä»”åœ¨é¡é ­å‰æ®å‹•ã€‚</div>
  </div>

  <script>
    // åŸºæœ¬å¼•ç”¨
    const video = document.getElementById('cam');
    const bgImg = document.getElementById('bg');
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d', { alpha: true });

    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const scoreEl = document.getElementById('score');
    const comboEl = document.getElementById('combo');
    const timeEl = document.getElementById('time');
    const hintEl = document.getElementById('hint');

    const hMinEl = document.getElementById('hMin');
    const hMaxEl = document.getElementById('hMax');
    const sMinEl = document.getElementById('sMin');
    const vMinEl = document.getElementById('vMin');
    const sensEl = document.getElementById('sens');
    const densEl = document.getElementById('density');
    const speedEl = document.getElementById('speed');

    let running = false, gameOver = false;
    let W = 0, H = 0;
    let score = 0, combo = 0, timeLeft = 60, timerId = null;

    // è¿½è¹¤ç‹€æ…‹
    let centroid = { x: 0, y: 0 };
    let lastCentroid = { x: 0, y: 0 };
    let direction = { x: 1, y: 0 };
    let smoothing = 0.25;

    // ç›®æ¨™
    const goodList = ['ç¦','æ˜¥','è²¡','å®‰','æ—º','å‰','ç¥¥','è³€','é¾','å¹´'];
    const badList  = ['âš½','ğŸ”','ğŸ§','ğŸ§Š','ğŸ§¼','ğŸº','ğŸ’¡','ğŸ“','ğŸ§½','ğŸ§¯'];
    const items = [];
    const MAX_ITEMS = 12;

    // å°ºå¯¸
    function resize() {
      const dpr = Math.min(window.devicePixelRatio || 1.5, 2);
      W = canvas.clientWidth;
      H = canvas.clientHeight;
      canvas.width = Math.round(W * dpr);
      canvas.height = Math.round(H * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    window.addEventListener('resize', resize);
    resize();

    // ç›¸æ©Ÿ
    async function initCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: false,
        video: { facingMode: { ideal: 'environment' }, width: { ideal: 1280 }, height: { ideal: 720 } }
      });
      video.srcObject = stream;
      await video.play();
    }

    // é¡è‰²è¿½è¹¤ï¼ˆç°¡åŒ– HSVï¼‰
    const workCanvas = document.createElement('canvas');
    const wctx = workCanvas.getContext('2d', { willReadFrequently: true });
    function rgb2hsv(r,g,b){
      r/=255; g/=255; b/=255;
      const max=Math.max(r,g,b), min=Math.min(r,g,b), d=max-min;
      let h=0;
      if(d!==0){ if(max===r) h=((g-b)/d)%6; else if(max===g) h=(b-r)/d+2; else h=(r-g)/d+4; h*=60; if(h<0) h+=360; }
      const s=max===0?0:d/max, v=max;
      return [h, s*100, v*100];
    }
    function inHueRange(h, hMin, hMax){
      return (hMin<=hMax) ? (h>=hMin && h<=hMax) : (h>=hMin || h<=hMax);
    }
    function trackRedCentroid(){
      const scale=0.3;
      const w=Math.max(2, Math.round(video.videoWidth*scale));
      const h=Math.max(2, Math.round(video.videoHeight*scale));
      workCanvas.width=w; workCanvas.height=h;
      wctx.drawImage(video,0,0,w,h);
      const {data}=wctx.getImageData(0,0,w,h);

      const hMin=+hMinEl.value, hMax=+hMaxEl.value, sMin=+sMinEl.value, vMin=+vMinEl.value, sens=+sensEl.value;
      let sumX=0,sumY=0,count=0;
      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          const i=(y*w+x)*4;
          const [hh,ss,vv]=rgb2hsv(data[i],data[i+1],data[i+2]);
          if(inHueRange(hh,hMin,hMax) && ss>=sMin && vv>=vMin){ sumX+=x; sumY+=y; count++; }
        }
      }
      if(count<sens) return null;
      const cx=(sumX/count)/w*W, cy=(sumY/count)/h*H;
      return { x: cx, y: cy, count };
    }

    // éŠæˆ²ç‰©ä»¶
    function spawnItem(){
      const isGood = Math.random()<0.6;
      const text = isGood ? goodList[Math.floor(Math.random()*goodList.length)]
                          : badList[Math.floor(Math.random()*badList.length)];
      const size = 28 + Math.random()*18;
      const x = 30 + Math.random()*(W-60);
      const y = 80 + Math.random()*(H-160);
      const vx = (Math.random()-0.5) * +speedEl.value;
      const vy = (Math.random()-0.5) * +speedEl.value;
      const ttl = 12 + Math.random()*10;
      items.push({ x,y,vx,vy,text,size,isGood,ttl });
    }
    function ensureItems(){
      const target = +densEl.value * 3;
      while(items.length < Math.min(MAX_ITEMS, target)) spawnItem();
    }
    function updateItems(dt){
      for(let i=items.length-1;i>=0;i--){
        const it=items[i];
        it.x+=it.vx; it.y+=it.vy; it.ttl-=dt;
        if(it.x<20||it.x>W-20) it.vx*=-1;
        if(it.y<60||it.y>H-60) it.vy*=-1;
        if(it.ttl<=0) items.splice(i,1);
      }
      ensureItems();
    }
    function drawItems(ctx){
      for(const it of items){
        ctx.save();
        ctx.font = `700 ${it.size}px system-ui, "Noto Color Emoji", "Apple Color Emoji"`;
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.shadowColor = it.isGood ? 'rgba(255,215,0,.9)' : 'rgba(255,90,0,.7)';
        ctx.shadowBlur = 12;
        ctx.fillStyle = it.isGood ? '#ffd166' : '#ff6b6b';
        ctx.fillText(it.text, it.x, it.y);
        ctx.restore();
      }
    }

    // ========== ä½¿ç”¨ç«é¾ PNG è²¼åœ– ==========
    const imgDragon = new Image();
    // å°‡è·¯å¾‘æ›æˆä½ çš„å¯¦éš›æª”æ¡ˆæˆ– URLï¼š
    imgDragon.src = 'dragon.png'; // ä¾‹ï¼šåŒè³‡æ–™å¤¾ä¸­çš„æª”å
    let dragonReady = false;
    imgDragon.onload = () => { dragonReady = true; };

    // å°é½Šè¨­å®šï¼šæŠŠè²¼åœ–ä¸Šçš„ã€Œé¾é ­å£é¼»ã€ç•¶æˆè·Ÿéš¨ä½ç½®
    // ä»¥ä½ çš„ 500x500 åœ–ç‚ºä¾‹ï¼Œå£é¼»åå³ä¸Šï¼›ä»¥ä¸‹æ˜¯ä¼°ç®—åç§»æ¯”ä¾‹ï¼Œå¯å¾®èª¿ï¼š
    const headAlign = {
      // å°‡åœ–åƒä¸­å¿ƒè¦–ç‚º (0,0)ï¼Œè²¼åœ–æ¸²æŸ“æ™‚ä»¥ä¸­å¿ƒå°é½Šï¼Œå†åŠ ä¸Šåç§»æŠŠã€Œå£é¼»ã€å°åˆ°ä¸­å¿ƒ
      // æ­£å€¼å‘å³/å‘ä¸‹ï¼›å–®ä½ï¼šåƒç´ ï¼Œå°‡åœ¨ç¹ªè£½æ™‚è¨ˆå…¥ç¸®æ”¾
      headOffsetX: 80,  // å¾åœ–ä¸­å¿ƒå¾€å³åç§»
      headOffsetY: -40  // å¾åœ–ä¸­å¿ƒå¾€ä¸Šåç§»
    };
    // ç¸®æ”¾ï¼šåŸºæ–¼ç•«é¢é«˜åº¦èª¿æ•´è²¼åœ–å¤§å°
    function getDragonScale() {
      // è®“é¾å¤§æ¦‚ä½”è¢å¹•é«˜åº¦çš„ 28%
      const targetH = H * 0.28;
      const s = (imgDragon.height > 0) ? targetH / imgDragon.height : 0.5;
      return s;
    }

    function drawDragonImage(ctx, head, dir) {
      if(!dragonReady) return;
      const angle = Math.atan2(dir.y, dir.x);
      const s = getDragonScale();
      const w = imgDragon.width * s;
      const h = imgDragon.height * s;

      // è¨ˆç®—æŠŠã€Œå£é¼»ã€å°åˆ° head çš„ä½ç§»ï¼ˆå…ˆä»¥åœ–ä¸­å¿ƒå°é½Šï¼Œå†æ ¡æ­£åç§»ï¼‰
      const ox = headAlign.headOffsetX * s;
      const oy = headAlign.headOffsetY * s;

      ctx.save();
      // åœ¨ head ä½ç½®ï¼Œå°‡è²¼åœ–æ—‹è½‰ï¼Œä½¿ã€Œå£é¼»ã€æœå‘ dir
      ctx.translate(head.x, head.y);
      ctx.rotate(angle);
      // å…ˆæŠŠè²¼åœ–ä¸­å¿ƒç§»åˆ° (0,0)
      // å†æŠŠ headOffset åå‘ç§»å›ï¼Œä½¿å£é¼»è½åœ¨ (0,0)
      ctx.drawImage(imgDragon, -w/2 - ox, -h/2 - oy, w, h);
      ctx.restore();

      // å¯é¸ï¼šåœ¨é¾é ­å‰æ–¹åŠ ä¸€é»ç«å…‰
      ctx.save();
      const flareR = 40;
      const px = head.x + dir.x * 8, py = head.y + dir.y * 8;
      const grad = ctx.createRadialGradient(px, py, 6, px, py, flareR);
      grad.addColorStop(0, 'rgba(255,220,120,0.9)');
      grad.addColorStop(0.6, 'rgba(255,120,0,0.3)');
      grad.addColorStop(1, 'rgba(255,0,0,0.04)');
      ctx.fillStyle = grad;
      ctx.beginPath(); ctx.arc(px, py, flareR, 0, Math.PI*2); ctx.fill();
      ctx.restore();
    }

    // ç¢°æ’èˆ‡å¾—åˆ†
    function circleHit(ax, ay, bx, by, r){ const dx=ax-bx, dy=ay-by; return dx*dx+dy*dy<=r*r; }
    function handleCollisions(head){
      for(let i=items.length-1;i>=0;i--){
        const it=items[i];
        if(circleHit(head.x, head.y, it.x, it.y, 28)){
          if(it.isGood){
            combo++;
            const bonus = 10 + Math.min(50, combo*2);
            score += bonus; flash('+'+bonus, it.x, it.y, true);
          } else {
            combo=0; score -= 15; flash('âˆ’15', it.x, it.y, false);
          }
          items.splice(i,1);
          scoreEl.textContent=score; comboEl.textContent=combo;
        }
      }
    }
    const floatTexts=[];
    function flash(text,x,y,ok){ floatTexts.push({text,x,y,ok,t:0}); }
    function drawFloatTexts(dt){
      for(let i=floatTexts.length-1;i>=0;i--){
        const f=floatTexts[i];
        f.t+=dt;
        const a=Math.max(0,1-f.t/1.2);
        const dy=-f.t*40;
        ctx.save();
        ctx.globalAlpha=a;
        ctx.font='800 22px system-ui';
        ctx.textAlign='center'; ctx.textBaseline='middle';
        ctx.fillStyle=f.ok?'#22c55e':'#f97316';
        ctx.fillText(f.text,f.x,f.y+dy);
        ctx.restore();
        if(a<=0.01) floatTexts.splice(i,1);
      }
    }

    // è¿´åœˆ
    let lastTime = performance.now();
    function tick(now){
      const dt=Math.min(0.033,(now-lastTime)/1000); lastTime=now;
      ctx.clearRect(0,0,W,H);

      const c=trackRedCentroid();
      if(c){
        lastCentroid.x = centroid.x || c.x;
        lastCentroid.y = centroid.y || c.y;
        centroid.x = centroid.x + (c.x-centroid.x)*smoothing || c.x;
        centroid.y = centroid.y + (c.y-centroid.y)*smoothing || c.y;

        const dx=centroid.x-lastCentroid.x, dy=centroid.y-lastCentroid.y;
        const len=Math.hypot(dx,dy)||1;
        direction.x=dx/len; direction.y=dy/len;
        hintEl.textContent='å·²åµæ¸¬åˆ°ç´…è‰²ç›®æ¨™ï¼Œç›¡æƒ…èˆå‹•ï¼'; hintEl.className='hint ok';
      }else{
        hintEl.textContent='æœªåµæ¸¬åˆ°ç´…è‰²ç‰©ä»¶ï¼Œè«‹èª¿æ•´å…‰ç·š/è‰²åŸŸæˆ–é è¿‘é¡é ­ã€‚'; hintEl.className='hint bad';
      }

      updateItems(dt);
      drawItems(ctx);

      // ç«é¾é ­ä½ç½®ï¼ˆç”¨è²¼åœ–çš„å£é¼»ä½œç‚ºé ­ï¼‰
      const head = { x: centroid.x || W/2, y: centroid.y || H/2 };
      drawDragonImage(ctx, head, direction);

      handleCollisions(head);
      drawFloatTexts(dt);

      if(running && !gameOver) requestAnimationFrame(tick);
    }

    // æ§åˆ¶
    function startGameLoop(){
      if(running) return;
      running=true; gameOver=false;
      ensureItems();
      clearInterval(timerId);
      timeLeft=60; timeEl.textContent=timeLeft;
      timerId=setInterval(()=>{
        timeLeft--; timeEl.textContent=timeLeft;
        if(timeLeft<=0){
          clearInterval(timerId); running=false; gameOver=true;
          hintEl.textContent=`æ™‚é–“åˆ°ï¼ç¸½åˆ†ï¼š${score}`; hintEl.className='hint';
        }
      },1000);
      lastTime=performance.now();
      requestAnimationFrame(tick);
    }
    async function startAll(){
      try{
        await initCamera();
        // å¦‚éœ€èƒŒæ™¯åœ–ï¼Œè¨­å®š bgImg.src = 'your-parade.jpg';
        startGameLoop();
      }catch(e){
        console.error(e);
        hintEl.textContent='ç›¸æ©Ÿç„¡æ³•å•Ÿå‹•ï¼Œè«‹ç¢ºèªæ¬Šé™èˆ‡ HTTPSã€‚';
      }
    }
    startBtn.addEventListener('click', startAll);
    resetBtn.addEventListener('click', ()=>{
      score=0; combo=0; scoreEl.textContent=score; comboEl.textContent=combo;
      items.length=0; ensureItems();
      centroid={x:W/2,y:H/2}; lastCentroid={x:W/2-10,y:H/2}; direction={x:1,y:0};
      hintEl.textContent='é‡ç½®å®Œæˆï¼ŒæŒ‰ã€Œé–‹å§‹ã€é‡æ–°å•Ÿå‹•ç›¸æ©Ÿã€‚';
      running=false; gameOver=false; clearInterval(timerId);
    });

    // åˆå§‹
    centroid={x:W/2,y:H/2}; lastCentroid={x:W/2-10,y:H/2}; direction={x:1,y:0};
  </script>
</body>
</html>
