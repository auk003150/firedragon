<!DOCTYPE html>
<html>
<head>
    <title>WebAR æ–°æ˜¥ç¢°æ’éŠæˆ² (å¤§å‘ç«é¾çœŸï¼é‚„åŸç‰ˆ)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
    
    <!-- å¼•å…¥ A-Frame å’Œ AR.js -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; font-family: 'Microsoft YaHei', sans-serif; 
            background-color: #000; 
        }
        #arjs-video {
            /* è®“å½±ç‰‡å¡«æ»¿è¢å¹•ï¼Œä½†ä¿æŒæ¯”ä¾‹ */
            width: 100vw !important; height: 100vh !important;
            position: absolute !important; top: 0 !important; left: 0 !important;
            z-index: 0 !important; margin: 0 !important;
            object-fit: cover !important; 
            /* ä¿®æ­£é¡åƒå•é¡Œï¼Œè¦–æƒ…æ³å¯èƒ½éœ€è¦èª¿æ•´ */
            transform: scaleX(-1) !important; 
        }
        #global-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: url('image_1.png') no-repeat center center;
            background-size: cover; z-index: 1; pointer-events: none; opacity: 0.9;
        }
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 10; overflow: hidden;
        }
        #score-board, #timer-board {
            position: absolute; top: 20px;
            background: rgba(255, 255, 255, 0.8); padding: 10px 20px;
            border-radius: 15px; font-size: 20px; font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        #score-board { left: 20px; border: 3px solid #d32f2f; color: #d32f2f; }
        #timer-board { right: 20px; border: 3px solid #1976d2; color: #1976d2; }

        /* --- æ¸¸æ¨™å®¹å™¨ --- */
        #aim-cursor {
            position: absolute; width: 100px; height: 100px;
            transform: translate(-50%, -50%); display: none;
            justify-content: center; align-items: center;
            z-index: 15;
            /* åŠ å…¥ CSS è½‰å ´è®“ç§»å‹•æ›´æ»‘é † */
            transition: left 0.1s linear, top 0.1s linear;
        }

        /* 
           ========================================
           ğŸ”¥ å¤§å‘ç«é¾ (Fire Dragon) æ¨£å¼ ğŸ”¥
           ========================================
        */
        .dragon-head {
            position: relative;
            width: 60px; height: 70px;
            background-color: #4e342e; 
            background-image: repeating-linear-gradient(45deg, rgba(0,0,0,0.2) 0px, rgba(0,0,0,0.2) 2px, transparent 2px, transparent 4px);
            border-radius: 20px;
            box-shadow: 
                0 -15px 0 -5px #ff5722, 
                15px -10px 0 -5px #ff5722, 
                -15px -10px 0 -5px #ff5722,
                0 -25px 4px -4px #ffeb3b,
                25px -15px 4px -4px #ffeb3b,
                -25px -15px 4px -4px #ffeb3b,
                0 0 30px rgba(255, 87, 34, 0.6);
            animation: fire-flicker 0.1s infinite alternate;
        }

        .incense-bundle {
            position: absolute; top: 50%; left: 50%;
            width: 100%; height: 100%;
            transform: translate(-50%, -50%); pointer-events: none;
        }
        
        .incense-bundle::before, .incense-bundle::after {
            content: ''; position: absolute;
            top: 50%; left: 50%;
            background: transparent;
            width: 2px; height: 2px;
            border-radius: 50%;
            box-shadow: 
                0 -40px 2px #ff3d00, 
                20px -35px 2px #ff9100, 
                -20px -35px 2px #ff9100,
                35px -20px 2px #ff3d00,
                -35px -20px 2px #ff3d00,
                40px 0px 2px #ff9100,
                -40px 0px 2px #ff9100;
            opacity: 0.9;
        }
        .incense-bundle::after {
            transform: rotate(22deg);
            box-shadow: 
                0 -45px 1px #ffeb3b, 
                25px -40px 1px #ff5722, 
                -25px -40px 1px #ff5722;
        }

        .dragon-horn {
            position: absolute; top: -10px;
            width: 8px; height: 20px;
            background: #5d4037;
            border-radius: 4px; z-index: -1;
        }
        .horn-left { left: 10px; transform: rotate(-15deg); }
        .horn-right { right: 10px; transform: rotate(15deg); }

        .dragon-eye {
            position: absolute; top: 20px;
            width: 14px; height: 14px;
            background: #00e676;
            border-radius: 50%;
            box-shadow: 0 0 10px #00e676;
            z-index: 5; border: 1px solid #004d40;
        }
        .eye-left { left: 8px; }
        .eye-right { right: 8px; }

        .dragon-mouth {
            position: absolute; bottom: 10px; left: 50%;
            transform: translateX(-50%);
            width: 40px; height: 20px;
            background: #3e2723;
            border-radius: 5px 5px 15px 15px;
            border: 1px solid #281815; overflow: hidden;
        }
        .dragon-mouth::after {
            content: ''; position: absolute; top: 0; left: 5px;
            width: 0; height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 8px solid #fff;
            box-shadow: 10px 0 0 #fff, 20px 0 0 #fff;
        }

        .dragon-whisker {
            position: absolute; bottom: 5px;
            width: 50px; height: 30px;
            border-top: 3px solid #8d6e63;
            border-radius: 50%; z-index: -1;
        }
        .whisker-left { right: 85%; transform: rotate(20deg); }
        .whisker-right { left: 85%; transform: rotate(-20deg); }

        @keyframes fire-flicker {
            0% { opacity: 0.9; transform: scale(1); filter: brightness(1); }
            100% { opacity: 1; transform: scale(1.02); filter: brightness(1.2); }
        }

        /* --- æ‰è½ç‰©é«”æ¨£å¼ --- */
        .floating-item {
            position: absolute; font-size: 40px; font-weight: bold;
            display: flex; justify-content: center; align-items: center;
            width: 70px; height: 70px; border-radius: 50%;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 5; will-change: transform, left, top;
        }
        .good-item { color: #d32f2f; border: 3px solid #d32f2f; }
        .bad-item { color: #333; border: 3px solid #555; }
        .score-popup {
            position: absolute; font-size: 36px; font-weight: 900;
            text-shadow: 1px 1px 0 #fff; animation: floatUp 0.8s ease-out forwards;
            z-index: 20;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-60px); }
        }
        .overlay-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 30;
            pointer-events: auto; color: white; text-align: center;
        }
        button {
            padding: 15px 40px; font-size: 22px; background: #d32f2f; color: white;
            border: none; border-radius: 50px; cursor: pointer; margin-top: 20px;
            font-weight: bold; box-shadow: 0 0 15px #ff5252;
        }
        #mute-btn {
            position: absolute; bottom: 20px; right: 20px; z-index: 40;
            background: rgba(255,255,255,0.5); border: none; padding: 10px;
            border-radius: 50%; font-size: 24px; cursor: pointer; pointer-events: auto;
        }
    </script>
</head>
<body>

    <!-- éŸ³æ•ˆè³‡æº -->
    <audio id="bgm" loop>
        <source src="https://actions.google.com/sounds/v1/science_fiction/scifi_industrial_loop.ogg" type="audio/ogg">
    </audio>
    <audio id="sfx-collect">
        <source src="Collect.mp3" type="audio/mp3">
    </audio>
    <audio id="sfx-end">
        <source src="https://actions.google.com/sounds/v1/cartoon/clown_horn.ogg" type="audio/ogg">
    </audio>

    <!-- èƒŒæ™¯åœ–å±¤ -->
    <div id="global-bg"></div>

    <!-- UI å±¤ -->
    <div id="ui-layer">
        <div id="score-board">åˆ†æ•¸: <span id="score">0</span></div>
        <div id="timer-board">æ™‚é–“: <span id="timer">60</span></div>
        
        <!-- å¤§å‘ç«é¾æ¸¸æ¨™ -->
        <div id="aim-cursor">
            <div class="dragon-head">
                <div class="incense-bundle"></div>
                <div class="dragon-horn horn-left"></div>
                <div class="dragon-horn horn-right"></div>
                <div class="dragon-eye eye-left"></div>
                <div class="dragon-eye eye-right"></div>
                <div class="dragon-mouth"></div>
                <div class="dragon-whisker whisker-left"></div>
                <div class="dragon-whisker whisker-right"></div>
            </div>
        </div>

        <div id="game-area"></div>
        <button id="mute-btn" onclick="toggleMute()">ğŸ”Š</button>
    </div>

    <!-- é–‹å§‹ç•«é¢ -->
    <div id="start-screen" class="overlay-screen">
        <h1>ğŸ”¥ èˆç«é¾å¤§ç¢°æ’ ğŸ”¥</h1>
        <p>è«‹æº–å‚™å¥½ Hiro Marker!!!!!!</p>
        <button onclick="startGame()">é–‹å§‹èˆå‹•</button>
    </div>

    <!-- çµæŸç•«é¢ -->
    <div id="game-over-screen" class="overlay-screen" style="display: none;">
        <h1>æ™‚é–“åˆ°ï¼</h1>
        <p>æœ€çµ‚åˆ†æ•¸: <span id="final-score" style="font-size: 40px; font-weight: bold;">0</span></p>
        <button onclick="startGame()">å†èˆä¸€æ¬¡</button>
    </div>

    <!-- 
        AR å ´æ™¯è¨­å®š (é—œéµå„ªåŒ–éƒ¨åˆ†) 
        1. sourceType: webcam -> ä½¿ç”¨æ”åƒé ­
        2. sourceWidth/Height: 1280x720 -> æé«˜æ”åƒé ­è§£æåº¦ï¼Œè®“æ¨™è¨˜æ›´æ¸…æ™°
        3. displayWidth/Height: 1280x720 -> æ¸²æŸ“ç•«å¸ƒè§£æåº¦
        4. maxDetectionRate: 60 -> æé«˜æª¢æ¸¬é »ç‡
        5. canvasWidth/Height -> ç¢ºä¿å…§éƒ¨è¨ˆç®—ä¹Ÿæ˜¯é«˜è§£æåº¦
    -->
    <a-scene 
        embedded 
        arjs='sourceType: webcam; sourceWidth:1280; sourceHeight:720; displayWidth: 1280; displayHeight: 720; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; maxDetectionRate: 60; canvasWidth: 1280; canvasHeight: 720;' 
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; precision: medium;">
        
        <a-entity camera></a-entity>
        
        <!-- 
            smooth="true": é–‹å•Ÿå¹³æ»‘
            smoothCount="10": å¹³æ»‘æ¡æ¨£æ•¸ï¼Œæ•¸å€¼è¶Šé«˜è¶Šå¹³æ»‘ä½†å»¶é²è¶Šé«˜ (å»ºè­° 5-10)
            smoothTolerance=".01": å®¹è¨±èª¤å·®
            smoothThreshold="5": ç§»å‹•é–¾å€¼
        -->
        <a-marker preset="hiro" id="player-marker" smooth="true" smoothCount="10" smoothTolerance=".01" smoothThreshold="5"></a-marker>
    </a-scene>

    <script>
        // --- éŸ³æ•ˆç®¡ç† ---
        const sounds = {
            bgm: document.getElementById('bgm'),
            collect: document.getElementById('sfx-collect'),
            end: document.getElementById('sfx-end')
        };
        let isMuted = false;

        sounds.bgm.volume = 0.4; 
        sounds.collect.volume = 0.8;

        function playSound(name) {
            if (isMuted) return;
            const audio = sounds[name];
            if (audio) {
                audio.currentTime = 0; 
                audio.play().catch(e => console.log("Audio play failed:", e));
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            const btn = document.getElementById('mute-btn');
            if (isMuted) {
                sounds.bgm.pause();
                btn.innerText = 'ğŸ”‡';
            } else {
                if(isGameRunning) sounds.bgm.play();
                btn.innerText = 'ğŸ”Š';
            }
        }

        // --- éŠæˆ²é‚è¼¯è®Šæ•¸ ---
        const goodWords = ['ç¦', 'æ˜¥', 'è²¡', 'å‰', 'ç¥¥', 'æ—º'];
        const badWords = ['ğŸ’£', 'ğŸ’©', 'ğŸ•·ï¸', 'ğŸ', 'ğŸ¥€'];
        let score = 0;
        let timeLeft = 60;
        let isGameRunning = false;
        let items = []; 
        let timerInterval = null;
        let gameWidth = window.innerWidth;
        let gameHeight = window.innerHeight;
        
        // ç”¨æ–¼å¹³æ»‘ç§»å‹•çš„è®Šæ•¸
        let currentX = -100;
        let currentY = -100;
        let targetX = -100;
        let targetY = -100;
        let isTracking = false;

        // --- DOM å…ƒç´  ---
        const gameArea = document.getElementById('game-area');
        const scoreEl = document.getElementById('score');
        const timerEl = document.getElementById('timer');
        const aimCursor = document.getElementById('aim-cursor');
        const playerMarker = document.getElementById('player-marker');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over-screen');
        const finalScoreEl = document.getElementById('final-score');

        // --- ä¿®æ­£ AR.js å½±ç‰‡å¤§å° ---
        function fixVideoSize() {
            const video = document.getElementById('arjs-video');
            if (video) {
                video.style.width = window.innerWidth + 'px';
                video.style.height = window.innerHeight + 'px';
                video.style.objectFit = 'cover';
                video.style.marginLeft = '0px';
                video.style.marginTop = '0px';
            }
        }

        window.addEventListener('resize', () => {
            gameWidth = window.innerWidth;
            gameHeight = window.innerHeight;
            fixVideoSize();
        });

        const videoCheckInterval = setInterval(() => {
            const video = document.getElementById('arjs-video');
            if (video) {
                fixVideoSize();
                video.addEventListener('loadedmetadata', fixVideoSize);
                video.addEventListener('play', fixVideoSize);
                clearInterval(videoCheckInterval);
            }
        }, 500);

        // --- éŠæˆ²ä¸»æµç¨‹ ---
        function startGame() {
            if (!isMuted) {
                sounds.bgm.play().catch(e => console.log("BGM play failed:", e));
            }

            startScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            
            score = 0;
            timeLeft = 60;
            scoreEl.innerText = score;
            timerEl.innerText = timeLeft;
            gameArea.innerHTML = '';
            items = [];
            isGameRunning = true;

            fixVideoSize();
            spawnItems(6, 'good'); 
            spawnItems(4, 'bad');  
            
            gameLoop();

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeLeft--;
                timerEl.innerText = timeLeft;
                if (timeLeft <= 0) endGame();
            }, 1000);
        }

        function endGame() {
            isGameRunning = false;
            clearInterval(timerInterval);
            
            sounds.bgm.pause();
            sounds.bgm.currentTime = 0;
            playSound('end');

            finalScoreEl.innerText = score;
            gameOverScreen.style.display = 'flex';
        }

        function spawnItems(count, type) {
            for (let i = 0; i < count; i++) {
                const el = document.createElement('div');
                el.classList.add('floating-item');
                el.classList.add(type === 'good' ? 'good-item' : 'bad-item');
                el.innerText = type === 'good' ? 
                    goodWords[Math.floor(Math.random() * goodWords.length)] : 
                    badWords[Math.floor(Math.random() * badWords.length)];
                el.dataset.points = type === 'good' ? 15 : -5;
                
                gameArea.appendChild(el);

                const size = 70;
                items.push({
                    element: el,
                    x: Math.random() * (gameWidth - size),
                    y: Math.random() * (gameHeight - size),
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    width: size, height: size,
                    active: true
                });
            }
        }

        // --- ç·šæ€§æ’å€¼å‡½æ•¸ (Lerp) ç”¨æ–¼å¹³æ»‘ç§»å‹• ---
        function lerp(start, end, amt) {
            return (1 - amt) * start + amt * end;
        }

        function gameLoop() {
            if (!isGameRunning) return;
            
            // æª¢æ¸¬ Marker æ˜¯å¦è¢«è¿½è¹¤åˆ°
            if (playerMarker.object3D.visible) {
                isTracking = true;
                const vector = new THREE.Vector3();
                playerMarker.object3D.getWorldPosition(vector);
                
                const camera = document.querySelector('a-scene').camera;
                vector.project(camera);

                // è¨ˆç®—ç›®æ¨™ä½ç½®
                targetX = ((-vector.x + 1) / 2) * gameWidth;
                targetY = ((-vector.y + 1) / 2) * gameHeight;

                // ä½¿ç”¨ Lerp è®“ currentX æ…¢æ…¢æ¥è¿‘ targetX (0.2 æ˜¯å¹³æ»‘ä¿‚æ•¸ï¼Œè¶Šå°è¶Šæ…¢è¶Šæ»‘)
                currentX = lerp(currentX, targetX, 0.2);
                currentY = lerp(currentY, targetY, 0.2);

                aimCursor.style.display = 'flex';
                aimCursor.style.left = currentX + 'px';
                aimCursor.style.top = currentY + 'px';
            } else {
                isTracking = false;
                aimCursor.style.display = 'none';
            }

            // ç‰©å“ç§»å‹•èˆ‡ç¢°æ’æª¢æ¸¬
            items.forEach(item => {
                if (!item.active) return;
                
                item.x += item.vx;
                item.y += item.vy;

                if (item.x <= 0 || item.x >= gameWidth - item.width) item.vx *= -1;
                if (item.y <= 0 || item.y >= gameHeight - item.height) item.vy *= -1;

                item.x = Math.max(0, Math.min(item.x, gameWidth - item.width));
                item.y = Math.max(0, Math.min(item.y, gameHeight - item.height));

                item.element.style.left = item.x + 'px';
                item.element.style.top = item.y + 'px';

                // ç¢°æ’æª¢æ¸¬ï¼šä½¿ç”¨å¹³æ»‘å¾Œçš„åº§æ¨™ (currentX, currentY)
                if (isTracking) {
                    const dx = currentX - (item.x + item.width/2);
                    const dy = currentY - (item.y + item.height/2);
                    // ç¢°æ’è·é›¢åˆ¤å®š (åŠå¾‘å’Œ)
                    if ((dx*dx + dy*dy) < (50 + 35)**2) {
                        handleHit(item);
                    }
                }
            });

            requestAnimationFrame(gameLoop);
        }

        function handleHit(item) {
            const pts = parseInt(item.element.dataset.points);
            score += pts;
            scoreEl.innerText = score;
            
            playSound('collect');
            
            const popup = document.createElement('div');
            popup.classList.add('score-popup');
            popup.innerText = pts > 0 ? `+${pts}` : pts;
            popup.style.color = pts > 0 ? '#2e7d32' : '#d32f2f';
            popup.style.left = item.x + 'px';
            popup.style.top = item.y + 'px';
            gameArea.appendChild(popup);
            setTimeout(() => popup.remove(), 800);

            item.active = false;
            item.element.style.opacity = '0';
            setTimeout(() => {
                if (!isGameRunning) return;
                item.active = true;
                item.element.style.opacity = '1';
                item.x = Math.random() * (gameWidth - item.width);
                item.y = Math.random() * (gameHeight - item.height);
                item.element.innerText = pts > 0 ? 
                    goodWords[Math.floor(Math.random() * goodWords.length)] : 
                    badWords[Math.floor(Math.random() * badWords.length)];
            }, 500);
        }
    </script>
</body>
</html>
