<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>å¤§å‘èˆç«é¾ ARï¼ˆHiro Markerï¼‰</title>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.2/aframe/build/aframe-ar.js"></script>

  <style>
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: #000; color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans HK", "Noto Sans CJK", "PingFang HK", "Heiti TC", Arial, sans-serif;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      touch-action: manipulation;
    }
    a-scene {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
    }
    .ui {
      position: fixed;
      left: 0; right: 0; top: 0;
      display: grid; gap: 6px; padding: 10px 12px;
      background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0));
      user-select: none; z-index: 20;
    }
    .topbar {
      display: flex; align-items: center; justify-content: space-between; gap: 8px;
    }
    .hudbar {
      display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    }
    .btn { background: #e11d48; border: none; color: #fff; border-radius: 10px; padding: 10px 14px; font-weight: 700; letter-spacing: 0.5px; box-shadow: 0 4px 12px rgba(225,29,72,0.35); }
    .btn.ghost { background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.2); color: #fff; box-shadow: none; }
    .btn:disabled { opacity: 0.6; }
    .btn:active { transform: translateY(1px); }
    .hud { display: flex; gap: 10px; align-items: center; font-weight: 700; text-shadow: 0 2px 6px rgba(0,0,0,0.6); flex-wrap: wrap; }
    .chip { background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.2); border-radius: 999px; padding: 6px 10px; font-size: 14px; }
    .hint {
      position: fixed; left: 0; right: 0; top: 50%; transform: translateY(-50%);
      text-align: center; padding: 0 16px; color: #ffd166; font-weight: 700; text-shadow: 0 2px 10px rgba(0,0,0,0.7); z-index: 5;
    }
    .ok { color: #22c55e; }
    .bad { color: #f97316; }
    .panel-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 30;
      opacity: 0; pointer-events: none; transition: opacity .2s ease;
    }
    .panel-backdrop.open { opacity: 1; pointer-events: auto; }
    .panel {
      position: fixed; top: 0; right: 0; height: 100%;
      background: rgba(17,24,39,0.9); backdrop-filter: blur(10px);
      border-left: 1px solid rgba(255,255,255,0.12);
      width: min(360px, 92vw);
      transform: translateX(100%);
      transition: transform .25s ease;
      z-index: 31; color: #fff; overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .panel.open { transform: translateX(0); }
    .panel header {
      position: sticky; top: 0; background: rgba(17,24,39,0.95);
      padding: 12px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .panel h2 { margin: 0; font-size: 16px; }
    .panel .section { padding: 12px; display: grid; gap: 12px; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .row .label { font-size: 14px; color: #e5e7eb; }
    .mini { padding: 8px 10px; font-weight: 600; font-size: 12px; border-radius: 8px; background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.2); color: #fff; }
  </style>
</head>
<body>
  <!-- UI -->
  <div class="ui">
    <div class="topbar">
      <button id="startBtn" class="btn">é–‹å§‹</button>
      <button id="menuBtn" class="btn ghost">â‰¡ é¸å–®</button>
    </div>
    <div class="hudbar">
      <div class="hud">
        <div class="chip">åˆ†æ•¸ï¼š<span id="score">0</span></div>
        <div class="chip">Comboï¼š<span id="combo">0</span></div>
        <div class="chip">æ™‚é–“ï¼š<span id="time">60</span>s</div>
      </div>
    </div>
  </div>

  <div id="hint" class="hint">æŒ‰ã€Œé–‹å§‹ã€ï¼Œå°‡ Hiro marker æ”¾å…¥é¡é ­è¦–é‡ã€‚</div>

  <!-- å´é‚Šè¨­å®šé¢æ¿ -->
  <div id="panelBackdrop" class="panel-backdrop"></div>
  <aside id="panel" class="panel" aria-hidden="true">
    <header>
      <h2>è¨­å®š</h2>
      <button id="closePanel" class="btn ghost" aria-label="é—œé–‰">âœ•</button>
    </header>
    <div class="section">
      <div class="row">
        <div class="label">è¢å¹•</div>
        <button id="fullscreenBtn" class="mini">å…¨å±</button>
      </div>
      <div class="row">
        <div class="label">éŠæˆ²</div>
        <button id="resetBtn" class="mini">é‡ç½®</button>
      </div>
    </div>
  </aside>

  <!-- A-Frame AR Scene -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    renderer="antialias: true; alpha: true; logarithmicDepthBuffer: true;"
    arjs="sourceType: webcam; debugUIEnabled: false; trackingMethod: best;"
  >
    <!-- Hiro marker -->
    <a-marker id="hiroMarker" preset="hiro">
      <!-- ç«é¾é ­ï¼ˆä½¿ç”¨ç¾æœ‰ image_2.png è²¼åœ–ï¼‰ -->
      <a-image id="dragonHead" src="image_2.png" position="0 0 0" width="0.4" height="0.4"></a-image>
    </a-marker>

    <!-- ç‰©ä»¶å®¹å™¨ï¼ˆå‹•æ…‹æ’å…¥ï¼‰ -->
    <a-entity id="itemsRoot"></a-entity>

    <!-- ç›¸æ©Ÿ -->
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // ========= ç‹€æ…‹ =========
    const state = {
      running: false,
      gameOver: false,
      score: 0,
      combo: 0,
      timeLeft: 60,
      timerId: null,
      markerVisible: false,
      items: [],
      targetCount: 12,
      collisionRadius: 0.25, // ç´„ 25cm
    };

    // ========= DOM =========
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const scoreEl = document.getElementById('score');
    const comboEl = document.getElementById('combo');
    const timeEl = document.getElementById('time');
    const hintEl = document.getElementById('hint');

    const menuBtn = document.getElementById('menuBtn');
    const panel = document.getElementById('panel');
    const panelBackdrop = document.getElementById('panelBackdrop');
    const closePanelBtn = document.getElementById('closePanel');

    const sceneEl = document.querySelector('a-scene');
    const markerEl = document.getElementById('hiroMarker');
    const itemsRoot = document.getElementById('itemsRoot');

    // ========= æ–‡å­—åˆ—è¡¨ =========
    const goodList = ['ç¦','æ˜¥','è²¡','å®‰','æ—º','å‰','ç¥¥','è³€','é¾','å¹´'];
    const badList  = ['âš½','ğŸ”','ğŸ§','ğŸ§Š','ğŸº','ğŸ’¡','ğŸ“','ğŸ§¯','ğŸ§½','ğŸ²'];

    // ========= å·¥å…· =========
    function randRange(min, max) { return min + Math.random() * (max - min); }
    function choose(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    function updateHUD() {
      scoreEl.textContent = state.score;
      comboEl.textContent = state.combo;
      timeEl.textContent = state.timeLeft;
    }

    function setHint(text, cls='') {
      hintEl.textContent = text;
      hintEl.className = 'hint' + (cls ? ' ' + cls : '');
    }

    // ========= ç‰©ä»¶ç”Ÿæˆ =========
    function spawnItem() {
      const isGood = Math.random() < 0.65;
      const text = isGood ? choose(goodList) : choose(badList);
      const size = randRange(0.32, 0.46); // å…¬å°ºï¼ˆæ–‡å­—å¤§å°å½±éŸ¿ scaleï¼‰
      const r = randRange(0.35, 1.0); // é›¢åŸé»åŠå¾‘ï¼ˆå…¬å°ºï¼‰
      const ang = randRange(0, Math.PI * 2);
      const x = Math.cos(ang) * r;
      const z = Math.sin(ang) * r;
      const y = randRange(0.05, 0.55);

      const el = document.createElement('a-entity');
      el.setAttribute('text', {
        value: text,
        color: isGood ? '#ffd166' : '#ff6b6b',
        align: 'center',
        baseline: 'center',
        font: 'mozillavr',
        width: 1.5
      });
      el.setAttribute('position', { x, y, z });
      el.setAttribute('scale', `${size} ${size} ${size}`);
      itemsRoot.appendChild(el);

      state.items.push({
        el,
        isGood,
        expireAt: performance.now() + randRange(8000, 14000) // 8~14 ç§’
      });
    }

    function ensureItems() {
      while (state.items.length < state.targetCount) spawnItem();
    }

    function removeItem(idx) {
      const it = state.items[idx];
      if (it && it.el && it.el.parentNode) it.el.parentNode.removeChild(it.el);
      state.items.splice(idx, 1);
    }

    // ========= ç¢°æ’èˆ‡å¾—åˆ† =========
    const tmpV1 = new THREE.Vector3();
    const tmpV2 = new THREE.Vector3();

    function handleCollisions() {
      if (!state.markerVisible) return;

      markerEl.object3D.getWorldPosition(tmpV1);

      for (let i = state.items.length - 1; i >= 0; i--) {
        const it = state.items[i];
        if (!it.el.object3D) continue;
        it.el.object3D.getWorldPosition(tmpV2);
        const dist = tmpV1.distanceTo(tmpV2);
        if (dist <= state.collisionRadius) {
          if (it.isGood) {
            state.combo += 1;
            const bonus = 10 + Math.min(60, state.combo * 2);
            state.score += bonus;
          } else {
            state.combo = 0;
            state.score = Math.max(0, state.score - 15);
          }
          updateHUD();
          removeItem(i);
        }
      }
    }

    // ========= è¨ˆæ™‚ =========
    function startTimer() {
      clearInterval(state.timerId);
      state.timerId = setInterval(() => {
        state.timeLeft -= 1;
        updateHUD();
        if (state.timeLeft <= 0) {
          clearInterval(state.timerId);
          state.running = false;
          state.gameOver = true;
          setHint(`æ™‚é–“åˆ°ï¼ç¸½åˆ†ï¼š${state.score}`);
          startBtn.disabled = false;
        }
      }, 1000);
    }

    // ========= éŠæˆ²æ§åˆ¶ =========
    function startGame() {
      if (state.running) return;
      state.running = true;
      state.gameOver = false;
      state.score = 0;
      state.combo = 0;
      state.timeLeft = 60;
      updateHUD();
      setHint('è«‹å°‡ Hiro marker æ”¾å…¥é¡é ­è¦–é‡ã€‚');
      startBtn.disabled = true;
      // æ¸…ç©ºèˆŠç‰©ä»¶
      state.items.forEach(it => it.el.parentNode && it.el.parentNode.removeChild(it.el));
      state.items = [];
      ensureItems();
      startTimer();
    }

    function resetGame() {
      state.running = false;
      state.gameOver = false;
      clearInterval(state.timerId);
      state.timeLeft = 60;
      state.score = 0;
      state.combo = 0;
      updateHUD();
      startBtn.disabled = false;
      state.items.forEach(it => it.el.parentNode && it.el.parentNode.removeChild(it.el));
      state.items = [];
      setHint('å·²é‡ç½®ï¼ŒæŒ‰ã€Œé–‹å§‹ã€å†ç©ä¸€æ¬¡ã€‚');
    }

    // ========= AR äº‹ä»¶ =========
    markerEl.addEventListener('markerFound', () => {
      state.markerVisible = true;
      if (state.running) setHint('åµæ¸¬åˆ° Hiro markerï¼Œé–‹å§‹èˆå‹•ï¼', 'ok');
    });
    markerEl.addEventListener('markerLost', () => {
      state.markerVisible = false;
      if (state.running) setHint('æ‰¾ä¸åˆ° Hiro markerï¼Œè«‹é‡æ–°å°æº–ã€‚', 'bad');
    });

    // ========= ä¸»å¾ªç’° (A-Frame component) =========
    AFRAME.registerComponent('game-loop', {
      tick: function (time, dt) {
        if (!state.running || state.gameOver) return;

        // ç§»é™¤éæœŸç‰©ä»¶
        const now = performance.now();
        for (let i = state.items.length - 1; i >= 0; i--) {
          if (now > state.items[i].expireAt) removeItem(i);
        }
        ensureItems();
        handleCollisions();
      }
    });
    // æ›åˆ°å ´æ™¯
    sceneEl.setAttribute('game-loop', '');

    // ========= UI äº‹ä»¶ =========
    startBtn.addEventListener('click', startGame);
    resetBtn.addEventListener('click', resetGame);

    fullscreenBtn.addEventListener('click', () => {
      const el = document.documentElement;
      if (!document.fullscreenElement) {
        (el.requestFullscreen && el.requestFullscreen()) || (el.webkitRequestFullscreen && el.webkitRequestFullscreen());
      } else {
        (document.exitFullscreen && document.exitFullscreen()) || (document.webkitExitFullscreen && document.webkitExitFullscreen());
      }
    });

    function openPanel() {
      panel.classList.add('open');
      panelBackdrop.classList.add('open');
      panel.setAttribute('aria-hidden', 'false');
    }
    function closePanel() {
      panel.classList.remove('open');
      panelBackdrop.classList.remove('open');
      panel.setAttribute('aria-hidden', 'true');
    }
    menuBtn.addEventListener('click', openPanel);
    closePanelBtn.addEventListener('click', closePanel);
    panelBackdrop.addEventListener('click', closePanel);

    // ========= åˆå§‹æç¤º =========
    setHint('æŒ‰ã€Œé–‹å§‹ã€ï¼Œå°‡ Hiro marker æ”¾å…¥é¡é ­è¦–é‡ã€‚');
  </script>
</body>
</html>
