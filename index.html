<!DOCTYPE html>
<html>
<head>
    <title>WebAR æ–°æ˜¥ç¢°æ’éŠæˆ²</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <!-- å¼•å…¥ A-Frame å’Œ AR.js -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Microsoft YaHei', sans-serif; }
        
        /* UI ä»‹é¢å±¤ */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ° AR å ´æ™¯ */
            z-index: 10;
        }

        #score-board {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.8);
            padding: 15px 25px;
            border-radius: 15px;
            border: 2px solid #d32f2f;
            font-size: 24px;
            font-weight: bold;
            color: #d32f2f;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* æ¼‚æµ®å…ƒç´ çš„æ¨£å¼ */
        .floating-item {
            position: absolute;
            font-size: 40px;
            font-weight: bold;
            user-select: none;
            transition: transform 0.1s linear;
            will-change: left, top;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .good-item { color: #d32f2f; border: 2px solid #d32f2f; }
        .bad-item { color: #555; border: 2px solid #555; }

        /* åˆ†æ•¸ç‰¹æ•ˆ */
        .score-popup {
            position: absolute;
            font-size: 30px;
            font-weight: bold;
            animation: floatUp 1s ease-out forwards;
        }
        
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }

        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            pointer-events: auto;
            color: white;
            text-align: center;
        }

        button {
            padding: 15px 30px;
            font-size: 20px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <!-- UI å±¤ -->
    <div id="ui-layer">
        <div id="score-board">åˆ†æ•¸: <span id="score">0</span></div>
        <div id="game-area"></div>
    </div>

    <!-- é–‹å§‹ç•«é¢ -->
    <div id="start-screen">
        <h1>WebAR æ–°æ˜¥ç¢°æ’éŠæˆ²</h1>
        <p>è«‹æº–å‚™å¥½ Hiro Marker</p>
        <p>ğŸ”´ ç¢°åˆ°ç´…å­— +15 åˆ†</p>
        <p>âš« ç¢°åˆ°é›œç‰© -5 åˆ†</p>
        <button onclick="startGame()">é–‹å§‹éŠæˆ²</button>
    </div>

    <!-- A-Frame AR å ´æ™¯ -->
    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;'>
        
        <!-- æ”åƒæ©Ÿ -->
        <a-entity camera></a-entity>

        <!-- Hiro Marker -->
        <!-- ä½¿ç”¨ scale="-1 1 1" å¯¦ç¾é¡åƒæ•ˆæœ -->
        <a-marker preset="hiro" id="player-marker">
            <!-- é€™æ˜¯ç©å®¶æ§åˆ¶çš„ç¢°æ’é«” (ä¸€å€‹ç´…è‰²çš„ç’°) -->
            <a-entity id="collider" 
                      geometry="primitive: ring; radiusInner: 0.5; radiusOuter: 0.8" 
                      material="color: red; opacity: 0.7; side: double" 
                      rotation="-90 0 0"
                      position="0 0 0"
                      scale="-1 1 1"> <!-- é€™è£¡ä¹ŸåŠ ä¸Šé¡åƒä»¥ç¢ºä¿è¦–è¦ºä¸€è‡´ -->
                <a-animation attribute="scale" to="1.2 1.2 1.2" direction="alternate" dur="500" repeat="indefinite"></a-animation>
            </a-entity>
        </a-marker>

    </a-scene>

    <script>
        // éŠæˆ²æ•¸æ“š
        const goodWords = ['ç¦', 'æ˜¥', 'è²¡', 'å®‰', 'æ—º', 'å‰', 'ç¥¥', 'è³€', 'é¾', 'å¹´'];
        const badWords = ['âš½', 'ğŸ”', 'ğŸ§', 'ğŸ§Š', 'ğŸ§¼', 'ğŸº', 'ğŸ’¡', 'ğŸ“', 'ğŸ§½', 'ğŸ§¯'];
        
        let score = 0;
        let isGameRunning = false;
        let items = []; // å­˜å„²å±å¹•ä¸Šçš„å…ƒç´ å°è±¡
        const gameArea = document.getElementById('game-area');
        const scoreEl = document.getElementById('score');
        const playerMarker = document.getElementById('player-marker');
        
        // ç©å®¶å±å¹•åº§æ¨™ (ç”± AR Marker è½‰æ›è€Œä¾†)
        let playerScreenPos = { x: -1000, y: -1000, visible: false };

        // å•Ÿå‹•éŠæˆ²
        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            isGameRunning = true;
            spawnItems(5, 'good'); // ç”Ÿæˆ5å€‹å¥½è©
            spawnItems(5, 'bad');  // ç”Ÿæˆ5å€‹å£è©
            gameLoop();
        }

        // ç”Ÿæˆå…ƒç´ 
        function spawnItems(count, type) {
            for (let i = 0; i < count; i++) {
                const el = document.createElement('div');
                el.classList.add('floating-item');
                
                let text = '';
                if (type === 'good') {
                    text = goodWords[Math.floor(Math.random() * goodWords.length)];
                    el.classList.add('good-item');
                    el.dataset.points = 15;
                } else {
                    text = badWords[Math.floor(Math.random() * badWords.length)];
                    el.classList.add('bad-item');
                    el.dataset.points = -5;
                }
                
                el.innerText = text;
                gameArea.appendChild(el);

                // åˆå§‹åŒ–ä½ç½®å’Œé€Ÿåº¦
                const itemObj = {
                    element: el,
                    x: Math.random() * (window.innerWidth - 60),
                    y: Math.random() * (window.innerHeight - 60),
                    vx: (Math.random() - 0.5) * 4, // æ°´å¹³é€Ÿåº¦
                    vy: (Math.random() - 0.5) * 4, // å‚ç›´é€Ÿåº¦
                    width: 60,
                    height: 60,
                    active: true
                };
                items.push(itemObj);
            }
        }

        // éŠæˆ²ä¸»å¾ªç’°
        function gameLoop() {
            if (!isGameRunning) return;

            updatePlayerPosition();
            updateItems();
            checkCollisions();

            requestAnimationFrame(gameLoop);
        }

        // æ›´æ–°ç©å®¶(Marker)åœ¨å±å¹•ä¸Šçš„ 2D åº§æ¨™
        function updatePlayerPosition() {
            if (playerMarker.object3D.visible) {
                const vector = new THREE.Vector3();
                playerMarker.object3D.getWorldPosition(vector);
                
                // é¡åƒè™•ç†ï¼šå› ç‚º AR å ´æ™¯é€šå¸¸æ˜¯ç¿»è½‰çš„ï¼Œæˆ‘å€‘éœ€è¦æ‰‹å‹•è¨ˆç®—åå‘çš„ X è»¸
                // é€™è£¡æˆ‘å€‘ç›´æ¥ç²å–æ¨™æº–æŠ•å½±ï¼Œç„¶å¾Œå° X é€²è¡Œåè½‰è™•ç†ä»¥é©é… WebAR çš„é¡åƒé«”é©—
                vector.project(document.querySelector('a-scene').camera);

                // å°‡æ¨™æº–åŒ–è¨­å‚™åæ¨™ (NDC) è½‰æ›ç‚ºå±å¹•åæ¨™
                // æ³¨æ„ï¼šé€™è£¡çš„ X è»¸è¨ˆç®—ä½¿ç”¨äº† (1 - ...) æˆ–è€…åè½‰é‚è¼¯ä¾†å¯¦ç¾é¡åƒ
                // é€šå¸¸ WebAR å‰ç½®æ”åƒé ­æ˜¯é¡åƒçš„ï¼Œæ‰€ä»¥ç‰©é«”å‘å³ç§»ï¼Œå±å¹•ä¸Šæ‡‰è©²å‘å·¦ã€‚
                // ä½†ç”¨æˆ¶è¦æ±‚ã€Œåƒåœ¨é¡å­å‰ä¸€æ¨£ç§»å‹•ã€ï¼Œæ„å‘³è‘—æˆ‘å‘å³ï¼Œå±å¹•è£¡çš„ç‰©é«”ä¹Ÿå‘å³ã€‚
                // AR.js é»˜èªè¡Œç‚ºæœ‰æ™‚æœƒæ··äº‚ï¼Œé€™è£¡æˆ‘å€‘é€šéèª¿æ•´è¨ˆç®—å…¬å¼ä¾†å¼·åˆ¶å°é½Šã€‚
                
                // æ¨™æº–è¨ˆç®—: x = (vector.x + 1) / 2 * width
                // é¡åƒè¨ˆç®—: x = (1 - (vector.x + 1) / 2) * width  => ç›¸ç•¶æ–¼ x = (-vector.x + 1) / 2 * width
                
                // ç”±æ–¼æˆ‘å€‘åœ¨ HTML ä¸­å° marker å…§å®¹åŠ äº† scale="-1 1 1"ï¼Œè¦–è¦ºä¸Šæ¨¡å‹å·²ç¶“ç¿»è½‰ã€‚
                // é€™è£¡æˆ‘å€‘è¨ˆç®—å±å¹•ç¢°æ’é»æ™‚ï¼Œç›´æ¥ä½¿ç”¨æ¨™æº–æ˜ å°„ï¼Œä½†å› ç‚º CSS çµ•å°å®šä½æ˜¯ left/topï¼Œ
                // æˆ‘å€‘éœ€è¦æ ¹æ“šå¯¦éš›é«”é©—èª¿æ•´ã€‚
                
                // ç¶“éæ¸¬è©¦ï¼Œç‚ºäº†è®“ç”¨æˆ¶æ„Ÿè¦ºåƒç…§é¡å­ï¼ˆæ‰‹å¾€å³ï¼Œå±å¹•ä¸Šçš„åœˆåœˆä¹Ÿå¾€å³ï¼‰ï¼Œ
                // æˆ‘å€‘éœ€è¦åè½‰ X è»¸çš„ NDC åº§æ¨™ã€‚
                const screenX = ((-vector.x + 1) / 2) * window.innerWidth;
                const screenY = ((-vector.y + 1) / 2) * window.innerHeight;

                playerScreenPos.x = screenX;
                playerScreenPos.y = screenY;
                playerScreenPos.visible = true;
            } else {
                playerScreenPos.visible = false;
            }
        }

        // æ›´æ–°æ¼‚æµ®å…ƒç´ ä½ç½®
        function updateItems() {
            items.forEach(item => {
                if (!item.active) return;

                item.x += item.vx;
                item.y += item.vy;

                // é‚Šç•Œåå½ˆ
                if (item.x <= 0 || item.x >= window.innerWidth - item.width) {
                    item.vx *= -1;
                    item.x = Math.max(0, Math.min(item.x, window.innerWidth - item.width));
                }
                if (item.y <= 0 || item.y >= window.innerHeight - item.height) {
                    item.vy *= -1;
                    item.y = Math.max(0, Math.min(item.y, window.innerHeight - item.height));
                }

                item.element.style.left = item.x + 'px';
                item.element.style.top = item.y + 'px';
            });
        }

        // ç¢°æ’æª¢æ¸¬
        function checkCollisions() {
            if (!playerScreenPos.visible) return;

            // å®šç¾©ç©å®¶ç¢°æ’åŠå¾‘ (åƒç´ )
            const playerRadius = 50; 

            items.forEach(item => {
                if (!item.active) return;

                // ç°¡å–®çš„åœ“å½¢ç¢°æ’æª¢æ¸¬
                // ç‰©å“ä¸­å¿ƒ
                const itemCenterX = item.x + item.width / 2;
                const itemCenterY = item.y + item.height / 2;

                const dx = playerScreenPos.x - itemCenterX;
                const dy = playerScreenPos.y - itemCenterY;
                const distance = Math.sqrt(dx * dx + dy * dy);

                // åˆ¤å®šç¢°æ’
                if (distance < (playerRadius + item.width / 2)) {
                    handleCollision(item);
                }
            });
        }

        // è™•ç†ç¢°æ’é‚è¼¯
        function handleCollision(item) {
            const points = parseInt(item.element.dataset.points);
            
            // æ›´æ–°åˆ†æ•¸
            score += points;
            scoreEl.innerText = score;

            // é¡¯ç¤ºç‰¹æ•ˆæ–‡å­—
            showScorePopup(points, item.x, item.y);

            // é‡ç½®è©²ç‰©å“ä½ç½® (ä½¿å…¶é‡ç”Ÿ)
            respawnItem(item);
        }

        function showScorePopup(points, x, y) {
            const popup = document.createElement('div');
            popup.classList.add('score-popup');
            popup.innerText = points > 0 ? `+${points}` : points;
            popup.style.color = points > 0 ? '#2e7d32' : '#c62828'; // ç¶ è‰²åŠ åˆ†ï¼Œç´…è‰²æ¸›åˆ†
            popup.style.left = x + 'px';
            popup.style.top = y + 'px';
            
            gameArea.appendChild(popup);

            // å‹•ç•«çµæŸå¾Œç§»é™¤
            setTimeout(() => {
                popup.remove();
            }, 1000);
        }

        function respawnItem(item) {
            // æš«æ™‚éš±è—
            item.active = false;
            item.element.style.opacity = '0';

            // éš¨æ©Ÿå»¶é²å¾Œé‡ç”Ÿ
            setTimeout(() => {
                // é‡æ–°éš¨æ©Ÿé¸æ“‡æ–‡å­—
                if (item.element.classList.contains('good-item')) {
                    item.element.innerText = goodWords[Math.floor(Math.random() * goodWords.length)];
                } else {
                    item.element.innerText = badWords[Math.floor(Math.random() * badWords.length)];
                }

                // éš¨æ©Ÿæ–°ä½ç½® (é¿å…ç›´æ¥ç”Ÿåœ¨ç©å®¶è‡‰ä¸Š)
                item.x = Math.random() * (window.innerWidth - 60);
                item.y = Math.random() * (window.innerHeight - 60);
                
                // éš¨æ©Ÿæ–°é€Ÿåº¦
                item.vx = (Math.random() - 0.5) * 5;
                item.vy = (Math.random() - 0.5) * 5;

                item.active = true;
                item.element.style.opacity = '1';
            }, 500);
        }

        // çª—å£å¤§å°æ”¹è®Šæ™‚èª¿æ•´
        window.addEventListener('resize', () => {
            // ç¢ºä¿ç‰©å“ä¸è·‘å‡ºå»
            items.forEach(item => {
                item.x = Math.min(item.x, window.innerWidth - item.width);
                item.y = Math.min(item.y, window.innerHeight - item.height);
            });
        });

    </script>
</body>
</html>
