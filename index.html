<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>舞火龍 AR 遊戲</title>
  <style>
    html, body { margin: 0; height: 100%; overflow: hidden; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Noto Sans, "Helvetica Neue", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif; }
    .bg { position: fixed; inset: 0; background: radial-gradient(1200px 800px at 20% 20%, #1b1b2f 0%, #0f0f1a 45%, #06060a 100%); z-index: 0; }
    .particles { position: fixed; inset: 0; pointer-events: none; z-index: 1; overflow: hidden; }
    .particle { position: absolute; width: 4px; height: 4px; border-radius: 9999px; background: linear-gradient(45deg, #ffcc00, #ff3366); opacity: 0.9; animation: rise 6s linear infinite; }
    @keyframes rise { 0% { transform: translateY(100vh) scale(0.5) rotate(0deg); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(-20vh) scale(1) rotate(360deg); opacity: 0; } }
    .hud { position: fixed; inset: 0; z-index: 3; display: flex; flex-direction: column; justify-content: space-between; pointer-events: none; }
    .top-bar { display: flex; justify-content: space-between; padding: 12px 16px; color: #fff; text-shadow: 0 2px 8px rgba(0,0,0,0.5); font-weight: 700; }
    .pill { background: rgba(0,0,0,0.45); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.15); border-radius: 9999px; padding: 8px 14px; font-size: 14px; }
    .title { margin: 0 auto; text-align: center; font-size: 16px; opacity: 0.9; }
    .center-msg { display: flex; justify-content: center; align-items: center; padding-bottom: 20px; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.6); font-size: 14px; }
    .controls { position: fixed; bottom: 16px; left: 0; right: 0; display: flex; justify-content: center; z-index: 4; pointer-events: auto; }
    .btn { appearance: none; background: linear-gradient(135deg, #ff3d00, #ff9500); color: #fff; border: none; border-radius: 9999px; padding: 12px 18px; font-size: 16px; font-weight: 800; cursor: pointer; box-shadow: 0 8px 24px rgba(255,72,0,0.4); transition: transform 0.12s ease, box-shadow 0.2s ease, opacity 0.2s ease; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(255,72,0,0.5); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    a-scene { z-index: 2; }
  </style>
</head>
<body>
  <div class="bg"></div>
  <div class="particles" id="particles"></div>

  <div class="hud">
    <div class="top-bar">
      <div class="pill" id="scorePill">分數：0</div>
      <div class="title">舞火龍 AR 遊戲（Hiro Marker）</div>
      <div class="pill" id="timerPill">倒數：60s</div>
    </div>
    <div class="center-msg" id="centerMsg">將 Hiro marker 置於鏡頭前，移動讓龍球撞擊字卡！</div>
  </div>

  <div class="controls">
    <button class="btn" id="startBtn">開始遊戲</button>
    <button class="btn" id="restartBtn" style="margin-left:12px; display:none;">再玩一次</button>
  </div>

  <!-- 先載 A-Frame 與 AR.js -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <!-- AR 場景 -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    renderer="logarithmicDepthBuffer: true; antialias: true; physicallyCorrectLights: true"
    arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
  >
    <a-entity camera></a-entity>
    <a-marker preset="hiro" id="hiroMarker">
      <a-entity id="dragonBall" position="0 0.05 0">
        <a-sphere radius="0.08" color="#ffcc00" metalness="0.5" roughness="0.2">
          <a-animation attribute="rotation" to="0 360 0" dur="3000" repeat="indefinite" easing="linear"></a-animation>
          <a-animation attribute="position" from="0 0.05 0" to="0 0.08 0" dur="1000" direction="alternate" repeat="indefinite" easing="ease-in-out"></a-animation>
        </a-sphere>
        <a-entity light="type: point; intensity: 0.8; distance: 1; decay: 2" position="0 0.1 0"></a-entity>
      </a-entity>
      <a-entity id="cardContainer"></a-entity>
      <a-cylinder position="0 -0.01 0" radius="0.45" height="0.005" color="#333" opacity="0.25"></a-cylinder>
    </a-marker>
    <a-entity light="type: ambient; intensity: 0.8"></a-entity>
    <a-entity light="type: directional; intensity: 0.6" position="0 1 0"></a-entity>
    <a-entity arjs-entity></a-entity>
  </a-scene>

  <!-- 你的遊戲腳本，最後載入，且等 window.load -->
  <script>
    window.addEventListener('load', function () {
      if (!window.AFRAME) {
        console.error('A-Frame 未載入，請檢查 CDN。');
        return;
      }

      // 背景粒子
      (function initParticles() {
        const container = document.getElementById('particles');
        const count = 60;
        for (let i = 0; i < count; i++) {
          const p = document.createElement('div');
          p.className = 'particle';
          const size = Math.random() * 4 + 2;
          p.style.width = size + 'px';
          p.style.height = size + 'px';
          p.style.left = Math.random() * 100 + 'vw';
          p.style.animationDelay = (Math.random() * 6) + 's';
          p.style.opacity = (Math.random() * 0.8 + 0.2).toFixed(2);
          container.appendChild(p);
        }
      })();

      let score = 0;
      let timeLeft = 60;
      let timerId = null;
      let running = false;

      const scorePill = document.getElementById('scorePill');
      const timerPill = document.getElementById('timerPill');
      const centerMsg = document.getElementById('centerMsg');
      const startBtn = document.getElementById('startBtn');
      const restartBtn = document.getElementById('restartBtn');

      const marker = document.getElementById('hiroMarker');
      const dragonBall = document.getElementById('dragonBall');
      const cardContainer = document.getElementById('cardContainer');

      const POSITIVE_WORDS = ['福', '春', '吉', '旺', '發', '喜', '年', '財'];
      const NEGATIVE_WORDS = ['X', 'No', 'Bad', 'Oops', '???', '亂'];

      function createWordCard(type = 'good') {
        const isGood = type === 'good';
        const text = isGood
          ? POSITIVE_WORDS[Math.floor(Math.random() * POSITIVE_WORDS.length)]
          : NEGATIVE_WORDS[Math.floor(Math.random() * NEGATIVE_WORDS.length)];

        const r = Math.random() * 0.35;
        const theta = Math.random() * Math.PI * 2;
        const x = Math.cos(theta) * r;
        const z = Math.sin(theta) * r;
        const y = 0.05 + Math.random() * 0.1;

        const card = document.createElement('a-entity');
        card.setAttribute('class', 'word-card');
        card.setAttribute('position', `${x} ${y} ${z}`);
        card.setAttribute('rotation', `-90 0 0`);
        card.setAttribute('data-type', isGood ? 'good' : 'bad');

        const plane = document.createElement('a-plane');
        plane.setAttribute('width', '0.16');
        plane.setAttribute('height', '0.16');
        plane.setAttribute('color', isGood ? '#b30000' : '#0040ff');
        plane.setAttribute('opacity', '0.9');
        plane.setAttribute('material', 'side: double; metalness: 0.1; roughness: 0.8;');

        const txt = document.createElement('a-text');
        txt.setAttribute('value', text);
        txt.setAttribute('align', 'center');
        txt.setAttribute('color', '#ffffff');
        txt.setAttribute('width', '1.2');
        txt.setAttribute('position', '0 0 0.01');

        const up = document.createElement('a-animation');
        up.setAttribute('attribute', 'position');
        up.setAttribute('from', `${x} ${y} ${z}`);
        up.setAttribute('to', `${x} ${y + 0.03} ${z}`);
        up.setAttribute('dur', '1200');
        up.setAttribute('direction', 'alternate');
        up.setAttribute('repeat', 'indefinite');
        up.setAttribute('easing', 'ease-in-out');

        card.appendChild(plane);
        card.appendChild(txt);
        card.appendChild(up);

        setTimeout(() => {
          if (card.parentNode) card.parentNode.removeChild(card);
        }, 15000);
        return card;
      }

      let spawnInterval = null;
      function startSpawning() {
        if (spawnInterval) clearInterval(spawnInterval);
        spawnInterval = setInterval(() => {
          if (!running) return;
          const type = Math.random() < 0.7 ? 'good' : 'bad';
          const card = createWordCard(type);
          cardContainer.appendChild(card);
        }, 1200);
      }
      function stopSpawning() {
        if (spawnInterval) clearInterval(spawnInterval);
        spawnInterval = null;
      }

      function checkCollisions() {
        if (!running) return;
        const ballWorldPos = new THREE.Vector3();
        const ballObj3D = dragonBall.object3D;
        ballObj3D.getWorldPosition(ballWorldPos);

        const cards = cardContainer.querySelectorAll('.word-card');
        cards.forEach(card => {
          const cardPos = new THREE.Vector3();
          card.object3D.getWorldPosition(cardPos);
          const dist = ballWorldPos.distanceTo(cardPos);
          if (dist < 0.12) {
            const type = card.getAttribute('data-type');
            if (type === 'good') {
              score += 10;
              flashHUD('+10 分！', '#00ff88');
            } else {
              score -= 5;
              flashHUD('-5 分', '#ff5566');
            }
            scorePill.textContent = `分數：${score}`;
            if (card.parentNode) card.parentNode.removeChild(card);
          }
        });
      }

      let flashTimeout = null;
      function flashHUD(text, color = '#fff') {
        centerMsg.textContent = text;
        centerMsg.style.color = color;
        if (flashTimeout) clearTimeout(flashTimeout);
        flashTimeout = setTimeout(() => {
          centerMsg.textContent = '將 Hiro marker 置於鏡頭前，移動讓龍球撞擊字卡！';
          centerMsg.style.color = '#fff';
        }, 800);
      }

      function startTimer() {
        timeLeft = 60;
        timerPill.textContent = `倒數：${timeLeft}s`;
        if (timerId) clearInterval(timerId);
        timerId = setInterval(() => {
          if (!running) return;
          timeLeft -= 1;
          if (timeLeft < 0) timeLeft = 0;
          timerPill.textContent = `倒數：${timeLeft}s`;
          if (timeLeft === 0) endGame();
        }, 1000);
      }

      function startGame() {
        if (running) return;
        score = 0;
        scorePill.textContent = `分數：${score}`;
        running = true;
        startBtn.disabled = true;
        restartBtn.style.display = 'none';
        flashHUD('遊戲開始！加油！', '#ffd400');
        startTimer();
        startSpawning();
      }

      function endGame() {
        running = false;
        stopSpawning();
        if (timerId) clearInterval(timerId);
        timerId = null;
        startBtn.disabled = false;
        restartBtn.style.display = 'inline-block';
        flashHUD(`時間到！最終分數：${score}`, '#00e5ff');
      }

      // 每幀碰撞檢查（此時 AFRAME 已存在）
      AFRAME.registerComponent('collision-loop', {
        tick: function () { checkCollisions(); }
      });
      document.querySelector('a-scene').setAttribute('collision-loop', '');

      marker.addEventListener('markerFound', () => {
        if (!running) centerMsg.textContent = '找到 Hiro marker！按「開始遊戲」啟動！';
      });
      marker.addEventListener('markerLost', () => {
        if (running) centerMsg.textContent = 'Marker 遺失，請回到鏡頭中…';
      });

      startBtn.addEventListener('click', startGame);
      restartBtn.addEventListener('click', () => {
        Array.from(cardContainer.querySelectorAll('.word-card')).forEach(n => n.remove());
        startGame();
      });
    });
  </script>
</body>
</html>
