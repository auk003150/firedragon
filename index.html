<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ–°æ˜¥å¤§å‘èˆç«é¾éŠæˆ² - åœ–ç‰‡ç‰ˆ</title>

  <style>
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      overflow: hidden; font-family: system-ui, -apple-system, "Microsoft YaHei", sans-serif;
      background: #000;
    }

    /* Background MP4 */
    #bg-video {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: 0;
      opacity: 0.85;
      pointer-events: none;
    }

    /* Camera background */
    #video {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
      opacity: 0.15;
      z-index: 1;
    }

    /* UI layer */
    #ui-layer {
      position: absolute; inset: 0;
      pointer-events: none;
      z-index: 10;
      overflow: hidden;
    }

    #score-board, #timer-board {
      position: absolute; top: 16px;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px 16px;
      border-radius: 14px;
      font-size: 18px;
      font-weight: 800;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.25);
      pointer-events: none;
    }
    #score-board { left: 16px; color: #ffeb3b; text-shadow: 0 0 5px #ff5722; }
    #timer-board { right: 16px; color: #fff; }

    /* Game area for bubbles */
    #game-area { position: absolute; inset: 0; z-index: 5; pointer-events: none; }

    /* Cursor (Dragon Image Container) */
    #dragon-cursor {
      position: absolute; 
      width: 180px;  /* ä½ å¯ä»¥æ ¹æ“šåœ–ç‰‡å¤§å°èª¿æ•´é€™è£¡ */
      height: 180px; /* ä½ å¯ä»¥æ ¹æ“šåœ–ç‰‡å¤§å°èª¿æ•´é€™è£¡ */
      transform: translate(-50%, -50%);
      display: none; /* éŠæˆ²é–‹å§‹æ‰é¡¯ç¤º */
      justify-content: center; align-items: center;
      z-index: 20;
      pointer-events: none;
      will-change: transform, left, top;
      transition: transform 0.1s ease-out; /* è®“ç¿»è½‰ç¨å¾®å¹³æ»‘ä¸€é» */
    }

    #dragon-cursor img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      /* å¦‚æœä½ çš„åœ–ç‰‡é è¨­æ˜¯æœå³çš„ï¼Œä¸éœ€è¦æ”¹å‹•ï¼›å¦‚æœæ˜¯æœå·¦ï¼Œå¯ä»¥é è¨­åŠ  scaleX(-1) */
      filter: drop-shadow(0 0 10px rgba(255, 160, 0, 0.6));
    }

    /* Bubbles */
    .floating-item {
      position: absolute;
      font-size: 40px;
      font-weight: 900;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 70px; height: 70px;
      border-radius: 50%;
      background-color: #fff9d1;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
      z-index: 6;
      will-change: transform, left, top;
      user-select: none;
    }
    .good-item { color: #d32f2f; border: 3px solid #d32f2f; }
    .bad-item  { color: #333;   border: 3px solid #555; }

    .score-popup {
      position: absolute;
      font-size: 34px;
      font-weight: 900;
      text-shadow: 1px 1px 0 #fff;
      animation: floatUp 0.8s ease-out forwards;
      z-index: 25;
      pointer-events: none;
    }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-60px); } }

    /* Overlays */
    .overlay-screen {
      position: absolute; inset: 0;
      background: rgba(0,0,0,0.82);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 40;
      pointer-events: auto;
      color: #fff;
      text-align: center;
      padding: 18px;
    }
    .overlay-screen button {
      pointer-events: auto;
      padding: 14px 34px;
      font-size: 20px;
      background: #d32f2f;
      color: #fff;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      margin-top: 16px;
      font-weight: 900;
      box-shadow: 0 0 15px rgba(255,82,82,0.8);
      transition: transform 0.1s;
    }
    .overlay-screen button:active { transform: scale(0.97); }

    #mute-btn {
      position: absolute; bottom: 16px; right: 16px;
      z-index: 50;
      background: rgba(255,255,255,0.5);
      border: none;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 22px;
      cursor: pointer;
      pointer-events: auto;
      user-select: none;
    }
  </style>
</head>

<body>
  <!-- Looping mp4 background -->
  <video id="bg-video" autoplay muted loop playsinline preload="auto">
    <source src="animated.mp4" type="video/mp4" />
  </video>

  <!-- Audio -->
  <audio id="bgm" loop src="bgm.mp3"></audio>
  <audio id="sfx-collect" src="Collect.mp3"></audio>
  <audio id="sfx-crunch" src="Crunch.mp3"></audio>
  <audio id="sfx-end" src="end.mp3"></audio>

  <!-- Webcam -->
  <video id="video" playsinline autoplay muted></video>

  <div id="ui-layer">
    <div id="score-board">åˆ†æ•¸: <span id="score">0</span></div>
    <div id="timer-board">æ™‚é–“: <span id="timer">60</span></div>

    <!-- REPLACED: Simple Image Cursor -->
    <div id="dragon-cursor">
      <img src="image.png" alt="Dragon Head" id="dragon-img-el">
    </div>

    <div id="game-area"></div>
    <button id="mute-btn" title="Mute/unmute">ğŸ”Š</button>

    <div id="start-screen" class="overlay-screen">
      <h1 style="color:#ffeb3b; text-shadow: 0 0 10px #ff5722; font-size: 38px; margin:0;">ğŸ”¥ å¤§å‘èˆç«é¾ ğŸ”¥</h1>
      <p style="font-size: 16px; color: #ddd; margin: 10px 0 0;">
        ç”¨ã€Œå³æ‰‹æ‰‹è…•ã€æ§åˆ¶èˆé¾ï¼<br>é¿é–‹ Emoji æ³¡æ³¡ã€‚
      </p>
      <button id="startBtn">èµ·é¾ï¼(Start)</button>
      <div id="err" style="margin-top:10px; display:none;"></div>
    </div>

    <div id="game-over-screen" class="overlay-screen" style="display:none;">
      <h1 style="margin:0 0 10px;">æ™‚é–“åˆ°ï¼</h1>
      <p style="margin:0;">æœ€çµ‚åˆ†æ•¸: <span id="final-score" style="font-size: 40px; font-weight: 900; color: #ffeb3b;">0</span></p>
      <button id="restartBtn2">å†èˆä¸€æ¬¡</button>
    </div>
  </div>

  <script type="module">
    import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

    const MODEL_URL = "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task";

    const goodWords = ['ç¦', 'æ˜¥', 'è²¡', 'å®‰', 'æ—º', 'å‰', 'ç¥¥', 'è³€', 'é¦¬', 'å¹´'];
    const badWords  = ['âš½', 'ğŸ”', 'ğŸ§', 'ğŸ§Š', 'ğŸ§¼', 'ğŸº', 'ğŸ’¡', 'ğŸ“', 'ğŸ§½', 'ğŸ§¯'];

    const GAME_SECONDS = 60;
    const GOOD_POINTS = 10;
    const BAD_POINTS  = -5;

    const SMOOTHING = 0.22;
    const COLLISION_R = 60; // Hitbox radius

    const video = document.getElementById('video');
    const bgVideo = document.getElementById('bg-video');

    const gameArea = document.getElementById('game-area');
    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    
    // Updated elements
    const dragonCursor = document.getElementById('dragon-cursor');
    const dragonImgEl = document.getElementById('dragon-img-el');

    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const finalScoreEl = document.getElementById('final-score');
    const startBtn = document.getElementById('startBtn');
    const restartBtn2 = document.getElementById('restartBtn2');
    const errEl = document.getElementById('err');

    const sounds = {
      bgm: document.getElementById('bgm'),
      collect: document.getElementById('sfx-collect'),
      crunch: document.getElementById('sfx-crunch'),
      end: document.getElementById('sfx-end')
    };
    let isMuted = false;
    let isGameRunning = false;

    sounds.bgm.volume = 0.3;
    sounds.collect.volume = 0.85;
    sounds.crunch.volume = 0.85;
    sounds.end.volume = 0.75;

    function playSound(name) {
      if (isMuted) return;
      const a = sounds[name];
      if (!a) return;
      a.currentTime = 0;
      a.play().catch(() => {});
    }
    function setMuted(m) {
      isMuted = m;
      const btn = document.getElementById('mute-btn');
      btn.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      if (isMuted) { sounds.bgm.pause(); }
      else { if (isGameRunning) sounds.bgm.play().catch(()=>{}); }
    }
    document.getElementById('mute-btn').addEventListener('click', () => setMuted(!isMuted));

    bgVideo.muted = true;

    // Game vars
    let score = 0;
    let timeLeft = GAME_SECONDS;
    let items = [];
    let timerInterval = null;

    let gameWidth = window.innerWidth;
    let gameHeight = window.innerHeight;

    let cursor = { x: -200, y: -200, visible: false };
    
    // For Direction Logic
    let prevCursorX = 0;
    let facingRight = true; // Assume image faces right by default

    let mirror = true;

    // MediaPipe
    let handLandmarker = null;
    let lastVideoTime = -1;
    let wristN = { x: 0.5, y: 0.65 };

    async function initCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "user" },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
    }

    async function initHandLandmarker() {
      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
      );
      handLandmarker = await HandLandmarker.createFromOptions(vision, {
        baseOptions: { modelAssetPath: MODEL_URL },
        runningMode: "VIDEO",
        numHands: 2,
        minHandDetectionConfidence: 0.5,
        minHandPresenceConfidence: 0.5,
        minTrackingConfidence: 0.5
      });
    }

    function updateWristFromLandmarks(result) {
      cursor.visible = false;
      if (!result || !result.landmarks || result.landmarks.length === 0) return;

      let idx = 0;
      if (result.handednesses && result.handednesses.length) {
        const rightIndex = result.handednesses.findIndex(h =>
          h && h[0] && String(h[0].categoryName).toLowerCase() === "right"
        );
        if (rightIndex >= 0) idx = rightIndex;
      }

      const lm = result.landmarks[idx];
      if (!lm || !lm[0]) return;

      let x = lm[0].x;
      let y = lm[0].y;
      if (mirror) x = 1 - x;

      wristN.x = wristN.x + (x - wristN.x) * SMOOTHING;
      wristN.y = wristN.y + (y - wristN.y) * SMOOTHING;

      cursor.x = wristN.x * gameWidth;
      cursor.y = wristN.y * gameHeight;
      cursor.visible = true;
    }

    function spawnItems(count, type) {
      for (let i = 0; i < count; i++) {
        const el = document.createElement('div');
        el.classList.add('floating-item', type === 'good' ? 'good-item' : 'bad-item');

        el.textContent = type === 'good'
          ? goodWords[Math.floor(Math.random() * goodWords.length)]
          : badWords[Math.floor(Math.random() * badWords.length)];

        el.dataset.kind = type;
        el.dataset.points = String(type === 'good' ? GOOD_POINTS : BAD_POINTS);

        gameArea.appendChild(el);

        const size = 70;
        items.push({
          element: el,
          x: Math.random() * (gameWidth - size),
          y: Math.random() * (gameHeight - size),
          vx: (Math.random() - 0.5) * 2.8,
          vy: (Math.random() - 0.5) * 2.8,
          width: size, height: size,
          active: true
        });
      }
    }

    function handleHit(item) {
      const pts = parseInt(item.element.dataset.points, 10);
      score += pts;
      scoreEl.textContent = String(score);

      if (pts > 0) playSound('collect');
      else playSound('crunch');

      const popup = document.createElement('div');
      popup.classList.add('score-popup');
      popup.textContent = pts > 0 ? `+${pts}` : String(pts);
      popup.style.color = pts > 0 ? '#2e7d32' : '#d32f2f';
      popup.style.left = item.x + 'px';
      popup.style.top = item.y + 'px';
      gameArea.appendChild(popup);
      setTimeout(() => popup.remove(), 800);

      item.active = false;
      item.element.style.opacity = '0';

      setTimeout(() => {
        if (!isGameRunning) return;
        item.active = true;
        item.element.style.opacity = '1';
        item.x = Math.random() * (gameWidth - item.width);
        item.y = Math.random() * (gameHeight - item.height);

        const kind = item.element.dataset.kind;
        item.element.textContent = kind === 'good'
          ? goodWords[Math.floor(Math.random() * goodWords.length)]
          : badWords[Math.floor(Math.random() * badWords.length)];
      }, 450);
    }

    function loop() {
      if (!isGameRunning) return;

      if (video.readyState >= 2 && handLandmarker) {
        if (video.currentTime !== lastVideoTime) {
          const res = handLandmarker.detectForVideo(video, performance.now());
          updateWristFromLandmarks(res);
          lastVideoTime = video.currentTime;
        }
      }

      // Update Cursor Image
      if (cursor.visible) {
        dragonCursor.style.display = 'flex';
        dragonCursor.style.left = cursor.x + 'px';
        dragonCursor.style.top = cursor.y + 'px';

        // --- DIRECTION LOGIC ---
        // Calculate difference (delta) from last frame
        const dx = cursor.x - prevCursorX;
        
        // Threshold to prevent jitter (e.g., must move > 2px to change direction)
        if (dx > 2) {
            facingRight = true; 
        } else if (dx < -2) {
            facingRight = false;
        }
        
        // If your original image faces RIGHT, use 1 for Right, -1 for Left.
        // If your original image faces LEFT, swap these values (-1 for Right, 1 for Left).
        const scaleX = facingRight ? 1 : -1;
        dragonImgEl.style.transform = `scaleX(${scaleX})`;

        prevCursorX = cursor.x; 

      } else {
        dragonCursor.style.display = 'none';
      }

      // Update Bubbles
      for (const item of items) {
        if (!item.active) continue;

        item.x += item.vx;
        item.y += item.vy;

        if (item.x <= 0 || item.x >= gameWidth - item.width) item.vx *= -1;
        if (item.y <= 0 || item.y >= gameHeight - item.height) item.vy *= -1;

        item.x = Math.max(0, Math.min(item.x, gameWidth - item.width));
        item.y = Math.max(0, Math.min(item.y, gameHeight - item.height));

        item.element.style.left = item.x + 'px';
        item.element.style.top = item.y + 'px';

        if (cursor.visible) {
          const cx = item.x + item.width / 2;
          const cy = item.y + item.height / 2;
          const dx = cursor.x - cx;
          const dy = cursor.y - cy;
          // Simple circle collision
          if ((dx*dx + dy*dy) < (COLLISION_R + 35) ** 2) handleHit(item);
        }
      }

      requestAnimationFrame(loop);
    }

    function startGame() {
      errEl.style.display = 'none';
      bgVideo.play().catch(()=>{});

      score = 0;
      timeLeft = GAME_SECONDS;
      scoreEl.textContent = '0';
      timerEl.textContent = String(GAME_SECONDS);

      gameArea.innerHTML = '';
      items = [];
      isGameRunning = true;

      // Reset cursor pos so it doesn't jump
      prevCursorX = gameWidth / 2;

      spawnItems(6, 'good');
      spawnItems(4, 'bad');

      startScreen.style.display = 'none';
      gameOverScreen.style.display = 'none';

      if (!isMuted) sounds.bgm.play().catch(() => {});

      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft -= 1;
        timerEl.textContent = String(timeLeft);
        if (timeLeft <= 0) endGame();
      }, 1000);

      loop();
    }

    function endGame() {
      isGameRunning = false;
      clearInterval(timerInterval);
      timerInterval = null;

      sounds.bgm.pause();
      sounds.bgm.currentTime = 0;
      playSound('end');

      finalScoreEl.textContent = String(score);
      gameOverScreen.style.display = 'flex';
    }

    window.addEventListener('resize', () => {
      gameWidth = window.innerWidth;
      gameHeight = window.innerHeight;
    });

    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      try {
        await initCamera();
        await initHandLandmarker();
        startGame();
      } catch (e) {
        errEl.style.display = 'block';
        errEl.textContent = String(e && e.message ? e.message : e);
      } finally {
        startBtn.disabled = false;
      }
    });

    restartBtn2.addEventListener('click', () => startGame());
  </script>
</body>
</html>

