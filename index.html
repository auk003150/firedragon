<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>AR æŠ“å¯¶éŠæˆ² - ä¿®æ­£ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  
  <!-- 1. è¼‰å…¥ A-Frame èˆ‡ AR.js -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <!-- 2. è¨»å†Šçµ„ä»¶ -->
  <script>
    // å…¨åŸŸè®Šæ•¸
    window.gameScore = 0;

    AFRAME.registerComponent('floating-item', {
      schema: {
        type: { type: 'string', default: 'good' }, 
        value: { type: 'string', default: '' }
      },
      init: function() {
        this.isHit = false;
        
        // åˆå§‹ä½ç½®ï¼šéš¨æ©Ÿåˆ†ä½ˆåœ¨ç›¸æ©Ÿå‰æ–¹é è™•
        // X: -2 ~ 2, Y: -1.5 ~ 1.5, Z: -5 ~ -3
        const startX = (Math.random() - 0.5) * 4;
        const startY = (Math.random() - 0.5) * 3;
        const startZ = -3 - (Math.random() * 2); 
        
        this.el.setAttribute('position', `${startX} ${startY} ${startZ}`);
        
        // ç§»å‹•é€Ÿåº¦ï¼šæ…¢æ…¢é£„å‘ç›¸æ©Ÿ (Z è»¸å¢åŠ )
        this.speedZ = 0.02 + Math.random() * 0.02;
        
        // æš«å­˜è®Šæ•¸ (é¿å…åœ¨ tick ä¸­é‡è¤‡å®£å‘Š)
        this.playerPos = new THREE.Vector3();
        this.myPos = new THREE.Vector3();
      },
      
      tick: function() {
        if (this.isHit) return;

        // --- 1. ç¢ºä¿æŠ“å¾—åˆ°ç©å®¶ç‰©ä»¶ (Lazy Load) ---
        if (!this.playerCollider) {
            this.playerCollider = document.querySelector('#player-collider');
            this.playerMarker = document.querySelector('#player-marker');
            this.camera = document.querySelector('[camera]');
            return; // é€™ä¸€å¹€å…ˆè·³éï¼Œä¸‹ä¸€å¹€å†ç®—
        }

        // --- 2. ç§»å‹•é‚è¼¯ ---
        const pos = this.el.getAttribute('position');
        pos.z += this.speedZ; // å¾€ç›¸æ©Ÿæ–¹å‘ç§»å‹•
        this.el.setAttribute('position', pos);

        // é¢å‘ç›¸æ©Ÿ (Billboard)
        if (this.camera) {
            this.el.object3D.lookAt(this.camera.object3D.position);
        }

        // è¶…å‡ºè¢å¹•ç§»é™¤ (å¤ªé è¿‘ç›¸æ©Ÿ)
        if (pos.z > 1.5) {
          if (this.el.parentNode) this.el.parentNode.removeChild(this.el);
          return;
        }

        // --- 3. ç¢°æ’åµæ¸¬æ ¸å¿ƒé‚è¼¯ ---
        
        // åªæœ‰ç•¶ Hiro Marker è¢«åµæ¸¬åˆ° (å¯è¦‹) æ™‚æ‰è¨ˆç®—ç¢°æ’
        if (this.playerMarker.object3D.visible) {
            
            // å¼·åˆ¶æ›´æ–°ä¸–ç•ŒçŸ©é™£ï¼Œç¢ºä¿åº§æ¨™æ˜¯æœ€æ–°çš„
            this.playerCollider.object3D.updateMatrixWorld();
            this.el.object3D.updateMatrixWorld();

            // å–å¾—ä¸–ç•Œåº§æ¨™
            this.playerCollider.object3D.getWorldPosition(this.playerPos);
            this.el.object3D.getWorldPosition(this.myPos);

            // è¨ˆç®—è·é›¢
            const distance = this.playerPos.distanceTo(this.myPos);

            // è·é›¢å°æ–¼ 0.6 å…¬å°ºè¦–ç‚ºç¢°æ’
            if (distance < 0.6) {
                console.log("ç¢°æ’æˆåŠŸï¼è·é›¢:", distance);
                this.handleCollision();
            }
        }
      },

      handleCollision: function() {
        this.isHit = true;
        
        // æ›´æ–°åˆ†æ•¸
        const points = this.data.type === 'good' ? 15 : -5;
        if (window.updateGameScore) {
            window.updateGameScore(points);
        }

        // æ’­æ”¾éŸ³æ•ˆ (é¸ç”¨ï¼Œé€™è£¡ç”¨è¦–è¦ºä»£æ›¿)
        
        // ç¸®å°æ¶ˆå¤±å‹•ç•«
        this.el.setAttribute('animation', {
          property: 'scale',
          to: '0 0 0',
          dur: 150,
          easing: 'easeInQuad'
        });

        // ç§»é™¤å…ƒç´ 
        setTimeout(() => {
          if (this.el.parentNode) {
            this.el.parentNode.removeChild(this.el);
          }
        }, 150);
      }
    });
  </script>

  <style>
    body { margin: 0; overflow: hidden; font-family: 'Microsoft JhengHei', sans-serif; }
    
    /* UI å±¤ */
    #ui-layer {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 100;
      display: flex; flex-direction: column; justify-content: space-between;
    }
    
    .header { padding: 20px; display: flex; align-items: center; }
    
    .score-container {
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid #f1c40f;
      border-radius: 50px;
      padding: 10px 30px;
      color: white;
      font-size: 24px;
      font-weight: bold;
      display: flex; align-items: center; gap: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .score-popup {
      position: absolute;
      top: 80px; left: 50px;
      font-size: 48px;
      font-weight: 900;
      opacity: 0;
      transition: all 0.4s ease-out;
      text-shadow: 2px 2px 0 #000;
    }

    .footer {
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      color: white;
      text-align: center;
      padding: 30px 20px;
      font-size: 16px;
      text-shadow: 1px 1px 2px black;
    }
    
    .marker-hint {
      color: #f1c40f; font-weight: bold;
      animation: blink 2s infinite;
    }
    
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
  </style>
</head>
<body>

  <!-- UI -->
  <div id="ui-layer">
    <div class="header">
      <div class="score-container">
        <span>ğŸ† åˆ†æ•¸:</span>
        <span id="score-val">0</span>
      </div>
      <div id="score-anim" class="score-popup">+15</div>
    </div>
    
    <div class="footer">
      è«‹å°‡ <span class="marker-hint">Hiro Marker</span> å°æº–é¡é ­<br>
      ç§»å‹•æ¨™è¨˜å»è§¸ç¢°é£„éä¾†çš„å­—ï¼
    </div>
  </div>

  <!-- A-Frame å ´æ™¯ -->
  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true;"
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono;"
  >
    
    <!-- ç©å®¶ (Hiro Marker) -->
    <!-- æ³¨æ„ï¼šç©å®¶çš„ç¢°æ’é«” (Collider) æ˜¯ Marker çš„å­ç‰©ä»¶ -->
    <a-marker preset="hiro" id="player-marker">
      <a-entity id="player-collider">
        <!-- é€™æ˜¯è¦–è¦ºä¸Šçš„ç¶²å­/æ•æ‰å™¨ -->
        <a-ring radius-inner="0.25" radius-outer="0.3" color="#f1c40f" rotation="-90 0 0" material="side: double"></a-ring>
        <a-cone radius-bottom="0.25" radius-top="0" height="0.4" color="#f1c40f" opacity="0.2" rotation="0 0 0" position="0 0 0"></a-cone>
        <!-- ä¸­å¿ƒé»ç´…çƒï¼Œæ–¹ä¾¿å°æº– -->
        <a-sphere radius="0.05" color="red" position="0 0 0"></a-sphere>
      </a-entity>
    </a-marker>

    <!-- ç›¸æ©Ÿ -->
    <a-entity camera id="camera-rig"></a-entity>

  </a-scene>

  <!-- éŠæˆ²é‚è¼¯ -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const GOOD_WORDS = ['ç¦', 'æ˜¥', 'è²¡', 'å‰', 'ç¥¥', 'æ—º', 'è³€', 'å–œ'];
        const BAD_WORDS = ['è¡°', 'çª®', 'è‹¦', 'æ‚¶', 'ç—…', 'ç´¯', 'å¿™', 'äº‚'];
        // ä¹Ÿå¯ä»¥æ›æˆ emoji: ['ğŸ’©', 'ğŸ’£', 'ğŸ']
        
        const scoreEl = document.getElementById('score-val');
        const scoreAnimEl = document.getElementById('score-anim');
        const cameraRig = document.querySelector('#camera-rig');

        // æ›´æ–°åˆ†æ•¸ UI
        window.updateGameScore = function(points) {
            window.gameScore += points;
            scoreEl.innerText = window.gameScore;

            // å½ˆå‡ºå‹•ç•«
            scoreAnimEl.innerText = points > 0 ? `+${points}` : points;
            scoreAnimEl.style.color = points > 0 ? '#2ecc71' : '#e74c3c';
            
            // é‡ç½®å‹•ç•«
            scoreAnimEl.style.opacity = '0';
            scoreAnimEl.style.transform = 'translateY(0) scale(0.5)';
            
            // å¼·åˆ¶é‡ç¹ª (Reflow) ä»¥è§¸ç™¼ CSS transition
            void scoreAnimEl.offsetWidth; 

            scoreAnimEl.style.opacity = '1';
            scoreAnimEl.style.transform = 'translateY(-30px) scale(1.2)';
            
            setTimeout(() => {
                scoreAnimEl.style.opacity = '0';
            }, 800);
        };

        // ç”¢ç”Ÿæ–‡å­—è²¼åœ– (Canvas)
        function createTextTexture(text, isBad) {
            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');

            // èƒŒæ™¯åœ“
            ctx.beginPath();
            ctx.arc(128, 128, 110, 0, 2 * Math.PI);
            ctx.fillStyle = isBad ? 'rgba(50, 50, 50, 0.9)' : 'rgba(200, 0, 0, 0.9)';
            ctx.fill();
            
            // é‚Šæ¡†
            ctx.lineWidth = 15;
            ctx.strokeStyle = isBad ? '#95a5a6' : '#f1c40f';
            ctx.stroke();

            // æ–‡å­—
            ctx.font = 'bold 130px "Microsoft JhengHei", Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillStyle = 'white';
            ctx.fillText(text, 128, 135);

            return canvas.toDataURL();
        }

        // éŠæˆ²è¿´åœˆï¼šå®šæ™‚ç”Ÿæˆç‰©ä»¶
        setInterval(() => {
            const isGood = Math.random() > 0.3; // 70% æ©Ÿç‡æ˜¯å¥½å­—
            const dataSet = isGood ? GOOD_WORDS : BAD_WORDS;
            const text = dataSet[Math.floor(Math.random() * dataSet.length)];
            
            const el = document.createElement('a-plane');
            
            // è¨­å®šæè³ª
            el.setAttribute('material', {
                src: createTextTexture(text, !isGood),
                transparent: true,
                opacity: 1,
                shader: 'flat',
                side: 'double'
            });

            // å¤§å°
            el.setAttribute('width', '0.8');
            el.setAttribute('height', '0.8');
            
            // ç¶å®šçµ„ä»¶
            el.setAttribute('floating-item', {
                type: isGood ? 'good' : 'bad',
                value: text
            });

            // å°‡ç‰©ä»¶æ›è¼‰åˆ°å ´æ™¯ (æ³¨æ„ï¼šä¸æ˜¯æ›åœ¨ Marker ä¸‹ï¼Œè€Œæ˜¯æ›åœ¨ Camera æˆ– Scene ä¸‹)
            // é€™è£¡æ›åœ¨ Camera ä¸‹ï¼Œè®“å®ƒç›¸å°æ–¼ç©å®¶è¦–é‡ç”Ÿæˆ
            cameraRig.appendChild(el);

        }, 1200); // æ¯ 1.2 ç§’ç”Ÿæˆä¸€å€‹
    });
  </script>
</body>
</html>
