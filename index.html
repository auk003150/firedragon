<!doctype html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ–°æ˜¥å¤§å‘èˆç«é¾éŠæˆ² (Mixed Version)</title>

  <style>
    html, body {
      margin: 0; padding: 0; width: 100%; height: 100%;
      overflow: hidden; font-family: system-ui, -apple-system, "Microsoft YaHei", sans-serif;
      background: #000;
    }

    /* Background MP4 */
    #bg-video {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      z-index: 0;
      opacity: 0.85;
      pointer-events: none;
    }

    /* Camera background */
    #video {
      position: absolute; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      transform: scaleX(-1);
      opacity: 0.15;
      z-index: 1;
    }

    /* UI layer */
    #ui-layer {
      position: absolute; inset: 0;
      pointer-events: none;
      z-index: 10;
      overflow: hidden;
    }

    #score-board, #timer-board {
      position: absolute; top: 16px;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px 16px;
      border-radius: 14px;
      font-size: 18px;
      font-weight: 800;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.25);
      pointer-events: none;
    }
    #score-board { left: 16px; color: #ffeb3b; text-shadow: 0 0 5px #ff5722; }
    #timer-board { right: 16px; color: #fff; }

    /* Game area for bubbles */
    #game-area { position: absolute; inset: 0; z-index: 5; pointer-events: none; }

    /* Cursor (Dragon Head) Container */
    #aim-cursor {
      position: absolute; 
      width: 140px; height: 140px; 
      top: 0; left: 0;
      display: none;
      justify-content: center; align-items: center;
      z-index: 20;
      pointer-events: none;
      will-change: transform;
    }

    .dragon-head-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 0 15px rgba(255, 61, 0, 0.6));
      animation: float-head 2s ease-in-out infinite;
    }

    /* Dragon Body Segment Container */
    .dragon-body-segment {
      position: absolute; 
      width: 90px; height: 90px;
      top: 0; left: 0; 
      display: none; z-index: 15;
      will-change: transform;
      pointer-events: none;
    }

    .dragon-body-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 0 8px rgba(255, 100, 0, 0.4));
    }

    @keyframes float-head { 
      0%, 100% { transform: translateY(0); } 
      50% { transform: translateY(-8px); } 
    }

    /* Bubbles */
    .floating-item {
      position: absolute;
      font-size: 24px;
      font-weight: 900;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      line-height: 1.1;
      width: 80px; height: 80px;
      border-radius: 50%;
      background-color: #fff9d1;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
      z-index: 6;
      will-change: transform;
      top: 0; left: 0;
      user-select: none;
      overflow: hidden; 
      white-space: nowrap;
    }
    
    .item-img {
      width: 85%;
      height: 85%;
      object-fit: contain;
      pointer-events: none;
    }

    .good-item { border: 3px solid #d32f2f; color: #d32f2f; }
    .bad-item  { color: #333; border: 3px solid #555; font-size: 38px; }

    .score-popup {
      position: absolute;
      font-size: 34px;
      font-weight: 900;
      text-shadow: 1px 1px 0 #fff;
      animation: floatUp 0.8s ease-out forwards;
      z-index: 25;
      pointer-events: none;
    }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-60px); } }

    /* Overlays */
    .overlay-screen {
      position: absolute; inset: 0;
      background: rgba(0,0,0,0.82);
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      z-index: 40;
      pointer-events: auto;
      color: #fff;
      text-align: center;
      padding: 18px;
    }
    .overlay-screen button {
      pointer-events: auto;
      padding: 14px 34px;
      font-size: 20px;
      background: #d32f2f;
      color: #fff;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      margin-top: 16px;
      font-weight: 900;
      box-shadow: 0 0 15px rgba(255,82,82,0.8);
      transition: transform 0.1s;
    }
    .overlay-screen button:active { transform: scale(0.97); }

    #mute-btn {
      position: absolute; bottom: 16px; right: 16px;
      z-index: 50;
      background: rgba(255,255,255,0.5);
      border: none;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 22px;
      cursor: pointer;
      pointer-events: auto;
      user-select: none;
    }
  </style>
</head>

<body>
  <video id="bg-video" autoplay muted loop playsinline preload="auto">
    <source src="animated.mp4" type="video/mp4" />
  </video>

  <audio id="bgm" loop src="bgm.mp3"></audio>
  <audio id="sfx-collect" src="Collect.mp3"></audio>
  <audio id="sfx-crunch" src="Crunch.mp3"></audio>
  <audio id="sfx-end" src="end.mp3"></audio>

  <video id="video" playsinline autoplay muted></video>

  <div id="ui-layer">
    <div id="score-board">åˆ†æ•¸: <span id="score">0</span></div>
    <div id="timer-board">æ™‚é–“: <span id="timer">60</span></div>

    <div id="dragon-body-container"></div>

    <div id="aim-cursor">
        <img src="head.png" alt="Dragon Head" class="dragon-head-img" />
    </div>

    <div id="game-area"></div>
    <button id="mute-btn" title="Mute/unmute">ğŸ”Š</button>

    <div id="start-screen" class="overlay-screen">
      <h1 style="color:#ffeb3b; text-shadow: 0 0 10px #ff5722; font-size: 38px; margin:0;">ğŸ”¥ å¤§å‘èˆç«é¾ ğŸ”¥</h1>
      <p style="font-size: 16px; color: #ddd; margin: 10px 0 0;">
        ç”¨ã€Œå³æ‰‹æ‰‹è…•ã€æ§åˆ¶é¾é ­æ”¶é›†ç¾é£Ÿèˆ‡ç¥ç¦ï¼<br>ç„¡éœ€å°‡æ‰‹ç§»è‡³ç•«é¢é‚Šç·£å³å¯åˆ°é”è§’è½ã€‚
      </p>
      <button id="startBtn">èµ·é¾ï¼(Start)</button>
      <div id="err" style="margin-top:10px; display:none;"></div>
    </div>

    <div id="game-over-screen" class="overlay-screen" style="display:none;">
      <h1 style="margin:0 0 10px;">æ™‚é–“åˆ°ï¼</h1>
      <p style="margin:0;">æœ€çµ‚åˆ†æ•¸: <span id="final-score" style="font-size: 40px; font-weight: 900; color: #ffeb3b;">0</span></p>
      <button id="restartBtn2">å†èˆä¸€æ¬¡</button>
    </div>
  </div>

  <script type="module">
    import { FilesetResolver, HandLandmarker } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest";

    const MODEL_URL = "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task";

    // --- CONFIGURATION ---
    
    // 1. Text Words
    const goodWords = ['ç¦', 'æ˜¥', 'è²¡', 'å®‰', 'å‰', 'ç¥¥', 'è³€', 'é¦¬'];
    // 2. Image Files
    const goodImages = ['egg-tart.png', 'buns.png', 'tea.png', 'food.png'];
    // 3. Bad Items
    const badWords  = ['âš½', 'ğŸ”', 'ğŸ§', 'ğŸ§Š', 'ğŸ§¼', 'ğŸº', 'ğŸ’¡', 'ğŸ“', 'ğŸ§½', 'ğŸ§¯'];

    const GAME_SECONDS = 60;
    const GOOD_POINTS = 10;
    const BAD_POINTS  = -5;
    const SMOOTHING = 0.22;

    const HEAD_R = 60;
    const ITEM_R = 40; 
    const CAM_MARGIN = 0.12; 

    const bodySegmentCount = 4;
    const bodySpacing = 50;

    const video = document.getElementById('video');
    const bgVideo = document.getElementById('bg-video');

    const gameArea = document.getElementById('game-area');
    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const aimCursor = document.getElementById('aim-cursor');
    const dragonBodyContainer = document.getElementById('dragon-body-container');

    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const finalScoreEl = document.getElementById('final-score');
    const startBtn = document.getElementById('startBtn');
    const restartBtn2 = document.getElementById('restartBtn2');
    const errEl = document.getElementById('err');

    const sounds = {
      bgm: document.getElementById('bgm'),
      collect: document.getElementById('sfx-collect'),
      crunch: document.getElementById('sfx-crunch'),
      end: document.getElementById('sfx-end')
    };
    let isMuted = false;
    let isGameRunning = false;

    sounds.bgm.volume = 0.3;
    sounds.collect.volume = 0.85;
    sounds.crunch.volume = 0.85;
    sounds.end.volume = 0.75;

    function playSound(name) {
      if (isMuted) return;
      const a = sounds[name];
      if (!a) return;
      a.currentTime = 0;
      a.play().catch(() => {});
    }
    function setMuted(m) {
      isMuted = m;
      const btn = document.getElementById('mute-btn');
      btn.textContent = isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
      if (isMuted) { sounds.bgm.pause(); }
      else { if (isGameRunning) sounds.bgm.play().catch(()=>{}); }
    }
    document.getElementById('mute-btn').addEventListener('click', () => setMuted(!isMuted));
    bgVideo.muted = true;

    // Game vars
    let score = 0;
    let timeLeft = GAME_SECONDS;
    let items = [];
    let timerInterval = null;
    let gameWidth = window.innerWidth;
    let gameHeight = window.innerHeight;
    let cursor = { x: -100, y: -100, visible: false };
    let mirror = true;

    const bodySegments = [];
    const bodyPositions = [];

    function buildBodySegment() {
      const wrapper = document.createElement('div');
      wrapper.classList.add('dragon-body-segment');
      
      const img = document.createElement('img');
      img.src = 'body.png';
      img.classList.add('dragon-body-img');
      img.alt = 'body';
      
      wrapper.appendChild(img);
      return wrapper;
    }

    function initDragonBody() {
      dragonBodyContainer.innerHTML = '';
      bodySegments.length = 0;
      bodyPositions.length = 0;

      for (let i = 0; i < bodySegmentCount; i++) {
        const el = buildBodySegment();
        const scale = 1.0 - (i * 0.1); 
        el.dataset.baseScale = scale.toFixed(2);
        
        dragonBodyContainer.appendChild(el);
        bodySegments.push(el);
        bodyPositions.push({ x: -200, y: -200, a: 0 });
      }
    }

    function updateDragonBody(headX, headY) {
      let targetX = headX;
      let targetY = headY;

      for (let i = 0; i < bodySegments.length; i++) {
        const segment = bodySegments[i];
        const currentPos = bodyPositions[i];

        const dx = targetX - currentPos.x;
        const dy = targetY - currentPos.y;
        const d = Math.sqrt(dx*dx + dy*dy);
        const angle = Math.atan2(dy, dx);

        if (d > bodySpacing) {
          const moveDist = d - bodySpacing;
          currentPos.x += Math.cos(angle) * moveDist * 0.55;
          currentPos.y += Math.sin(angle) * moveDist * 0.55;
        }

        const prevA = currentPos.a || angle;
        let da = angle - prevA;
        if (da > Math.PI) da -= Math.PI * 2;
        if (da < -Math.PI) da += Math.PI * 2;
        currentPos.a = prevA + da * 0.25;

        segment.style.display = 'block';
        
        const baseScale = parseFloat(segment.dataset.baseScale || '1');
        const deg = (currentPos.a * 180 / Math.PI); 

        segment.style.transform = `translate3d(${currentPos.x}px, ${currentPos.y}px, 0) translate(-50%, -50%) rotate(${deg}deg) scale(${baseScale})`;

        targetX = currentPos.x;
        targetY = currentPos.y;
      }
    }

    // MediaPipe
    let handLandmarker = null;
    let lastVideoTime = -1;
    let wristN = { x: 0.5, y: 0.65 };
    
    let lastLandmarkTime = 0;
    const LANDMARK_INTERVAL = 50; 

    async function initCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { 
          facingMode: "user",
          width: { ideal: 640 },
          height: { ideal: 480 }
        },
        audio: false
      });
      video.srcObject = stream;
      await video.play();
    }

    async function initHandLandmarker() {
      const vision = await FilesetResolver.forVisionTasks(
        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
      );
      handLandmarker = await HandLandmarker.createFromOptions(vision, {
        baseOptions: { modelAssetPath: MODEL_URL },
        runningMode: "VIDEO",
        numHands: 2,
        minHandDetectionConfidence: 0.5,
        minHandPresenceConfidence: 0.5,
        minTrackingConfidence: 0.5
      }); 
    }

    function updateWristFromLandmarks(result) {
      cursor.visible = false;
      if (!result || !result.landmarks || result.landmarks.length === 0) return;

      let idx = 0;
      if (result.handednesses && result.handednesses.length) {
        const rightIndex = result.handednesses.findIndex(h =>
          h && h[0] && String(h[0].categoryName).toLowerCase() === "right"
        );
        if (rightIndex >= 0) idx = rightIndex;
      }

      const lm = result.landmarks[idx];
      if (!lm || !lm[0]) return;

      let x = lm[0].x;
      let y = lm[0].y;
      if (mirror) x = 1 - x;

      let xMapped = (x - CAM_MARGIN) / (1 - 2 * CAM_MARGIN);
      let yMapped = (y - CAM_MARGIN) / (1 - 2 * CAM_MARGIN);

      xMapped = Math.max(0, Math.min(1, xMapped));
      yMapped = Math.max(0, Math.min(1, yMapped));

      wristN.x = wristN.x + (xMapped - wristN.x) * SMOOTHING;
      wristN.y = wristN.y + (yMapped - wristN.y) * SMOOTHING;

      cursor.x = wristN.x * gameWidth;
      cursor.y = wristN.y * gameHeight;
      cursor.visible = true;
    }

    // --- NEW: CONTENT HELPER ---
    // Randomly sets the bubble content to either a Word or an Image
    function setBubbleContent(el, type) {
        el.innerHTML = ''; // Clear existing
        el.dataset.kind = type;

        if (type === 'good') {
            // 50% chance for Text, 50% chance for Image
            if (Math.random() < 0.5) {
                // Show Text
                const txt = goodWords[Math.floor(Math.random() * goodWords.length)];
                el.textContent = txt;
                if (txt.length > 2) el.style.fontSize = '20px';
                else el.style.fontSize = '24px';
            } else {
                // Show Image
                const imgFile = goodImages[Math.floor(Math.random() * goodImages.length)];
                const img = document.createElement('img');
                img.src = imgFile;
                img.classList.add('item-img');
                el.appendChild(img);
            }
        } else {
            // Bad Items: Always emojis
            const txt = badWords[Math.floor(Math.random() * badWords.length)];
            el.textContent = txt;
            el.style.fontSize = '38px';
        }
    }

    function spawnItems(count, type) {
      for (let i = 0; i < count; i++) {
        const el = document.createElement('div');
        el.classList.add('floating-item', type === 'good' ? 'good-item' : 'bad-item');
        
        // Use helper to set content
        setBubbleContent(el, type);

        el.dataset.points = String(type === 'good' ? GOOD_POINTS : BAD_POINTS);
        gameArea.appendChild(el);

        const size = 80;
        items.push({
          element: el,
          x: Math.random() * (gameWidth - size),
          y: Math.random() * (gameHeight - size),
          vx: (Math.random() - 0.5) * 2.8,
          vy: (Math.random() - 0.5) * 2.8,
          width: size, height: size,
          active: true
        });
      }
    }

    function recycleItem(item) {
        if (!isGameRunning) return;
        item.active = true;
        item.element.style.opacity = '1';
        item.x = Math.random() * (gameWidth - item.width);
        item.y = Math.random() * (gameHeight - item.height);
        
        const type = item.element.dataset.kind; // 'good' or 'bad'
        setBubbleContent(item.element, type);
    }

    function handleHit(item) {
      const pts = parseInt(item.element.dataset.points, 10);
      score += pts;
      scoreEl.textContent = String(score);

      if (pts > 0) playSound('collect');
      else playSound('crunch');

      const popup = document.createElement('div');
      popup.classList.add('score-popup');
      popup.textContent = pts > 0 ? `+${pts}` : String(pts);
      popup.style.color = pts > 0 ? '#2e7d32' : '#d32f2f';
      popup.style.left = item.x + 'px';
      popup.style.top = item.y + 'px';
      gameArea.appendChild(popup);
      setTimeout(() => popup.remove(), 800);

      item.active = false;
      item.element.style.opacity = '0';

      setTimeout(() => {
        recycleItem(item);
      }, 450);
    }

    function loop() {
      if (!isGameRunning) return;

      const now = performance.now();
      if (now - lastLandmarkTime > LANDMARK_INTERVAL && video.readyState >= 2 && handLandmarker) {
        if (video.currentTime !== lastVideoTime) {
          const res = handLandmarker.detectForVideo(video, now);
          updateWristFromLandmarks(res);
          lastVideoTime = video.currentTime;
          lastLandmarkTime = now;
        }
      }

      if (cursor.visible) {
        aimCursor.style.display = 'flex';
        aimCursor.style.transform = `translate3d(${cursor.x}px, ${cursor.y}px, 0) translate(-50%, -50%)`;
        updateDragonBody(cursor.x, cursor.y);
      } else {
        aimCursor.style.display = 'none';
        bodySegments.forEach(seg => seg.style.display = 'none');
      }

      for (const item of items) {
        if (!item.active) continue;

        item.x += item.vx;
        item.y += item.vy;

        if (item.x <= 0 || item.x >= gameWidth - item.width) item.vx *= -1;
        if (item.y <= 0 || item.y >= gameHeight - item.height) item.vy *= -1;

        item.x = Math.max(0, Math.min(item.x, gameWidth - item.width));
        item.y = Math.max(0, Math.min(item.y, gameHeight - item.height));

        item.element.style.transform = `translate3d(${item.x}px, ${item.y}px, 0)`;

        if (cursor.visible) {
          const cx = item.x + item.width / 2;
          const cy = item.y + item.height / 2;
          const dx = cursor.x - cx;
          const dy = cursor.y - cy;
          if ((dx*dx + dy*dy) < (HEAD_R + ITEM_R) ** 2) handleHit(item);
        }
      }
      requestAnimationFrame(loop);
    }

    function startGame() {
      errEl.style.display = 'none';
      bgVideo.play().catch(()=>{});

      score = 0;
      timeLeft = GAME_SECONDS;
      scoreEl.textContent = '0';
      timerEl.textContent = String(GAME_SECONDS);

      gameArea.innerHTML = '';
      items = [];
      isGameRunning = true;

      initDragonBody();
      spawnItems(6, 'good'); // Random mix of words and images
      spawnItems(4, 'bad'); 

      startScreen.style.display = 'none';
      gameOverScreen.style.display = 'none';

      if (!isMuted) sounds.bgm.play().catch(() => {});

      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft -= 1;
        timerEl.textContent = String(timeLeft);
        if (timeLeft <= 0) endGame();
      }, 1000);

      loop();
    }

    function endGame() {
      isGameRunning = false;
      clearInterval(timerInterval);
      timerInterval = null;
      sounds.bgm.pause();
      sounds.bgm.currentTime = 0;
      playSound('end');
      finalScoreEl.textContent = String(score);
      gameOverScreen.style.display = 'flex';
    }

    window.addEventListener('resize', () => {
      gameWidth = window.innerWidth;
      gameHeight = window.innerHeight;
    });

    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      try {
        await initCamera();
        await initHandLandmarker();
        startGame();
      } catch (e) {
        errEl.style.display = 'block';
        errEl.textContent = String(e && e.message ? e.message : e);
      } finally {
        startBtn.disabled = false;
      }
    });

    restartBtn2.addEventListener('click', () => startGame());
  </script>
</body>
</html>
