<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <title>å¤§å‘èˆç«é¾ï¼ˆç„¡é¡é ­ç‰ˆï¼ŒHiro Marker ç‹€æ…‹é¡¯ç¤ºï¼‰</title>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: #000; color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans HK", "PingFang HK", "Heiti TC", Arial, sans-serif;
      overflow: hidden; -webkit-font-smoothing: antialiased;
    }
    .wrap { position: relative; width: 100%; height: 100%; background: #000; }

    canvas#game {
      position: absolute; inset: 0; width: 100%; height: 100%;
      touch-action: none; z-index: 1;
    }

    /* UI */
    .ui {
      position: absolute; left: 0; right: 0; top: 0;
      display: grid; gap: 6px; padding: 10px 12px;
      background: linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0));
      user-select: none; z-index: 5;
    }
    .topbar { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .top-left { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .spacer { flex: 1; }
    .btn {
      background: #e11d48; border: none; color: #fff;
      border-radius: 10px; padding: 10px 14px; font-weight: 700; letter-spacing: 0.4px;
      box-shadow: 0 4px 12px rgba(225,29,72,0.35); cursor: pointer;
    }
    .btn.secondary { background:#334155; box-shadow: 0 4px 12px rgba(15,23,42,0.35); }
    .btn.ghost {
      background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.2);
      color: #fff; box-shadow: none;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn:active { transform: translateY(1px); }

    .hudbar { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .chip {
      background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.2);
      border-radius: 999px; padding: 6px 10px; font-size: 14px; font-weight: 700;
      text-shadow: 0 2px 6px rgba(0,0,0,0.6);
    }

    /* Marker status pill */
    .status {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 999px; padding: 8px 12px;
      font-weight: 700; font-size: 14px; line-height: 1;
      color: #e5e7eb;
    }
    .status-dot {
      width: 10px; height: 10px; border-radius: 999px;
      background: #f97316;
      box-shadow: 0 0 0 4px rgba(249,115,22,0.18);
    }
    .status.ok { border-color: rgba(34,197,94,0.35); color: #dcfce7; }
    .status.ok .status-dot { background: #22c55e; box-shadow: 0 0 0 4px rgba(34,197,94,0.18); }

    .hint {
      position: absolute; left: 0; right: 0; top: 50%; transform: translateY(-50%);
      text-align: center; padding: 0 16px; color: #ffd166; font-weight: 700;
      text-shadow: 0 2px 10px rgba(0,0,0,0.7); z-index: 3;
    }
    .ok { color: #22c55e; }
    .bad { color: #f97316; }

    /* Panel */
    .panel-backdrop {
      position: absolute; inset: 0; background: rgba(0,0,0,0.45); z-index: 20;
      opacity: 0; pointer-events: none; transition: opacity .2s ease;
    }
    .panel-backdrop.open { opacity: 1; pointer-events: auto; }
    .panel {
      position: absolute; top: 0; right: 0; height: 100%;
      background: rgba(17,24,39,0.9); backdrop-filter: blur(10px);
      border-left: 1px solid rgba(255,255,255,0.12);
      width: min(420px, 92vw);
      transform: translateX(100%);
      transition: transform .25s ease;
      z-index: 21; color: #fff; overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .panel.open { transform: translateX(0); }
    .panel header {
      position: sticky; top: 0; background: rgba(17,24,39,0.95);
      padding: 12px; display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .panel h2 { margin: 0; font-size: 16px; }
    .section { padding: 12px; display: grid; gap: 12px; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .label { font-size: 14px; color: #e5e7eb; }
    .controls { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .mini {
      padding: 8px 10px; font-weight: 600; font-size: 12px; border-radius: 8px;
      background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.2); color: #fff;
      cursor: pointer;
    }
    .danger { background: #7f1d1d; border-color: rgba(255,255,255,0.25); }
    input[type="range"] { width: 180px; }
    .sliderRow { display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
    .val { font-variant-numeric: tabular-nums; color: #fcd34d; min-width: 40px; text-align: right; }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Canvas -->
    <canvas id="game"></canvas>

    <!-- UI -->
    <div class="ui">
      <div class="topbar">
        <div class="top-left">
          <button id="startBtn" class="btn">é–‹å§‹</button>
          <div id="markerStatus" class="status" title="Hiro Marker åµæ¸¬ç‹€æ…‹">
            <span class="status-dot"></span>
            <span class="status-text">Markerï¼šæœªåµæ¸¬</span>
          </div>
          <button id="toggleMarkerBtn" class="btn secondary" title="åˆ‡æ›æ¨¡æ“¬åµæ¸¬">åˆ‡æ›åµæ¸¬</button>
        </div>
        <div class="spacer"></div>
        <button id="menuBtn" class="btn ghost">â‰¡ é¸å–®</button>
      </div>
      <div class="hudbar">
        <div class="chip">åˆ†æ•¸ï¼š<span id="score">0</span></div>
        <div class="chip">Comboï¼š<span id="combo">0</span></div>
        <div class="chip">æ™‚é–“ï¼š<span id="time">60</span>s</div>
      </div>
    </div>

    <div id="hint" class="hint">æ­¤ç‰ˆæœ¬ä¸æœƒé–‹å•Ÿé¡é ­ã€‚æŒ‰ã€Œåˆ‡æ›åµæ¸¬ã€æ¨¡æ“¬ Hiro Markerï¼Œå†ç§»å‹•æ»‘é¼ æˆ–è§¸æ§ä¾†èˆå‹•ç«é¾ã€‚</div>

    <!-- Panel -->
    <div id="panelBackdrop" class="panel-backdrop"></div>
    <aside id="panel" class="panel" aria-hidden="true">
      <header>
        <h2>è¨­å®š</h2>
        <button id="closePanel" class="btn ghost" aria-label="é—œé–‰">âœ•</button>
      </header>
      <div class="section">
        <div class="row">
          <div class="label">è¢å¹•</div>
          <div class="controls">
            <button id="fullscreenBtn" class="mini">å…¨å±</button>
          </div>
        </div>
        <div class="row">
          <div class="label">éŠæˆ²</div>
          <div class="controls">
            <button id="resetBtn" class="mini danger">é‡ç½®</button>
          </div>
        </div>
      </div>
      <div class="section" style="border-top:1px solid rgba(255,255,255,0.1)">
        <div class="sliderRow">
          <div class="label">ç›®æ¨™å¯†åº¦</div>
          <div class="controls">
            <input id="density" type="range" min="1" max="10" value="4">
            <span id="densityVal" class="val">4</span>
          </div>
        </div>
        <div class="sliderRow">
          <div class="label">é€Ÿåº¦</div>
          <div class="controls">
            <input id="speed" type="range" min="1" max="10" value="5">
            <span id="speedVal" class="val">5</span>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    // ========= DOM =========
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d', { alpha: true });

    const startBtn = document.getElementById('startBtn');
    const menuBtn = document.getElementById('menuBtn');
    const panel = document.getElementById('panel');
    const panelBackdrop = document.getElementById('panelBackdrop');
    const closePanelBtn = document.getElementById('closePanel');
    const resetBtn = document.getElementById('resetBtn');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const toggleMarkerBtn = document.getElementById('toggleMarkerBtn');

    const scoreEl = document.getElementById('score');
    const comboEl = document.getElementById('combo');
    const timeEl = document.getElementById('time');
    const hintEl = document.getElementById('hint');

    const densEl = document.getElementById('density');
    const speedEl = document.getElementById('speed');
    const densityVal = document.getElementById('densityVal');
    const speedVal = document.getElementById('speedVal');

    // Marker status DOM
    const markerStatusEl = document.getElementById('markerStatus');
    const markerStatusText = markerStatusEl.querySelector('.status-text');

    // ========= ç‹€æ…‹ =========
    let running = false;
    let gameOver = false;
    let W = 0, H = 0, dpr = 1;

    let score = 0, combo = 0, timeLeft = 60;
    let timerId = null;

    let markerDetected = false;
    let markerPos = { x: 0, y: 0 };
    const smoothing = 0.28;

    // ========= ç›®æ¨™ =========
    const goodList = ['ç¦', 'æ˜¥', 'è²¡', 'å®‰', 'æ—º', 'å‰', 'ç¥¥', 'è³€', 'é¾', 'å¹´'];
    const badList  = ['âš½', 'ğŸ”', 'ğŸ§', 'ğŸ§Š', 'ğŸ§¼', 'ğŸº', 'ğŸ’¡', 'ğŸ“', 'ğŸ§½', 'ğŸ§¯'];
    const items = [];
    const MAX_ITEMS = 14;

    // ========= ç²’å­ =========
    const particles = [];
    const MAX_PARTICLES = 900;

    // æµ®å‹•æ–‡å­—
    const floatTexts = [];

    // ========= ç•«å¸ƒå¤§å° =========
    let resizeTimer = null;
    function resize() {
      const doResize = () => {
        dpr = Math.min(window.devicePixelRatio || 1, 2);
        const rect = canvas.getBoundingClientRect();
        W = rect.width; H = rect.height;
        canvas.width = Math.round(W * dpr);
        canvas.height = Math.round(H * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        if (!markerPos.x && !markerPos.y) {
          markerPos = { x: W/2, y: H/2 };
        }
      };
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(doResize, 50);
    }
    window.addEventListener('resize', resize, { passive: true });
    window.addEventListener('orientationchange', () => setTimeout(resize, 150), { passive: true });
    resize();

    // ========= Marker ç‹€æ…‹ =========
    function setMarkerStatus(visible) {
      markerDetected = visible;
      markerStatusEl.classList.toggle('ok', visible);
      markerStatusText.textContent = visible ? 'Markerï¼šå·²åµæ¸¬' : 'Markerï¼šæœªåµæ¸¬';
      hintEl.textContent = visible
        ? 'å·²æ¨¡æ“¬åµæ¸¬åˆ° Hiro Markerï¼Œç§»å‹•æ»‘é¼ æˆ–è§¸æ§ä¾†èˆå‹•ç«é¾ã€‚'
        : 'æœªåµæ¸¬åˆ° Hiro Markerï¼ŒæŒ‰ã€Œåˆ‡æ›åµæ¸¬ã€æˆ–å†æŒ‰é–‹å§‹ã€‚';
      hintEl.className = visible ? 'hint ok' : 'hint bad';
    }
    setMarkerStatus(false);

    toggleMarkerBtn.addEventListener('click', () => {
      setMarkerStatus(!markerDetected);
    });

    // ========= ç›®æ¨™ç‰©ä»¶ =========
    function spawnItem() {
      const isGood = Math.random() < 0.6;
      const text = isGood
        ? goodList[Math.floor(Math.random() * goodList.length)]
        : badList[Math.floor(Math.random() * badList.length)];
      const size = 28 + Math.random() * 18;
      const margin = 28 + size;
      const x = margin + Math.random() * (W - margin * 2);
      const y = 80 + Math.random() * (H - 160);
      const speed = parseInt(speedEl.value, 10);
      const vx = (Math.random() - 0.5) * speed;
      const vy = (Math.random() - 0.5) * speed;
      const ttl = 12 + Math.random() * 10;
      items.push({ x, y, vx, vy, text, size, isGood, ttl });
    }
    function ensureItems() {
      const target = parseInt(densEl.value, 10) * 3;
      while (items.length < Math.min(MAX_ITEMS, target)) spawnItem();
    }
    function updateItems(dt) {
      for (let i = items.length - 1; i >= 0; i--) {
        const it = items[i];
        it.x += it.vx;
        it.y += it.vy;
        it.ttl -= dt;
        if (it.x < 20 || it.x > W - 20) it.vx *= -1;
        if (it.y < 60 || it.y > H - 60) it.vy *= -1;
        if (it.ttl <= 0) items.splice(i, 1);
      }
      ensureItems();
    }
    function drawItems(ctx) {
      for (const it of items) {
        ctx.save();
        ctx.font = `700 ${it.size}px system-ui, "Noto Color Emoji", "Apple Color Emoji"`;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.shadowColor = it.isGood ? 'rgba(255,215,0,0.9)' : 'rgba(255,90,0,0.7)';
        ctx.shadowBlur = 12;
        ctx.fillStyle = it.isGood ? '#ffd166' : '#ff6b6b';
        ctx.fillText(it.text, it.x, it.y);
        ctx.restore();
      }
    }

    // ========= ç²’å­ =========
    function spawnIncenseParticles(pos, dir, count = 6) {
      for (let i = 0; i < count; i++) {
        if (particles.length >= MAX_PARTICLES) break;
        const angle = Math.atan2(dir.y, dir.x) + (Math.random() * 0.8 - 0.4);
        const speed = 40 + Math.random() * 120;
        const vx = Math.cos(angle) * speed;
        const vy = Math.sin(angle) * speed - Math.random() * 20;
        particles.push({
          x: pos.x + (Math.random() * 6 - 3),
          y: pos.y + (Math.random() * 6 - 3),
          vx, vy,
          life: 0.45 + Math.random() * 0.35,
          age: 0,
          size: 2 + Math.random() * 2.5,
          hue: 20 + Math.random() * 20
        });
      }
    }
    function updateParticles(dt) {
      for (let i = particles.length - 1; i >= 0; i--) {
        const p = particles[i];
        p.age += dt;
        p.x += p.vx * dt;
        p.y += p.vy * dt;
        p.vy += 20 * dt;
        if (p.age >= p.life) particles.splice(i, 1);
      }
    }
    function drawParticles(ctx) {
      ctx.save();
      ctx.globalCompositeOperation = 'lighter';
      for (const p of particles) {
        const t = p.age / p.life;
        const alpha = 1 - t;
        const size = p.size * (0.8 + 0.4 * (1 - t));
        const col = `hsla(${p.hue}, 90%, ${60 - t * 30}%, ${alpha})`;
        ctx.fillStyle = col;
        ctx.beginPath();
        ctx.arc(p.x, p.y, size, 0, Math.PI * 2);
        ctx.fill();
      }
      ctx.restore();
    }

    // ========= ç«é¾ =========
    const dragon = {
      size: 80,
      char: 'ğŸ‰'
    };
    function drawDragon(ctx, head) {
      ctx.save();
      ctx.font = `bold ${dragon.size}px "Apple Color Emoji", "Noto Color Emoji", system-ui`;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.shadowColor = 'rgba(255,215,0,0.9)';
      ctx.shadowBlur = 15;
      ctx.fillText(dragon.char, head.x, head.y);
      spawnIncenseParticles(head, { x: 1, y: 0 }, 7);
      ctx.restore();
    }

    // ========= ç¢°æ’ =========
    function circleHit(ax, ay, bx, by, r) {
      const dx = ax - bx, dy = ay - by;
      return (dx * dx + dy * dy) <= r * r;
    }
    function handleCollisions(head) {
      if (!markerDetected) return;
      for (let i = items.length - 1; i >= 0; i--) {
        const it = items[i];
        const radius = Math.max(28, dragon.size * 0.5);
        if (circleHit(head.x, head.y, it.x, it.y, radius)) {
          if (it.isGood) {
            combo++;
            const bonus = 10 + Math.min(60, combo * 2);
            score += bonus;
            flash('+ ' + bonus, it.x, it.y, true);
          } else {
            combo = 0;
            score = Math.max(0, score - 15);
            flash('âˆ’ 15', it.x, it.y, false);
          }
          items.splice(i, 1);
          scoreEl.textContent = score;
          comboEl.textContent = combo;
        }
      }
    }

    // ========= æµ®å‹•å­— =========
    function flash(text, x, y, ok) { floatTexts.push({ text, x, y, ok, t: 0 }); }
    function drawFloatTexts(dt) {
      for (let i = floatTexts.length - 1; i >= 0; i--) {
        const f = floatTexts[i];
        f.t += dt;
        const alpha = Math.max(0, 1 - f.t / 1.2);
        const dy = -f.t * 40;
        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.font = '800 22px system-ui';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = f.ok ? '#22c55e' : '#f97316';
        ctx.fillText(f.text, f.x, f.y + dy);
        ctx.restore();
        if (alpha <= 0.01) floatTexts.splice(i, 1);
      }
    }

    // ========= ä¸»å¾ªç’° =========
    let lastTime = performance.now();
    function tick(now) {
      if (!running) return;
      const dt = Math.min(0.033, (now - lastTime) / 1000);
      lastTime = now;

      ctx.clearRect(0, 0, W, H);

      // æ›´æ–°é ­éƒ¨ä½ç½®ï¼ˆè‹¥åµæ¸¬åˆ° marker æ‰å¹³æ»‘è¿½è¹¤ï¼‰
      const head = { x: markerPos.x, y: markerPos.y };
      updateItems(dt);
      drawItems(ctx);

      drawDragon(ctx, head);
      updateParticles(dt);
      drawParticles(ctx);

      handleCollisions(head);
      drawFloatTexts(dt);

      requestAnimationFrame(tick);
    }

    // ========= æ§åˆ¶ =========
    function startGameLoop() {
      if (running) return;
      running = true; gameOver = false;
      lastTime = performance.now();
      ensureItems();
      clearInterval(timerId);
      timeLeft = 60;
      timeEl.textContent = timeLeft;
      timerId = setInterval(() => {
        timeLeft--; timeEl.textContent = timeLeft;
        if (timeLeft <= 0) {
          clearInterval(timerId);
          running = false; gameOver = true;
          hintEl.textContent = `æ™‚é–“åˆ°ï¼ç¸½åˆ†ï¼š${score}`;
          hintEl.className = 'hint';
          startBtn.disabled = false;
        }
      }, 1000);
      requestAnimationFrame(tick);
    }

    function startAll() {
      startBtn.disabled = true;
      hintEl.textContent = 'å·²é–‹å§‹è¨ˆæ™‚ï¼›å¯æŒ‰ã€Œåˆ‡æ›åµæ¸¬ã€ä¸¦ç§»å‹•æ»‘é¼ æˆ–è§¸æ§ä¾†èˆå‹•ç«é¾ã€‚';
      hintEl.className = 'hint';
      setMarkerStatus(markerDetected); // ä¿æŒç•¶å‰ç‹€æ…‹
      startGameLoop();
    }

    startBtn.addEventListener('click', startAll);

    resetBtn.addEventListener('click', () => {
      score = 0; combo = 0; scoreEl.textContent = score; comboEl.textContent = combo;
      items.length = 0; ensureItems();
      markerPos = { x: W/2, y: H/2 };
      hintEl.textContent = 'å·²é‡ç½®ï¼ŒæŒ‰ã€Œé–‹å§‹ã€é‡æ–°è¨ˆæ™‚ã€‚';
      hintEl.className = 'hint';
      running = false; gameOver = false;
      clearInterval(timerId);
      timeLeft = 60; timeEl.textContent = timeLeft;
      startBtn.disabled = false;
    });

    fullscreenBtn.addEventListener('click', () => {
      const el = document.documentElement;
      if (!document.fullscreenElement) {
        (el.requestFullscreen && el.requestFullscreen()) || (el.webkitRequestFullscreen && el.webkitRequestFullscreen());
      } else {
        (document.exitFullscreen && document.exitFullscreen()) || (document.webkitExitFullscreen && document.webkitExitFullscreen());
      }
    });

    // ======== é¢æ¿é–‹é—œ ========
    function openPanel() {
      panel.classList.add('open');
      panelBackdrop.classList.add('open');
      panel.setAttribute('aria-hidden', 'false');
    }
    function closePanel() {
      panel.classList.remove('open');
      panelBackdrop.classList.remove('open');
      panel.setAttribute('aria-hidden', 'true');
    }
    menuBtn.addEventListener('click', openPanel);
    closePanelBtn.addEventListener('click', closePanel);
    panelBackdrop.addEventListener('click', closePanel);

    // ======== æ»‘æ¡¿æ•¸å€¼åŒæ­¥ ========
    function bindVal(input, labelEl) {
      const sync = () => labelEl.textContent = input.value;
      input.addEventListener('input', sync);
      sync();
    }
    bindVal(densEl, densityVal);
    bindVal(speedEl, speedVal);

    // ========= æŒ‡æ¨™æ§åˆ¶ï¼ˆæ»‘é¼  / è§¸æ§ï¼‰=========
    function setPosFromEvent(e) {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      // å¹³æ»‘ç§»å‹•
      markerPos.x = markerPos.x + (x - markerPos.x) * smoothing || x;
      markerPos.y = markerPos.y + (y - markerPos.y) * smoothing || y;
    }
    window.addEventListener('pointermove', (e) => {
      if (!markerDetected) return; // åªæœ‰åµæ¸¬ä¸­æ‰è¿½è¹¤
      setPosFromEvent(e);
    }, { passive: true });

    window.addEventListener('pointerdown', (e) => {
      if (!markerDetected) return;
      setPosFromEvent(e);
    }, { passive: true });

    // åˆå§‹ä½ç½®
    markerPos = { x: W/2, y: H/2 };
  </script>
</body>
</html>
