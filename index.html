<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>AR æŠ“å¯¶éŠæˆ² - å¹³é¢ç§»å‹•ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <script>
    window.gameScore = 0;

    AFRAME.registerComponent('floating-item', {
      schema: {
        type: { type: 'string', default: 'good' }, 
        value: { type: 'string', default: '' }
      },
      init: function() {
        this.isHit = false;
        
        // --- è¨­å®šå›ºå®šæ·±åº¦ (Zè»¸) ---
        // è² æ•¸ä»£è¡¨åœ¨ç›¸æ©Ÿå‰æ–¹ï¼Œ-2 ä»£è¡¨è·é›¢ 2 å…¬å°º
        // é€™æ¨£ç‰©é«”å¤§å°å°±æœƒä¿æŒä¸€è‡´
        const fixedZ = -2.5; 

        // --- éš¨æ©Ÿæ±ºå®šç§»å‹•æ–¹å‘ (ä¸Šä¸‹å·¦å³) ---
        // 0: å·¦åˆ°å³, 1: å³åˆ°å·¦, 2: ä¸Šåˆ°ä¸‹, 3: ä¸‹åˆ°ä¸Š
        const direction = Math.floor(Math.random() * 4);
        
        // è¨­å®šé‚Šç•Œ (æ ¹æ“š -2.5 çš„æ·±åº¦ï¼Œå¤§ç´„çš„å¯è¦–ç¯„åœ)
        const limitX = 2.5;
        const limitY = 1.8;

        let startX, startY, speedX, speedY;
        const baseSpeed = 0.015 + Math.random() * 0.02; // éš¨æ©Ÿé€Ÿåº¦

        switch(direction) {
            case 0: // å·¦ -> å³
                startX = -limitX; 
                startY = (Math.random() - 0.5) * 2; // Y éš¨æ©Ÿ
                speedX = baseSpeed; speedY = 0;
                break;
            case 1: // å³ -> å·¦
                startX = limitX;
                startY = (Math.random() - 0.5) * 2;
                speedX = -baseSpeed; speedY = 0;
                break;
            case 2: // ä¸Š -> ä¸‹
                startX = (Math.random() - 0.5) * 3; // X éš¨æ©Ÿ
                startY = limitY;
                speedX = 0; speedY = -baseSpeed;
                break;
            case 3: // ä¸‹ -> ä¸Š
                startX = (Math.random() - 0.5) * 3;
                startY = -limitY;
                speedX = 0; speedY = baseSpeed;
                break;
        }
        
        this.el.setAttribute('position', `${startX} ${startY} ${fixedZ}`);
        
        // å„²å­˜é€Ÿåº¦å‘é‡
        this.velocity = { x: speedX, y: speedY };
        
        // æš«å­˜è®Šæ•¸
        this.playerPos = new THREE.Vector3();
        this.myPos = new THREE.Vector3();
      },
      
      tick: function() {
        if (this.isHit) return;

        // æ‡¶åŠ è¼‰
        if (!this.playerCollider) {
            this.playerCollider = document.querySelector('#player-collider');
            this.playerMarker = document.querySelector('#player-marker');
            this.camera = document.querySelector('[camera]');
            return; 
        }

        // --- 1. ç§»å‹•é‚è¼¯ (æ›´æ–° X, Y) ---
        const pos = this.el.getAttribute('position');
        pos.x += this.velocity.x;
        pos.y += this.velocity.y;
        this.el.setAttribute('position', pos);

        // é¢å‘ç›¸æ©Ÿ
        if (this.camera) {
            this.el.object3D.lookAt(this.camera.object3D.position);
        }

        // --- 2. é‚Šç•Œæª¢æŸ¥ (è¶…å‡ºç¯„åœç§»é™¤) ---
        if (Math.abs(pos.x) > 3.5 || Math.abs(pos.y) > 2.5) {
          if (this.el.parentNode) this.el.parentNode.removeChild(this.el);
          return;
        }

        // --- 3. ç¢°æ’åµæ¸¬ (å¿½ç•¥ Z è»¸æ·±åº¦) ---
        if (this.playerMarker.object3D.visible) {
            
            this.playerCollider.object3D.updateMatrixWorld();
            this.el.object3D.updateMatrixWorld();

            this.playerCollider.object3D.getWorldPosition(this.playerPos);
            this.el.object3D.getWorldPosition(this.myPos);

            // é—œéµä¿®æ”¹ï¼šå°‡ Z è»¸å·®ç•°æ­¸é›¶ï¼Œåªè¨ˆç®— X èˆ‡ Y çš„è·é›¢ (2D è·é›¢)
            // é€™æ¨£å°±ç®— Marker å¾ˆè¿‘ï¼Œç‰©é«”å¾ˆé ï¼Œåªè¦è¦–è¦ºä¸Šé‡ç–Šå°±ç®—ç¢°åˆ°
            const dx = this.playerPos.x - this.myPos.x;
            const dy = this.playerPos.y - this.myPos.y;
            
            // è¨ˆç®—å¹³é¢è·é›¢
            const distance2D = Math.sqrt(dx * dx + dy * dy);

            // åˆ¤å®šç¯„åœè¨­ç‚º 0.35 (å› ç‚ºå¿½ç•¥äº†æ·±åº¦ï¼Œç¯„åœå¯ä»¥ç¨å¾®ç¸®å°ä¸€é»ä»¥æ±‚ç²¾ç¢º)
            if (distance2D < 0.35) {
                this.handleCollision();
            }
        }
      },

      handleCollision: function() {
        this.isHit = true;
        
        const points = this.data.type === 'good' ? 15 : -5;
        if (window.updateGameScore) {
            window.updateGameScore(points);
        }

        this.el.setAttribute('animation', {
          property: 'scale',
          to: '0 0 0',
          dur: 150,
          easing: 'easeInQuad'
        });

        setTimeout(() => {
          if (this.el.parentNode) {
            this.el.parentNode.removeChild(this.el);
          }
        }, 150);
      }
    });
  </script>

  <style>
    body { margin: 0; overflow: hidden; font-family: 'Microsoft JhengHei', sans-serif; }
    
    #ui-layer {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 100;
      display: flex; flex-direction: column; justify-content: space-between;
    }
    
    .header { padding: 20px; display: flex; align-items: center; }
    
    .score-container {
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid #f1c40f;
      border-radius: 50px;
      padding: 10px 30px;
      color: white;
      font-size: 24px;
      font-weight: bold;
      display: flex; align-items: center; gap: 10px;
    }

    .score-popup {
      position: absolute;
      top: 80px; left: 50px;
      font-size: 48px;
      font-weight: 900;
      opacity: 0;
      transition: all 0.4s ease-out;
      text-shadow: 2px 2px 0 #000;
    }

    .footer {
      background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
      color: white;
      text-align: center;
      padding: 30px 20px;
      font-size: 16px;
      text-shadow: 1px 1px 2px black;
    }
    
    .marker-hint { color: #f1c40f; font-weight: bold; }
  </style>
</head>
<body>

  <div id="ui-layer">
    <div class="header">
      <div class="score-container">
        <span>ğŸ† åˆ†æ•¸:</span>
        <span id="score-val">0</span>
      </div>
      <div id="score-anim" class="score-popup">+15</div>
    </div>
    
    <div class="footer">
      <span class="marker-hint">Hiro Marker</span> æ˜¯ä½ çš„ç¶²å­<br>
      åƒæ“¦çª—æˆ¶ä¸€æ¨£ç§»å‹•å®ƒä¾†æ¥ä½å­—å¡ï¼
    </div>
  </div>

  <a-scene
    vr-mode-ui="enabled: false"
    embedded
    renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true;"
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono;"
  >
    
    <!-- ç©å®¶ (Hiro Marker) -->
    <a-marker preset="hiro" id="player-marker">
      <a-entity id="player-collider">
        <!-- è¦–è¦ºæç¤ºï¼šåŠ ä¸Šä¸€æ¢é•·é•·çš„é›·å°„å…‰æŸï¼Œæš—ç¤ºé€™æ˜¯ã€ŒæŒ‡å‘ã€æ“ä½œ -->
        <a-cylinder position="0 0 0" radius="0.02" height="10" color="#f1c40f" opacity="0.4" rotation="-90 0 0"></a-cylinder>
        <a-ring radius-inner="0.25" radius-outer="0.3" color="#f1c40f" rotation="-90 0 0" material="side: double"></a-ring>
        <a-sphere radius="0.05" color="red" position="0 0 0"></a-sphere>
      </a-entity>
    </a-marker>

    <!-- ç›¸æ©Ÿ -->
    <a-entity camera id="camera-rig"></a-entity>

  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const GOOD_WORDS = ['ç¦', 'æ˜¥', 'è²¡', 'å‰', 'ç¥¥', 'æ—º', 'è³€', 'å–œ'];
        const BAD_WORDS = ['è¡°', 'çª®', 'è‹¦', 'æ‚¶', 'ç—…', 'ç´¯', 'å¿™', 'äº‚'];
        
        const scoreEl = document.getElementById('score-val');
        const scoreAnimEl = document.getElementById('score-anim');
        const cameraRig = document.querySelector('#camera-rig');

        window.updateGameScore = function(points) {
            window.gameScore += points;
            scoreEl.innerText = window.gameScore;
            scoreAnimEl.innerText = points > 0 ? `+${points}` : points;
            scoreAnimEl.style.color = points > 0 ? '#2ecc71' : '#e74c3c';
            
            scoreAnimEl.style.opacity = '0';
            scoreAnimEl.style.transform = 'translateY(0) scale(0.5)';
            void scoreAnimEl.offsetWidth; 
            scoreAnimEl.style.opacity = '1';
            scoreAnimEl.style.transform = 'translateY(-30px) scale(1.2)';
            
            setTimeout(() => { scoreAnimEl.style.opacity = '0'; }, 800);
        };

        function createTextTexture(text, isBad) {
            const canvas = document.createElement('canvas');
            canvas.width = 256; canvas.height = 256;
            const ctx = canvas.getContext('2d');

            ctx.beginPath();
            ctx.arc(128, 128, 110, 0, 2 * Math.PI);
            ctx.fillStyle = isBad ? 'rgba(50, 50, 50, 0.9)' : 'rgba(200, 0, 0, 0.9)';
            ctx.fill();
            
            ctx.lineWidth = 15;
            ctx.strokeStyle = isBad ? '#95a5a6' : '#f1c40f';
            ctx.stroke();

            ctx.font = 'bold 130px "Microsoft JhengHei", Arial';
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillStyle = 'white';
            ctx.fillText(text, 128, 135);

            return canvas.toDataURL();
        }

        setInterval(() => {
            const isGood = Math.random() > 0.3;
            const dataSet = isGood ? GOOD_WORDS : BAD_WORDS;
            const text = dataSet[Math.floor(Math.random() * dataSet.length)];
            
            const el = document.createElement('a-plane');
            
            el.setAttribute('material', {
                src: createTextTexture(text, !isGood),
                transparent: true, opacity: 1, shader: 'flat', side: 'double'
            });

            // èª¿æ•´å¤§å°ï¼šå› ç‚ºç¾åœ¨è·é›¢å›ºå®šï¼Œå¯ä»¥ç¨å¾®è¨­å¤§ä¸€é»è®“å®ƒçœ‹æ¸…æ¥š
            el.setAttribute('width', '0.6');
            el.setAttribute('height', '0.6');
            
            el.setAttribute('floating-item', {
                type: isGood ? 'good' : 'bad',
                value: text
            });

            cameraRig.appendChild(el);

        }, 1000); // ç”Ÿæˆé€Ÿåº¦åŠ å¿«ä¸€é»
    });
  </script>
</body>
</html>
