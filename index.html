<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å¤§å‘èˆç«é¾ AR å°éŠæˆ²ï¼ˆç¤ºç¯„åŸå‹ï¼‰</title>
  <style>
    :root{
      --bg:#0b0f1a;
      --gold:#f4c430;
      --red:#c81d25;
      --green:#1fa37d;
      --muted:#1e2638;
      --panel:#101828cc;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b0f1a,#0b1222);color:#eef2ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","PingFang HK","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;}
    *{box-sizing:border-box}

    /* Layout */
    .app{
      display:grid;
      grid-template-rows:auto 1fr auto;
      height:100%;
    }
    header{
      display:flex;align-items:center;gap:.75rem;
      padding:.75rem 1rem;border-bottom:1px solid #16253a;background:#0c1424b3;backdrop-filter:blur(6px);
    }
    header .title{
      font-size:1.05rem;font-weight:700;letter-spacing:.02em;
    }
    header .badge{
      font-size:.75rem;color:#ffd966;background:#512b0b;border:1px solid #7a4a12;padding:.15rem .4rem;border-radius:.4rem;
    }
    .hud{
      display:flex;gap:.5rem;margin-left:auto;align-items:center;
    }
    .pill{display:inline-flex;align-items:center;gap:.4rem;padding:.35rem .6rem;border-radius:999px;background:#0f1b31;border:1px solid #1f3357;font-size:.8rem}
    .pill strong{color:#fff}
    .btn{
      appearance:none;border:1px solid #2a3f67;background:#142544;color:#e6eeff;
      padding:.5rem .8rem;border-radius:.6rem;cursor:pointer;font-weight:600;transition:.2s;
    }
    .btn:hover{background:#1a2f55}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    main{
      position:relative;overflow:hidden;
    }

    /* Camera + Canvas stack */
    .stage{
      position:absolute;inset:0;
      display:grid;place-items:center;
      background:#000;
    }
    .videoWrap, .overlayCanvas, .uiOverlay{
      position:absolute;inset:0;
    }
    .videoEl{
      width:100%;height:100%;object-fit:cover;transform:scaleX(-1); /* mirror for easier control */
      background:#000;
    }
    canvas.overlayCanvas{pointer-events:none}

    /* Collapsible Side panel */
    .sideWrap{
      position:absolute;right:.5rem;top:.5rem;z-index:5;
    }
    .sideToggle{
      position:absolute; right:0; top:0; transform:translateY(-110%);
      display:inline-flex; align-items:center; gap:.4rem;
      padding:.4rem .55rem; border-radius:.6rem;
      border:1px solid #233452; background:#0f1d35cc; color:#e6eeff; backdrop-filter:blur(6px);
      cursor:pointer; font-weight:700; font-size:.85rem;
    }
    .sideToggle .chev{display:inline-block; transition:.2s transform}
    .sideWrap.closed .sideToggle .chev{transform:rotate(180deg)} /* flip when closed */

    .side{
      display:flex;flex-direction:column;gap:.5rem;
      width:min(92vw,340px);max-height:80vh;overflow:auto;padding:.5rem;
      background:var(--panel);border:1px solid #233452;border-radius:.8rem;backdrop-filter:blur(6px);
      transition: transform .25s ease, opacity .25s ease, visibility 0s linear .25s;
    }
    .sideWrap.closed .side{
      transform:translateY(-8px) translateX(8px) scale(.98);
      opacity:0; visibility:hidden; transition: transform .25s ease, opacity .25s ease, visibility 0s;
    }
    .side h3{margin:.2rem 0 .4rem;font-size:.95rem}
    .row{display:flex;gap:.5rem;flex-wrap:wrap}
    .tag{padding:.2rem .5rem;border:1px solid #334a77;background:#0e1d36;border-radius:.6rem;font-size:.8rem}
    .legend{display:flex;gap:.4rem;align-items:center;font-size:.85rem}
    .dot{width:.7rem;height:.7rem;border-radius:999px;display:inline-block}
    .dot.good{background:var(--gold)}
    .dot.bad{background:#9aa4b2}
    .kv{display:flex;justify-content:space-between;gap:1rem;font-size:.9rem;padding:.35rem .5rem;background:#0b162c;border:1px solid #203356;border-radius:.5rem}
    .slider{width:100%}
    .small{font-size:.8rem;opacity:.9}

    /* On-screen hint */
    .hint{
      position:absolute;left:50%;bottom:.5rem;transform:translateX(-50%);
      padding:.5rem .75rem;border-radius:.6rem;background:#0f1d35cc;border:1px solid #23406d;backdrop-filter:blur(6px);
      font-size:.9rem
    }

    /* Floating festive UI elements (purely decorative) */
    .lantern{
      position:absolute; top:-60px; width:40px; height:60px; border-radius:20px; background:linear-gradient(#ff3b3b,#b40f0f);
      border:2px solid #7a0b0b; box-shadow:0 0 18px #ff5050aa inset, 0 4px 12px #00000055; 
      animation: float 5s ease-in-out infinite;
    }
    .lantern::after{content:"ç¦"; position:absolute; inset:auto 0 8px 0; margin:auto; text-align:center; color:#ffd966; font-weight:800}
    .lantern.l1{left:12px; animation-delay:0s}
    .lantern.l2{left:72px; animation-delay:1.2s}
    .lantern.l3{right:20px; animation-delay:.6s}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(12px)}}

    /* Mobile safe areas */
    @supports(padding:max(0px)) {
      header{padding-left:max(1rem, env(safe-area-inset-left)); padding-right:max(1rem, env(safe-area-inset-right)); padding-top:max(.5rem, env(safe-area-inset-top));}
      .hint{margin-bottom:max(.25rem, env(safe-area-inset-bottom))}
    }

    /* Fallback message */
    .blocked{
      position:absolute; inset:0; display:none; place-items:center; text-align:center; padding:1rem; background:#0b1222; z-index:20;
    }
    .blocked.active{display:grid}
    .blocked .card{
      max-width:560px; background:#0f1d35; border:1px solid #243a63; border-radius:.8rem; padding:1rem;
    }
    .blocked h2{margin:.25rem 0}
    .blocked p{opacity:.9}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <span class="badge">ç¤ºç¯„åŸå‹</span>
      <div class="title">å¤§å‘èˆç«é¾ â€¢ è¾²æ›†æ–°å¹´ AR å°éŠæˆ²</div>
      <div class="hud">
        <div class="pill" id="scorePill">åˆ†æ•¸ï¼š<strong id="score">0</strong></div>
        <div class="pill">æ™‚é–“ï¼š<strong id="time">60</strong>s</div>
        <button class="btn" id="startBtn">é–‹å§‹</button>
        <button class="btn" id="resetBtn" disabled>é‡è¨­</button>
        <button class="btn" id="togglePanelBtn" title="é–‹é—œè¨­å®š">è¨­å®š</button>
      </div>
    </header>

    <main>
      <div class="stage">
        <!-- Decorative lanterns -->
        <div class="lantern l1"></div>
        <div class="lantern l2"></div>
        <div class="lantern l3"></div>

        <!-- Camera stream -->
        <div class="videoWrap">
          <video id="cam" class="videoEl" playsinline muted></video>
        </div>

        <!-- Game overlay -->
        <canvas id="game" class="overlayCanvas"></canvas>

        <!-- Clickable overlay UI (for interactions) -->
        <div class="uiOverlay"></div>

        <!-- Side panel (collapsible) -->
        <div id="sideWrap" class="sideWrap closed" aria-expanded="false">
          <button id="floatingToggle" class="sideToggle" aria-label="é–‹é—œéŠæˆ²è¨­å®š">
            éŠæˆ²è¨­å®š <span class="chev">â–¾</span>
          </button>
          <aside class="side" role="dialog" aria-label="éŠæˆ²è¨­å®š">
            <h3>éŠæˆ²è¨­å®š</h3>
            <div class="kv"><span>åµæ¸¬æ¨¡å¼</span><strong id="modeLabel">æ‰‹æŒç«é¾ï¼ˆç­·å­ï¼‰</strong></div>
            <div class="kv"><span>éˆæ•åº¦</span><input id="sensitivity" class="slider" type="range" min="0.2" max="2.0" step="0.1" value="1.0"></div>
            <div class="kv"><span>ç‰©ä»¶æ•¸é‡</span><input id="targetCount" class="slider" type="range" min="3" max="12" step="1" value="7"></div>
            <div class="kv"><span>éŠæˆ²æ™‚é•·</span><input id="duration" class="slider" type="range" min="30" max="120" step="10" value="60"></div>
            <div class="legend"><span class="dot good"></span> æ–°å¹´ç›¸é—œï¼ˆ+åˆ†ï¼‰</div>
            <div class="legend"><span class="dot bad"></span> éæ–°å¹´ï¼ˆ-åˆ†ï¼‰</div>
            <div class="row">
              <span class="tag">æ­å–œç™¼è²¡</span>
              <span class="tag">æ–°å¹´å¿«æ¨‚</span>
              <span class="tag">å‰ç¥¥å¦‚æ„</span>
              <span class="tag">åˆ©æ˜¯é€—ä¾†</span>
            </div>
            <p class="small">æ³¨æ„ï¼šæ­¤ç‚ºç€è¦½å™¨åŸå‹ï¼Œä½¿ç”¨ç°¡åŒ–çš„é¡è‰²è¿½è¹¤ä¾†ã€Œè·Ÿä½ã€ä½ æ‰‹ä¸Šçš„ç«é¾ä½ç½®ã€‚å¯¦éš›ç”¢å“å¯æ›¿æ›ç‚ºå…ˆé€²çš„ç‰©ä»¶è¿½è¹¤ï¼ˆå¦‚ MediaPipe/AR æ¨¡å‹ï¼‰ã€‚</p>
          </aside>
        </div>

        <!-- Hint -->
        <div class="hint">æç¤ºï¼šæŠŠæ‰‹æ©Ÿå¾Œç½®é¡é ­å°æº–ä½ æ‰‹ä¸Šç”¨ç­·å­æ‹ä½çš„ç«é¾å…¬ä»”ï¼Œè¼•è¼•æ®å‹•ä¾†æ§åˆ¶ç•«é¢å…§çš„ç«é¾æ–¹å‘ï¼</div>

        <!-- Fallback (permissions / unsupported) -->
        <div id="fallback" class="blocked">
          <div class="card">
            <h2>éœ€è¦ç›¸æ©Ÿæ¬Šé™</h2>
            <p>è«‹å…è¨±ä½¿ç”¨å¾Œç½®é¡é ­ä»¥é–‹å§‹éŠæˆ²ã€‚è‹¥ç„¡æ³•ä½¿ç”¨ï¼Œè«‹æ”¹ç”¨ Chrome æˆ– Safari æœ€æ–°ç‰ˆæœ¬ã€‚</p>
            <div style="margin-top:.5rem;display:flex;gap:.5rem;justify-content:center">
              <button id="retryBtn" class="btn">é‡æ–°å˜—è©¦</button>
            </div>
          </div>
        </div>

      </div>
    </main>

    <footer style="padding:.5rem 1rem;border-top:1px solid #16253a;background:#0c1424b3;display:flex;gap:.5rem;flex-wrap:wrap">
      <span class="small">èƒŒæ™¯ï¼šå¤§å‘èˆç«é¾æ„è±¡ï¼ˆç¤ºæ„ï¼‰ã€‚</span>
      <span class="small">æ­¤ç‰ˆæœ¬æ¡ç”¨é¡åƒé¡¯ç¤ºï¼Œå·¦å³æ–¹å‘èˆ‡ä½ æ‰‹å‹¢ä¸€è‡´ã€‚</span>
    </footer>
  </div>

  <script>
    // --- Simple AR-ish tracking via color threshold (prototype) ---
    const video = document.getElementById('cam');
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d', { alpha: true });
    const startBtn = document.getElementById('startBtn');
    const resetBtn = document.getElementById('resetBtn');
    const retryBtn = document.getElementById('retryBtn');
    const fallback = document.getElementById('fallback');
    const scoreEl = document.getElementById('score');
    const timeEl = document.getElementById('time');
    const sensitivityEl = document.getElementById('sensitivity');
    const targetCountEl = document.getElementById('targetCount');
    const durationEl = document.getElementById('duration');

    // Panel controls
    const sideWrap = document.getElementById('sideWrap');
    const floatingToggle = document.getElementById('floatingToggle');
    const togglePanelBtn = document.getElementById('togglePanelBtn');
    function togglePanel(force){
      const willClose = force !== undefined ? !force : sideWrap.classList.contains('closed') === false;
      if (willClose) {
        sideWrap.classList.add('closed');
        sideWrap.setAttribute('aria-expanded','false');
      } else {
        sideWrap.classList.remove('closed');
        sideWrap.setAttribute('aria-expanded','true');
      }
    }
    floatingToggle.addEventListener('click', ()=>togglePanel());
    togglePanelBtn.addEventListener('click', ()=>togglePanel());

    let stream = null;
    let raf = null;
    let w = 0, h = 0;

    // Game state
    let running = false;
    let timeLeft = 60;
    let score = 0;

    // Dragon state
    const dragon = {
      x: 0, y: 0,
      vx: 0, vy: 0,
      trail: [],
      maxTrail: 28,
      mouthRadius: 24,
      color: '#f4c430',
    };

    // Target items
    const GOOD_WORDS = ['ç¦','æ˜¥','è²¡','å–œ','ç™¼','å‰','åˆ©','æ—º','å®‰','é †','é¾'];
    const BAD_THINGS = ['ğŸ•','âš½','ğŸ§','âš ï¸','ğŸ§Š','ğŸ§¦','ğŸ§½','ğŸ–Šï¸','ğŸ“','ğŸ§±','ğŸ§µ'];

    let items = [];

    // Offscreen for detection
    const detectCanvas = document.createElement('canvas');
    const detectCtx = detectCanvas.getContext('2d', { willReadFrequently: true });

    function resize() {
      const rect = canvas.getBoundingClientRect();
      const dpr = Math.min(window.devicePixelRatio || 1, 2);
      w = Math.floor(rect.width * dpr);
      h = Math.floor(rect.height * dpr);
      canvas.width = w;
      canvas.height = h;
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';
      detectCanvas.width = Math.floor(w/3);
      detectCanvas.height = Math.floor(h/3);
      ctx.setTransform(dpr,0,0,dpr,0,0); // keep drawing scale consistent
    }
    window.addEventListener('resize', resize);

    async function initCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        fallback.classList.remove('active');
      } catch (e) {
        console.warn('Camera init failed', e);
        fallback.classList.add('active');
      }
    }

    function spawnItems() {
      items = [];
      const count = parseInt(targetCountEl.value, 10);
      const goodRatio = 0.7;
      const goodCount = Math.max(1, Math.round(count * goodRatio));
      const badCount = Math.max(1, count - goodCount);

      const pad = 40;
      function randPos() {
        return {
          x: Math.random() * (w - pad*2) + pad,
          y: Math.random() * (h - pad*2) + pad
        };
      }

      for (let i=0;i<goodCount;i++){
        const pos = randPos();
        items.push({
          type:'good',
          label: GOOD_WORDS[Math.floor(Math.random()*GOOD_WORDS.length)],
          x: pos.x, y: pos.y,
          r: 24 + Math.random()*10,
          alive: true,
          vx: (Math.random()-.5)*0.6,
          vy: (Math.random()-.5)*0.6,
        });
      }
      for (let i=0;i<badCount;i++){
        const pos = randPos();
        items.push({
          type:'bad',
          label: BAD_THINGS[Math.floor(Math.random()*BAD_THINGS.length)],
          x: pos.x, y: pos.y,
          r: 22 + Math.random()*10,
          alive: true,
          vx: (Math.random()-.5)*0.6,
          vy: (Math.random()-.5)*0.6,
        });
      }
    }

    function startGame() {
      if (running) return;
      running = true;
      score = 0;
      timeLeft = parseInt(durationEl.value, 10);
      scoreEl.textContent = score;
      timeEl.textContent = timeLeft;
      startBtn.disabled = true;
      resetBtn.disabled = false;
      spawnItems();
      loop();
      countdown();
      // è‡ªå‹•æ”¶èµ·è¨­å®šï¼Œé¿å…é®æ“‹
      sideWrap.classList.add('closed');
      sideWrap.setAttribute('aria-expanded','false');
    }

    function resetGame() {
      running = false;
      cancelAnimationFrame(raf);
      spawnItems();
      score = 0;
      scoreEl.textContent = 0;
      timeLeft = parseInt(durationEl.value, 10);
      timeEl.textContent = timeLeft;
      startBtn.disabled = false;
      resetBtn.disabled = true;
      dragon.trail = [];
    }

    function countdown() {
      const t = setInterval(() => {
        if (!running) { clearInterval(t); return; }
        timeLeft--;
        timeEl.textContent = timeLeft;
        if (timeLeft <= 0) {
          running = false;
          startBtn.disabled = false;
          resetBtn.disabled = true;
          clearInterval(t);
          toast(`æ™‚é–“åˆ°ï¼ä½ çš„åˆ†æ•¸ï¼š${score}`, 2400);
        }
      }, 1000);
    }

    // Simple toast
    let toastTimer = null;
    function toast(msg, ms=1400){
      const hint = document.querySelector('.hint');
      const prev = hint.textContent;
      hint.textContent = msg;
      hint.style.background = '#1e2b4dcc';
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> {
        hint.textContent = 'æç¤ºï¼šæŠŠæ‰‹æ©Ÿå¾Œç½®é¡é ­å°æº–ä½ æ‰‹ä¸Šç”¨ç­·å­æ‹ä½çš„ç«é¾å…¬ä»”ï¼Œè¼•è¼•æ®å‹•ä¾†æ§åˆ¶ç•«é¢å…§çš„ç«é¾æ–¹å‘ï¼';
        hint.style.background = '#0f1d35cc';
      }, ms);
    }

    // Color detection: find largest red-ish area
    function detectControlPoint() {
      if (!video.videoWidth) return null;
      detectCtx.drawImage(video, 0, 0, detectCanvas.width, detectCanvas.height);
      const { data, width, height } = detectCtx.getImageData(0, 0, detectCanvas.width, detectCanvas.height);

      const Rmin = 120, Gmax = 110, Bmax = 110;
      let bestScore = 0, sumX = 0, sumY = 0, count = 0;

      for (let y=0; y<height; y++) {
        for (let x=0; x<width; x++) {
          const i = (y*width + x)*4;
          const r = data[i], g = data[i+1], b = data[i+2];
          if (r > Rmin && g < Gmax && b < Bmax && r > g + 30 && r > b + 30) {
            const wgt = r - Math.max(g,b);
            bestScore += wgt;
            sumX += x * wgt;
            sumY += y * wgt;
            count++;
          }
        }
      }
      if (count < 50) return null;

      const cx = sumX / bestScore;
      const cy = sumY / bestScore;

      const scaleX = w / detectCanvas.width;
      const scaleY = h / detectCanvas.height;
      const x = (width - cx) * scaleX; // mirror
      const y = cy * scaleY;
      return { x, y };
    }

    function updateDragon(target) {
      const sens = parseFloat(sensitivityEl.value);
      const maxSpeed = 18 * sens;

      if (target) {
        const ax = (target.x - dragon.x) * 0.15 * sens;
        const ay = (target.y - dragon.y) * 0.15 * sens;
        dragon.vx = (dragon.vx + ax);
        dragon.vy = (dragon.vy + ay);
      } else {
        dragon.vx *= 0.95;
        dragon.vy *= 0.95;
      }

      const speed = Math.hypot(dragon.vx, dragon.vy);
      if (speed > maxSpeed) {
        dragon.vx = dragon.vx / speed * maxSpeed;
        dragon.vy = dragon.vy / speed * maxSpeed;
      }

      dragon.x += dragon.vx;
      dragon.y += dragon.vy;

      dragon.x = Math.max(0, Math.min(w, dragon.x));
      dragon.y = Math.max(0, Math.min(h, dragon.y));

      dragon.trail.push({ x: dragon.x, y: dragon.y });
      if (dragon.trail.length > dragon.maxTrail) dragon.trail.shift();
    }

    function moveItems() {
      for (const it of items) {
        if (!it.alive) continue;
        it.x += it.vx;
        it.y += it.vy;
        if (it.x < it.r || it.x > w - it.r) it.vx *= -1;
        if (it.y < it.r || it.y > h - it.r) it.vy *= -1;
      }
    }

    function checkCollisions() {
      for (const it of items) {
        if (!it.alive) continue;
        const d = Math.hypot(it.x - dragon.x, it.y - dragon.y);
        if (d < (dragon.mouthRadius + it.r)*0.8) {
          it.alive = false;
          if (it.type === 'good') {
            score += 5;
            flash('#f4c430');
            toast(`é£Ÿåˆ°ã€Œ${it.label}ã€ï¼+5 åˆ†`, 800);
          } else {
            score -= 3;
            flash('#9aa4b2');
            toast(`å’¦ï½é£ŸéŒ¯å’—ï¼ˆ${it.label}ï¼‰-3 åˆ†`, 1000);
          }
          scoreEl.textContent = score;
        }
      }

      const aliveCount = items.filter(i=>i.alive).length;
      if (aliveCount <= 2 && running) {
        spawnItems();
      }
    }

    let flashAlpha = 0;
    let flashColor = '#ffffff';
    function flash(color){
      flashColor = color;
      flashAlpha = 0.4;
    }

    function drawBackground() {
      const g = ctx.createLinearGradient(0, 0, 0, h);
      g.addColorStop(0, 'rgba(12,16,28,0.7)');
      g.addColorStop(1, 'rgba(10,20,36,0.2)');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);

      for (let i=0;i<24;i++){
        ctx.strokeStyle = `rgba(244,196,48,${0.06 + Math.random()*0.04})`;
        ctx.lineWidth = 1;
        ctx.beginPath();
        const x = (i/24)*w + Math.sin(i)*12;
        ctx.moveTo(x, 0);
        ctx.lineTo(x + Math.sin(i*2)*8, h);
        ctx.stroke();
      }
    }

    function drawItems() {
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      for (const it of items) {
        if (!it.alive) continue;
        ctx.beginPath();
        ctx.arc(it.x, it.y, it.r, 0, Math.PI*2);
        ctx.fillStyle = it.type==='good' ? 'rgba(244,196,48,0.18)' : 'rgba(154,164,178,0.18)';
        ctx.strokeStyle = it.type==='good' ? '#f4c430' : '#9aa4b2';
        ctx.lineWidth = 2;
        ctx.fill();
        ctx.stroke();

        ctx.fillStyle = it.type==='good' ? '#ffedb2' : '#e4e7ee';
        ctx.font = `${Math.max(14, it.r)}px system-ui, "Noto Color Emoji", "Apple Color Emoji"`;
        ctx.fillText(it.label, it.x, it.y+1);
      }
    }

    function drawDragon() {
      for (let i=0;i<dragon.trail.length;i++){
        const p = dragon.trail[i];
        const t = i / dragon.trail.length;
        const r = 8 + t*22;
        ctx.beginPath();
        ctx.arc(p.x, p.y, r, 0, Math.PI*2);
        ctx.fillStyle = `rgba(255,120,40,${0.05 + t*0.08})`;
        ctx.fill();
      }

      ctx.save();
      ctx.translate(dragon.x, dragon.y);
      const angle = Math.atan2(dragon.vy, dragon.vx);
      ctx.rotate(angle);

      ctx.beginPath();
      ctx.arc(0, 0, dragon.mouthRadius, 0, Math.PI*2);
      ctx.fillStyle = '#f4c430';
      ctx.fill();

      ctx.fillStyle = '#3a1a0a';
      ctx.beginPath(); ctx.arc(6, -6, 3, 0, Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(6,  6, 3, 0, Math.PI*2); ctx.fill();

      ctx.strokeStyle = '#ffcf6e';
      ctx.lineWidth = 3;
      ctx.beginPath(); ctx.moveTo(-8, -16); ctx.lineTo(-16, -26); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(-8,  16); ctx.lineTo(-16,  26); ctx.stroke();

      const flame = Math.min(18, Math.hypot(dragon.vx, dragon.vy));
      const grad = ctx.createLinearGradient(0,0,flame*2,0);
      grad.addColorStop(0,'#ffda75');
      grad.addColorStop(1,'#ff6a00');
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.moveTo(0, -10);
      ctx.quadraticCurveTo(flame*1.2, 0, 0, 10);
      ctx.closePath();
      ctx.fill();

      ctx.restore();
    }

    function drawFlash() {
      if (flashAlpha > 0) {
        ctx.fillStyle = hexToRgba(flashColor, flashAlpha);
        ctx.fillRect(0,0,w,h);
        flashAlpha *= 0.85;
        if (flashAlpha < 0.02) flashAlpha = 0;
      }
    }

    function hexToRgba(hex, a){
      const m = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      if (!m) return `rgba(255,255,255,${a})`;
      return `rgba(${parseInt(m[1],16)},${parseInt(m[2],16)},${parseInt(m[3],16)},${a})`;
    }

    function loop() {
      if (!running) { renderFrame(); return; }
      raf = requestAnimationFrame(loop);
      step();
      renderFrame();
    }

    function step() {
      const target = detectControlPoint();
      if (dragon.trail.length === 0) {
        dragon.x = target ? target.x : w*0.5;
        dragon.y = target ? target.y : h*0.6;
      }
      updateDragon(target);
      moveItems();
      checkCollisions();
    }

    function renderFrame() {
      resize();
      ctx.clearRect(0,0,w,h);
      drawBackground();
      drawItems();
      drawDragon();
      drawFlash();
    }

    // Wire UI
    startBtn.addEventListener('click', startGame);
    resetBtn.addEventListener('click', resetGame);
    retryBtn?.addEventListener('click', initCamera);
    sensitivityEl.addEventListener('input', ()=>{
      toast('å·²èª¿æ•´éˆæ•åº¦', 700);
    });
    targetCountEl.addEventListener('input', ()=>{
      spawnItems();
    });
    durationEl.addEventListener('input', ()=>{
      timeLeft = parseInt(durationEl.value,10);
      timeEl.textContent = timeLeft;
    });

    // Kick off
    (async function(){
      resize();
      await initCamera();
      renderFrame();
    })();
  </script>
</body>
</html>
