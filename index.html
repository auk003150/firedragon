<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>å¤§å‘èˆç«é¾ AR éŠæˆ²</title>
  <!-- A-Frame èˆ‡ AR.js -->
  <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.5/aframe/build/aframe-ar.js"></script>
  <style>
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;
      font-family: "Noto Sans TC", "Microsoft JhengHei", system-ui, -apple-system, sans-serif;
      background: #000 url('image_1.png') center center / cover fixed no-repeat;
    }
    #ar-container {
      position: relative;
      width: 100%; height: 100%;
    }
    /* é¡åƒæ™‚ç¿»è½‰ç•«é¢èˆ‡ç›¸æ©Ÿå½±åƒ */
    .mirrored canvas, .mirrored video {
      transform: scaleX(-1);
      transform-origin: center;
    }
    /* è¦†è“‹å¼ UI */
    #hud {
      pointer-events: none;
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 12px;
      color: #fff;
      text-shadow: 0 2px 6px rgba(0,0,0,0.8);
    }
    #top-bar {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .pill {
      pointer-events: auto;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      backdrop-filter: blur(4px);
    }
    .pill strong { font-weight: 700; }
    #message {
      min-width: 120px;
      text-align: center;
      font-weight: 700;
      color: #ffeb3b;
    }
    #mirror-btn {
      cursor: pointer;
      user-select: none;
      transition: transform 0.15s ease, background 0.2s ease;
    }
    #mirror-btn:hover { transform: translateY(-1px); }
    #mirror-btn:active { transform: translateY(1px) scale(0.98); }
    #bottom-hint {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-width: 480px;
    }
    .hint-box {
      pointer-events: auto;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 13px;
      line-height: 1.5;
      backdrop-filter: blur(4px);
    }
    @media (max-width: 600px) {
      #top-bar { gap: 8px; }
      .pill { font-size: 13px; padding: 7px 10px; }
    }
  </style>
</head>
<body>
  <div id="ar-container">
    <!-- A-Frame + AR.js å ´æ™¯ -->
    <a-scene
      embedded
      vr-mode-ui="enabled: false"
      renderer="antialias: true; alpha: true; precision: mediump;"
      arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; patternRatio: 0.9;"
      id="scene"
    >
      <!-- å…‰æº -->
      <a-entity light="type: ambient; intensity: 0.9; color: #ffffff"></a-entity>
      <a-entity light="type: point; intensity: 1.2; distance: 8; decay: 2; color: #ffbb66" position="0 1.5 1.5"></a-entity>

      <!-- hiro marker -->
      <a-marker type="hiro" id="hiro-marker">
        <!-- ç«é¾æ ¹çµé» -->
        <a-entity id="dragon-root" position="0 0 0" rotation="0 0 0">
          <!-- ç«¹æ† -->
          <a-cylinder position="0 0.2 0" radius="0.025" height="0.6" color="#8b5a2b" material="metalness:0.1; roughness:0.8"></a-cylinder>
          <!-- æ‰‹æŸ„ç¹© -->
          <a-torus position="0 -0.1 0" radius="0.05" radius-tubular="0.006" color="#c8a06a"></a-torus>
          <!-- ç«é ­ -->
          <a-entity id="spark-head" position="0 0.5 0" rotation="0 0 0">
            <a-sphere radius="0.07" color="#cc3300" material="emissive:#ff6600; emissiveIntensity:0.7; roughness:0.4; metalness:0.1"></a-sphere>
            <a-torus radius="0.12" radius-tubular="0.008" color="#ffcc00"
                     material="emissive:#ffcc00; emissiveIntensity:0.6"
                     animation="property: rotation; to: 0 0 360; dur: 4000; loop: true; easing: linear"></a-torus>
          </a-entity>
        </a-entity>
      </a-marker>

      <!-- æ¼‚æµ®å­—å¡å®¹å™¨ï¼ˆä¸–ç•Œåº§æ¨™ï¼Œéè·Ÿ markerï¼‰ -->
      <a-entity id="items-root"></a-entity>

      <!-- ç›¸æ©Ÿ -->
      <a-entity camera position="0 0 0"></a-entity>
    </a-scene>

    <!-- HUD -->
    <div id="hud">
      <div id="top-bar">
        <div class="pill"><strong>åˆ†æ•¸ï¼š</strong><span id="score">0</span></div>
        <div class="pill"><strong>å‘½ä¸­ï¼š</strong><span id="hits">0</span></div>
        <div class="pill" id="message">è«‹å°æº– hiro æ¨™è¨˜</div>
        <div class="pill" id="mirror-btn">ğŸ” é¡åƒï¼š<span id="mirror-state">é—œ</span></div>
      </div>
      <div id="bottom-hint">
        <div class="hint-box">
          ğŸ“Œ éŠæˆ²èªªæ˜ï¼š<br>
          1. é¡¯ç¤º hiro markerï¼ŒAR ç«é¾æœƒå‡ºç¾ã€‚<br>
          2. ä»¥ç«é¾å»ç¢°æ’æ¼‚æµ®å­—å¡ï¼š<strong>ã€Œç¦æ˜¥è²¡å®‰æ—ºå‰ç¥¥è³€é¾å¹´ã€</strong> +15 åˆ†ï¼Œå…¶å®ƒåœ–ç¤ºæ‰£ 5 åˆ†ã€‚<br>
          3. å¯é»ã€Œé¡åƒã€åˆ‡æ›å·¦å³ç¿»è½‰ï¼Œæ–¹ä¾¿è‡ªæ‹è¦–è§’ã€‚
        </div>
      </div>
    </div>
  </div>

  <script>
    // -------- éŠæˆ²é‚è¼¯ --------
    const goodChars = ['ç¦','æ˜¥','è²¡','å®‰','æ—º','å‰','ç¥¥','è³€','é¾','å¹´'];
    const badChars = ['âš½','ğŸ”','ğŸ§','ğŸ§Š','ğŸ§¼','ğŸº','ğŸ’¡','ğŸ“','ğŸ§½','ğŸ§¯'];
    const itemsRoot = document.getElementById('items-root');
    const marker = document.getElementById('hiro-marker');
    const dragon = document.getElementById('dragon-root');
    const sparkHead = document.getElementById('spark-head');
    const scoreEl = document.getElementById('score');
    const hitsEl = document.getElementById('hits');
    const msgEl = document.getElementById('message');
    const mirrorBtn = document.getElementById('mirror-btn');
    const mirrorStateEl = document.getElementById('mirror-state');
    const arContainer = document.getElementById('ar-container');
    const sceneEl = document.getElementById('scene');

    let score = 0;
    let hits = 0;
    let items = [];
    const maxItems = 10;
    const collisionRadius = 0.25;
    const spawnArea = {
      xMin: -1.4, xMax: 1.4,
      yMin: 0.4,  yMax: 1.4,
      zMin: -1.8, zMax: -0.6
    };

    // å»ºç«‹ç«èŠ±åˆºï¼ˆè¼»å°„ç‹€ï¼‰
    function buildSparks() {
      const count = 38;
      for (let i = 0; i < count; i++) {
        const cyl = document.createElement('a-cylinder');
        const len = 0.26 + Math.random()*0.08;
        cyl.setAttribute('radius', 0.005 + Math.random()*0.003);
        cyl.setAttribute('height', len);
        cyl.setAttribute('color', '#ffdd66');
        cyl.setAttribute('material', 'emissive:#ff8800; emissiveIntensity:0.9; metalness:0.2; roughness:0.3');
        // éš¨æ©Ÿæ–¹å‘
        const yaw = Math.random()*360;
        const pitch = -70 + Math.random()*140; // -70~70 åº¦
        cyl.setAttribute('rotation', `${pitch} ${yaw} 0`);
        cyl.setAttribute('position', '0 0 0');
        sparkHead.appendChild(cyl);
      }
    }

    // å»ºç«‹å–®ä¸€å­—å¡ï¼ˆä½¿ç”¨ canvas ç”Ÿæˆ dataURLï¼Œè‡ªå«è³‡æºï¼‰
    function createCard(char, isGood) {
      const size = 256;
      const canvas = document.createElement('canvas');
      canvas.width = canvas.height = size;
      const ctx = canvas.getContext('2d');
      // èƒŒæ™¯
      ctx.fillStyle = 'rgba(0,0,0,0.4)';
      ctx.fillRect(0,0,size,size);
      // é‚Šæ¡†
      ctx.strokeStyle = isGood ? '#ffdd33' : '#33d2ff';
      ctx.lineWidth = 10;
      ctx.strokeRect(8,8,size-16,size-16);
      // æ–‡å­—
      ctx.fillStyle = isGood ? '#ffef8a' : '#7fddff';
      ctx.font = 'bold 160px "Noto Sans TC", "Microsoft JhengHei", sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(char, size/2, size/2 + 10);
      // å°å…‰æšˆ
      ctx.shadowColor = isGood ? 'rgba(255,220,80,0.75)' : 'rgba(80,200,255,0.75)';
      ctx.shadowBlur = 28;
      // è½‰æˆ dataURL
      const dataURL = canvas.toDataURL();
      const el = document.createElement('a-image');
      el.setAttribute('src', dataURL);
      el.setAttribute('transparent', true);
      el.setAttribute('width', 0.36);
      el.setAttribute('height', 0.36);
      // åˆå§‹éš¨æ©Ÿä½ç½®
      const pos = randomPos();
      el.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
      // ç·©æ…¢æ¼‚æµ®å‹•ç•«
      const dy = (Math.random()*0.2 + 0.05).toFixed(3);
      el.setAttribute('animation', `property: position; dir: alternate; dur: ${2500 + Math.random()*1500}; loop: true; to: ${pos.x} ${(pos.y + parseFloat(dy)).toFixed(3)} ${pos.z}`);
      // æ—‹è½‰å°æŠ–å‹•
      el.setAttribute('animation__rot', `property: rotation; dir: alternate; dur: ${2000 + Math.random()*1500}; loop: true; to: ${-5 + Math.random()*10} ${Math.random()*360} ${-5 + Math.random()*10}`);
      itemsRoot.appendChild(el);
      return { el, isGood, collected: false };
    }

    function randomPos() {
      return {
        x: rand(spawnArea.xMin, spawnArea.xMax),
        y: rand(spawnArea.yMin, spawnArea.yMax),
        z: rand(spawnArea.zMin, spawnArea.zMax)
      };
    }
    function rand(min, max) { return Math.random() * (max - min) + min; }

    function spawnUntilFull() {
      while (items.length < maxItems) {
        const isGood = Math.random() < 0.6;
        const char = (isGood ? goodChars : badChars)[Math.floor(Math.random() * (isGood ? goodChars.length : badChars.length))];
        const card = createCard(char, isGood);
        items.push(card);
      }
    }

    function updateUIMessage(text, color='#ffeb3b') {
      msgEl.textContent = text;
      msgEl.style.color = color;
    }

    // é¡åƒåˆ‡æ›
    let mirrored = false;
    mirrorBtn.addEventListener('click', () => {
      mirrored = !mirrored;
      if (mirrored) {
        arContainer.classList.add('mirrored');
        mirrorStateEl.textContent = 'é–‹';
      } else {
        arContainer.classList.remove('mirrored');
        mirrorStateEl.textContent = 'é—œ';
      }
    });

    // ç¢°æ’æª¢æ¸¬
    function checkCollisions() {
      if (!marker.object3D.visible) return;
      const dragonWorld = new THREE.Vector3();
      dragon.object3D.getWorldPosition(dragonWorld);
      const camera = sceneEl.camera;
      const camWorld = new THREE.Vector3();
      if (camera) camera.getWorldPosition(camWorld);

      items.forEach((item, idx) => {
        if (item.collected) return;
        const obj = item.el.object3D;
        const itemWorld = new THREE.Vector3();
        obj.getWorldPosition(itemWorld);

        // è®“å­—å¡é¢å‘ç›¸æ©Ÿ
        if (camera) {
          obj.lookAt(camWorld);
        }

        const dist = dragonWorld.distanceTo(itemWorld);
        if (dist < collisionRadius) {
          // å‘½ä¸­
          item.collected = true;
          hits += 1;
          hitsEl.textContent = hits;
          if (item.isGood) {
            score += 15;
            flashItem(item.el, '#ffeb3b');
            updateUIMessage('å¥½å½©ï¼+15', '#ffeb3b');
          } else {
            score -= 5;
            flashItem(item.el, '#66d0ff');
            updateUIMessage('æ‰£ 5 åˆ†ï¼Œå°å¿ƒï¼', '#66d0ff');
          }
          scoreEl.textContent = score;
          // ç§»é™¤ä¸¦è£œ spawn
          setTimeout(() => {
            if (item.el && item.el.parentNode) item.el.parentNode.removeChild(item.el);
          }, 120);
          // å»¶å¾Œç§»é™¤é™£åˆ—ä¸¦è£œæ–°
          setTimeout(() => {
            items = items.filter((it, j) => j !== idx);
            spawnUntilFull();
          }, 150);
        }
      });
    }

    function flashItem(el, color) {
      el.setAttribute('animation__hit', `property: scale; to: 1.4 1.4 1.4; dur: 140; dir: alternate; easing: easeOutQuad`);
      el.setAttribute('material', `color: ${color}; opacity: 0.9`);
    }

    // ä¸»å¾ªç’°
    function tickLoop() {
      checkCollisions();
      requestAnimationFrame(tickLoop);
    }

    // åˆå§‹åŒ–
    buildSparks();
    spawnUntilFull();
    updateUIMessage('è«‹å°æº– hiro æ¨™è¨˜');
    tickLoop();

    // ç›£è½ marker å¯è¦‹æ€§ï¼Œæ›´æ–°æç¤º
    marker.addEventListener('markerFound', () => {
      updateUIMessage('è¿½è¹¤ä¸­ï¼Œé–‹å§‹èˆç«é¾ï¼', '#7cf5a6');
    });
    marker.addEventListener('markerLost', () => {
      updateUIMessage('è«‹æŠŠ hiro æ¨™è¨˜ä¿æŒåœ¨ç•«é¢å…§', '#ffeb3b');
    });
  </script>
</body>
</html>
