<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Hiro Marker AR Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <!-- AR.js for A-Frame -->
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
  
  <style>
    html, body { margin: 0; padding: 0; overflow: hidden; }
    body { font-family: system-ui, -apple-system, "Helvetica Neue", Arial, sans-serif; }
    
    /* UI Overlay */
    .overlay {
      position: fixed;
      top: 0; left: 0; right: 0;
      display: flex; justify-content: space-between; align-items: flex-start;
      padding: 12px 16px;
      background: linear-gradient(180deg, rgba(0,0,0,0.65), rgba(0,0,0,0));
      color: #fff; z-index: 10; pointer-events: none;
      font-size: 14px;
    }
    
    .score-board {
      background: rgba(255, 193, 7, 0.9);
      color: #000;
      padding: 8px 16px;
      border-radius: 12px;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      border: 2px solid #fff;
    }

    .hint {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      padding: 10px 14px;
      background: linear-gradient(0deg, rgba(0,0,0,0.8), rgba(0,0,0,0));
      color: #fff; z-index: 10; text-align: center;
      font-size: 13px; pointer-events: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
    
    .badge {
      background: rgba(255,255,255,0.12);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.2);
      pointer-events: auto;
      margin-bottom: 5px;
      display: inline-block;
    }
    
    .link {
      color: #9ad6ff; text-decoration: underline; pointer-events: auto;
    }

    /* ç¢°æ’æ™‚çš„æµ®å‹•åˆ†æ•¸å‹•ç•« */
    .float-score {
      position: absolute;
      font-weight: bold;
      font-size: 24px;
      animation: fadeUp 1s forwards;
      pointer-events: none;
      z-index: 20;
    }
    
    @keyframes fadeUp {
      0% { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
    }

    @media (max-width: 640px) {
      .overlay { font-size: 13px; padding: 10px 12px; }
      .hint { font-size: 12px; padding: 8px 12px; }
    }
  </style>

  <script>
    // éŠæˆ²æ•¸æ“š
    const GOOD_WORDS = ['ç¦', 'æ˜¥', 'è²¡', 'å®‰', 'æ—º', 'å‰', 'ç¥¥', 'è³€', 'é¾', 'å¹´'];
    const BAD_WORDS = ['âš½', 'ğŸ”', 'ğŸ§', 'ğŸ§Š', 'ğŸ§¼', 'ğŸº', 'ğŸ’¡', 'ğŸ“', 'ğŸ§½', 'ğŸ§¯'];
    
    let score = 0;
    let markerVisible = false;
    let markerPosition = new THREE.Vector3();

    // è¨»å†Šä¸€å€‹çµ„ä»¶ä¾†è™•ç†éŠæˆ²é‚è¼¯
    AFRAME.registerComponent('game-logic', {
      init: function () {
        this.marker = document.querySelector('#hiro-marker');
        this.scene = document.querySelector('a-scene');
        this.camera = document.querySelector('[camera]');
        
        // ç›£è½ Marker ç‹€æ…‹
        this.marker.addEventListener('markerFound', () => {
          markerVisible = true;
          document.getElementById('status-text').innerText = "éŠæˆ²é€²è¡Œä¸­ï¼ç§»å‹•æ¨™è¨˜å»æ’æ“Šæ–‡å­—";
          document.getElementById('status-text').style.color = "#4caf50";
        });
        this.marker.addEventListener('markerLost', () => {
          markerVisible = false;
          document.getElementById('status-text').innerText = "å°‹æ‰¾ Hiro æ¨™è¨˜ä¸­...";
          document.getElementById('status-text').style.color = "#ff9800";
        });

        // å®šæ™‚ç”Ÿæˆç‰©é«” (æ¯ 1.5 ç§’)
        setInterval(() => {
          if (document.hidden) return; // é é¢éš±è—æ™‚ä¸ç”Ÿæˆ
          this.spawnItem();
        }, 1500);
      },

      tick: function () {
        if (!markerVisible) return;

        // æ›´æ–° Marker çš„ä¸–ç•Œåº§æ¨™
        // æ³¨æ„ï¼šåœ¨ AR.js ä¸­ï¼ŒMarker é€šå¸¸æ˜¯å›ºå®šçš„ï¼ŒCamera åœ¨å‹•ï¼Œ
        // ä½†ç‚ºäº†è¨ˆç®—ç›¸å°è·é›¢ï¼Œæˆ‘å€‘éœ€è¦ç²å– Marker å…§å®¹ç‰©é«”çš„ä¸–ç•Œåº§æ¨™ã€‚
        const playerObj = document.querySelector('#player-box');
        const playerPos = new THREE.Vector3();
        playerObj.object3D.getWorldPosition(playerPos);

        // æª¢æŸ¥æ‰€æœ‰æ¼‚æµ®ç‰©é«”
        const items = document.querySelectorAll('.floating-item');
        items.forEach(item => {
          if (item.getAttribute('data-hit') === 'true') return; // å·²ç¶“æ’éçš„å¿½ç•¥

          const itemPos = new THREE.Vector3();
          item.object3D.getWorldPosition(itemPos);

          // è¨ˆç®—è·é›¢ (ç°¡å–®çš„çƒé«”ç¢°æ’æª¢æ¸¬)
          const distance = playerPos.distanceTo(itemPos);

          // é–¾å€¼è¨­ç‚º 0.8 (æ ¹æ“šç‰©é«”å¤§å°èª¿æ•´)
          if (distance < 0.8) {
            this.handleCollision(item, playerPos);
          }
        });
      },

      spawnItem: function () {
        // éš¨æ©Ÿæ±ºå®šæ˜¯å¥½è©é‚„æ˜¯å£è© (60% æ©Ÿç‡å‡ºå¥½è©)
        const isGood = Math.random() > 0.4;
        const textSet = isGood ? GOOD_WORDS : BAD_WORDS;
        const text = textSet[Math.floor(Math.random() * textSet.length)];
        const color = isGood ? '#FFD700' : '#FF5252'; // é‡‘è‰² vs ç´…è‰²

        const el = document.createElement('a-entity');
        el.setAttribute('class', 'floating-item');
        el.setAttribute('data-type', isGood ? 'good' : 'bad');
        el.setAttribute('data-hit', 'false');

        // éš¨æ©Ÿä½ç½®ç”Ÿæˆ (åœ¨ç›¸æ©Ÿè¦–é‡å‰æ–¹çš„ä¸€å€‹ç¯„åœå…§)
        // X: -3 åˆ° 3, Y: -1 åˆ° 3, Z: -5 åˆ° -2 (ç›¸æ©Ÿå‰æ–¹)
        // é€™è£¡æˆ‘å€‘å°‡ç‰©é«”æ”¾åœ¨ä¸–ç•Œåº§æ¨™ç³»ä¸­ï¼Œè€Œä¸æ˜¯ç¶å®šåœ¨ Marker ä¸Š
        const x = (Math.random() - 0.5) * 6;
        const y = (Math.random() - 0.5) * 4; 
        const z = - (Math.random() * 3 + 2); // è·é›¢ç›¸æ©Ÿ 2~5 ç±³è™•

        el.setAttribute('position', `${x} ${y} ${z}`);

        // å‰µå»ºæ–‡å­—å¯¦é«” (ç‚ºäº†æ”¯æ´ä¸­æ–‡ï¼Œéœ€è¦ä½¿ç”¨æ”¯æ´ unicode çš„å­—é«”ï¼Œæˆ–è€…é€™è£¡ç”¨ text çµ„ä»¶çš„é»˜èªå­—é«”å¯èƒ½ä¸æ”¯æ´ä¸­æ–‡)
        // ç”±æ–¼ A-Frame é»˜èªå­—é«”ä¸æ”¯æ´ä¸­æ–‡ï¼Œé€™è£¡æˆ‘å€‘ä½¿ç”¨ä¸€å€‹é–‹æºçš„ä¸­æ–‡å­—é«” MSDFï¼Œæˆ–è€…ç°¡å–®åœ°ç”¨åœ–ç‰‡ä»£æ›¿ã€‚
        // ç‚ºäº†æ¼”ç¤ºæ–¹ä¾¿ä¸”ç¢ºä¿ä»£ç¢¼å–®ä¸€æ€§ï¼Œæˆ‘å€‘ä½¿ç”¨ A-Frame é»˜èª textï¼Œä½†é€™é€šå¸¸ç„¡æ³•é¡¯ç¤ºä¸­æ–‡ã€‚
        // **ä¿®æ­£ç­–ç•¥**ï¼šç‚ºäº†ç¢ºä¿ä¸­æ–‡é¡¯ç¤ºï¼Œæˆ‘å€‘ä½¿ç”¨ HTML Canvas ç¹ªè£½æ–‡å­—è½‰ç‚º Textureï¼Œæˆ–è€…ä½¿ç”¨ a-text çš„ custom fontã€‚
        // é€™è£¡æ¡ç”¨æœ€ç°¡å–®çš„æ›¿ä»£æ–¹æ¡ˆï¼šå¦‚æœç„¡æ³•åŠ è¼‰ä¸­æ–‡å­—é«”ï¼Œå»ºè­°ç”¨ Emoji æˆ–ç°¡å–®åœ–å½¢ã€‚
        // ä½†æ—¢ç„¶é¡Œç›®è¦æ±‚ç‰¹å®šä¸­æ–‡å­—ï¼Œæˆ‘å€‘å˜—è©¦ä½¿ç”¨é–‹æºçš„ Noto Sans CJK MSDF å­—é«” URL (å¦‚æœæœ‰)ï¼Œ
        // æˆ–è€…æ›´ç©©å¥çš„æ–¹æ³•ï¼šä½¿ç”¨ Canvas è²¼åœ–ã€‚ä¸‹é¢æˆ‘ç”¨ä¸€å€‹ç°¡å–®çš„ Canvas è²¼åœ–çµ„ä»¶ä¾†è§£æ±ºä¸­æ–‡é¡¯ç¤ºå•é¡Œã€‚
        
        el.setAttribute('canvas-text', `text: ${text}; color: ${color}`);
        
        // æ·»åŠ å‹•ç•«ï¼šç·©æ…¢é£„å‘ç›¸æ©Ÿæˆ–éš¨æ©Ÿç§»å‹•
        el.setAttribute('animation', `property: position; to: ${x} ${y + 1} ${z + 2}; dur: 8000; easing: linear`);
        
        // æ·»åŠ è‡ªæ¯€è¨ˆæ™‚å™¨ (10ç§’å¾Œæ¶ˆå¤±)
        setTimeout(() => {
          if (el.parentNode) el.parentNode.removeChild(el);
        }, 10000);

        // è®“æ–‡å­—å§‹çµ‚é¢å‘ç›¸æ©Ÿ
        el.setAttribute('look-at', '[camera]');

        this.scene.appendChild(el);
      },

      handleCollision: function (item, pos) {
        item.setAttribute('data-hit', 'true');
        const type = item.getAttribute('data-type');
        
        // è¨ˆç®—åˆ†æ•¸
        let points = 0;
        if (type === 'good') {
          points = 15;
          score += 15;
          // æ’­æ”¾ä¸€å€‹ç°¡å–®çš„ç¸®æ”¾å‹•ç•«è¡¨ç¤ºè¢«åƒæ‰
          item.setAttribute('animation__hit', 'property: scale; to: 2 2 2; dur: 200; easing: easeOutQuad');
          item.setAttribute('animation__fade', 'property: opacity; to: 0; dur: 200; easing: easeOutQuad');
        } else {
          points = -5;
          score -= 5;
          // å£æ±è¥¿ç¸®å°æ¶ˆå¤±
          item.setAttribute('animation__hit', 'property: scale; to: 0.1 0.1 0.1; dur: 200; easing: easeInQuad');
        }

        // æ›´æ–° UI
        document.getElementById('score-val').innerText = score;
        this.showFloatingScore(points);

        // ç§»é™¤ç‰©é«”
        setTimeout(() => {
          if (item.parentNode) item.parentNode.removeChild(item);
        }, 200);
      },

      showFloatingScore: function(points) {
        const div = document.createElement('div');
        div.className = 'float-score';
        div.innerText = points > 0 ? `+${points}` : points;
        div.style.color = points > 0 ? '#4caf50' : '#f44336';
        div.style.left = '50%';
        div.style.top = '50%';
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 1000);
      }
    });

    // è§£æ±ºä¸­æ–‡é¡¯ç¤ºå•é¡Œçš„çµ„ä»¶ï¼šå°‡æ–‡å­—ç•«åœ¨ Canvas ä¸Šä¸¦ä½œç‚ºè²¼åœ–
    AFRAME.registerComponent('canvas-text', {
      schema: {
        text: {type: 'string', default: ''},
        color: {type: 'string', default: '#FFF'},
        width: {type: 'number', default: 256},
        height: {type: 'number', default: 256}
      },
      init: function () {
        this.canvas = document.createElement('canvas');
        this.canvas.width = this.data.width;
        this.canvas.height = this.data.height;
        this.ctx = this.canvas.getContext('2d');
        this.draw();
        
        const texture = new THREE.CanvasTexture(this.canvas);
        const material = new THREE.MeshBasicMaterial({
          map: texture,
          transparent: true,
          side: THREE.DoubleSide
        });
        const geometry = new THREE.PlaneGeometry(1, 1);
        this.mesh = new THREE.Mesh(geometry, material);
        this.el.setObject3D('mesh', this.mesh);
      },
      draw: function() {
        const ctx = this.ctx;
        const w = this.canvas.width;
        const h = this.canvas.height;
        
        ctx.clearRect(0, 0, w, h);
        
        // ç•«åœ“å½¢èƒŒæ™¯
        ctx.beginPath();
        ctx.arc(w/2, h/2, w/2 - 10, 0, 2 * Math.PI);
        ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
        ctx.fill();
        ctx.strokeStyle = this.data.color;
        ctx.lineWidth = 10;
        ctx.stroke();

        // ç•«æ–‡å­—
        ctx.font = 'bold 140px "Microsoft JhengHei", Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillStyle = this.data.color;
        ctx.fillText(this.data.text, w/2, h/2 + 15); // å¾®èª¿å‚ç›´ä½ç½®
      }
    });

    // Look-at Component (ç°¡åŒ–ç‰ˆï¼Œè®“ç‰©é«”é¢å‘ç›¸æ©Ÿ)
    AFRAME.registerComponent('look-at', {
      schema: { type: 'selector' },
      tick: function () {
        if (this.data) {
          this.el.object3D.lookAt(this.data.object3D.position);
        }
      }
    });

  </script>
</head>
<body>
  <div class="overlay">
    <div>
      <div class="badge">Hiro Marker éŠæˆ²</div>
      <div id="status-text" style="font-size: 12px; color: #ff9800;">å°‹æ‰¾ Hiro æ¨™è¨˜ä¸­...</div>
    </div>
    <div class="score-board">
      åˆ†æ•¸: <span id="score-val">0</span>
    </div>
  </div>
  
  <div class="hint">
    ç§»å‹• Hiro æ¨™è¨˜å»æ’æ“Šæ¼‚æµ®çš„å­—ï¼<br/>
    <span style="color:#FFD700">å‰åˆ©å­— +15åˆ†</span> | <span style="color:#FF5252">é›œç‰© -5åˆ†</span><br/>
    <a class="link" href="https://raw.githubusercontent.com/AR-js-org/AR.js/master/aframe/examples/marker-training/examples/pattern-files/pattern-hiro.png" target="_blank">ä¸‹è¼‰ Hiro åœ–</a>
  </div>

  <a-scene
    game-logic
    vr-mode-ui="enabled: false"
    embedded
    renderer="logarithmicDepthBuffer: true; antialias: true;"
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono; maxDetectionRate: 30;"
  >
    <!-- å…‰æº -->
    <a-entity light="type: ambient; color: #ffffff; intensity: 0.7"></a-entity>
    <a-entity light="type: directional; color: #ffffff; intensity: 0.8" position="-1 1 0"></a-entity>

    <!-- Hiro æ¨™è¨˜ (ç©å®¶æ§åˆ¶å™¨) -->
    <a-marker id="hiro-marker" preset="hiro">
      <!-- ç©å®¶çš„ç¢°æ’é«” (è¦–è¦ºåŒ–ç‚ºä¸€å€‹åŠé€æ˜ç›’å­) -->
      <a-box id="player-box" 
             position="0 0.5 0" 
             depth="0.8" height="0.8" width="0.8"
             material="color: #4FC3F7; opacity: 0.5; transparent: true"
             animation="property: rotation; to: 0 360 0; loop: true; dur: 3000; easing: linear">
      </a-box>
      <!-- æ ¸å¿ƒ -->
      <a-sphere position="0 0.5 0" radius="0.2" color="#fff"></a-sphere>
    </a-marker>

    <!-- ç›¸æ©Ÿ -->
    <a-entity camera></a-entity>
  </a-scene>
</body>
</html>
