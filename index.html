<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>å¤§å‘èˆç«é¾ AR éŠæˆ² (Hiro Marker)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

  <!-- A-Frame + AR.js + ç²’å­ç³»çµ± -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>
  <script src="https://unpkg.com/aframe-particle-system-component@1.1.3/dist/aframe-particle-system-component.min.js"></script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      background: #000;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans TC", "Helvetica Neue", Arial, "PingFang TC", "Microsoft JhengHei", sans-serif;
    }
    /* 2D UI å®¹å™¨ï¼ˆè¦†è“‹åœ¨ WebGL ä¸Šï¼‰ */
    .hud {
      position: fixed;
      inset: 0;
      pointer-events: none; /* è®“ AR äº’å‹•ä¸è¢« UI æ“‹ä½ */
    }
    .hud-inner {
      width: 100%;
      height: 100%;
      background: linear-gradient(to bottom, rgba(0,0,0,0.35), rgba(0,0,0,0.2) 30%, rgba(0,0,0,0));
    }
    .scoreboard {
      position: absolute;
      left: 12px;
      top: 12px;
      color: #fff;
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(255,255,255,0.25);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 16px;
      line-height: 1.2;
      pointer-events: auto;
      user-select: none;
      backdrop-filter: blur(6px);
    }
    .controls {
      position: absolute;
      right: 12px;
      top: 12px;
      display: flex;
      gap: 8px;
      pointer-events: auto;
    }
    .btn {
      appearance: none;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.12);
      color: #fff;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
      backdrop-filter: blur(6px);
    }
    .btn:hover {
      background: rgba(255,255,255,0.2);
    }

    /* é¡åƒæ¨£å¼ï¼šæ°´å¹³ç¿»è½‰ video èˆ‡ HUDï¼Œé¿å… UI æ–‡å­—å·¦å³é¡›å€’ */
    .mirrored .a-canvas,
    .mirrored video,
    .mirrored .hud {
      transform: scaleX(-1);
    }
    /* ä½† scoreboard/controls å…§æ–‡å­—éœ€è¦å†ç¿»å›ä¾† */
    .mirrored .scoreboard,
    .mirrored .controls {
      transform: scaleX(-1);
    }

    /* é‡å° arjs çš„ video element æŒ‡å®šå›ºå®šå±¤ç´šï¼Œæ–¹ä¾¿é¡åƒ */
    #arjs-video {
      position: fixed !important;
      left: 0; top: 0; width: 100% !important; height: 100% !important;
      object-fit: cover;
      z-index: -1; /* äº¤çµ¦ A-Frame canvas é¡¯ç¤ºï¼Œvideo åšé¡åƒåƒè€ƒ */
    }
  </style>
</head>
<body>
  <!-- 2D HUD -->
  <div class="hud">
    <div class="hud-inner"></div>
    <div class="scoreboard">
      <div>åˆ†æ•¸ï¼š<span id="score">0</span></div>
      <div style="margin-top:4px; font-size:12px; opacity:.9;">
        æ–°æ˜¥å­—åŠ 15åˆ†ï¼›å…¶ä»–æ‰£5åˆ†
      </div>
    </div>
    <div class="controls">
      <button id="mirrorBtn" class="btn">é¡åƒé–‹é—œ</button>
      <button id="resetBtn" class="btn">é‡ç½®åˆ†æ•¸</button>
    </div>
  </div>

  <!-- A-Frame / AR.js å ´æ™¯ -->
  <a-scene
    embedded
    vr-mode-ui="enabled: false"
    renderer="colorManagement: true, physicallyCorrectLights: true, logarithmicDepthBuffer: true, antialias: true"
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; trackingMethod: best; patternRatio: 0.9;"
  >
    <!-- å…¨æ™¯èƒŒæ™¯ï¼šå¤§å‘èˆç«é¾ä¸»é¡Œ -->
    <a-assets>
      <img id="bgImage" src="image_1.png" crossorigin="anonymous" />
      <!-- ç²’å­ç”¨åˆ°çš„å¯é¸è²¼åœ–ï¼ˆæ­¤ä¾‹ç”¨é è¨­å½¢ç‹€å³å¯ï¼‰ -->
    </a-assets>
    <a-sky src="#bgImage" rotation="0 -90 0"></a-sky>

    <!-- ç’°å¢ƒç‡ˆèˆ‡ä¸»å…‰ -->
    <a-entity light="type: ambient; intensity: 0.5; color: #ffffff"></a-entity>
    <a-entity light="type: directional; intensity: 0.9; color: #ffd9a6" position="0 1 1"></a-entity>

    <!-- Markerï¼šhiro -->
    <a-marker id="hiroMarker" preset="hiro">
      <!-- èˆç«é¾ä¸»é«”ï¼ˆç«¹ç«¿ + ç«èŠ±ç²’å­ + ç¢°æ’çƒï¼‰ -->
      <a-entity id="dragonRoot" position="0 0 0" rotation="0 0 0">
        <!-- ç«¹ç«¿ï¼ˆç´°é•·åœ“æŸ±ï¼‰ -->
        <a-cylinder
          id="bamboo"
          position="0 0.15 0"
          rotation="0 0 90"
          radius="0.015"
          height="0.6"
          color="#8f6d2c"
          material="roughness:0.9; metalness:0.0"
        ></a-cylinder>

        <!-- ç«é¾é ­å‰ç«¯ï¼šç”¨ä¸€å€‹å°çƒè¡¨ç¤ºç¢°æ’é» -->
        <a-sphere
          id="hitPoint"
          position="0.3 0.15 0"
          radius="0.03"
          color="#ffcc00"
          material="emissive:#ff6600; emissiveIntensity:0.7; roughness:0.6"
        ></a-sphere>

        <!-- ç«èŠ±ç²’å­ï¼ˆæ²¿è‘—é¾é ­å™´ç‘çš„ç…™èŠ±æ•ˆæœï¼‰ -->
        <a-entity id="firework"
          position="0.33 0.15 0"
          particle-system="
            preset: default;
            type: sphere;
            particleCount: 450;
            size: 0.05;
            sizeSpread: 0.03;
            color: #ffcc00, #ff5500, #ffee99;
            opacity: 0.9;
            velocityValue: 0 0 0;
            velocitySpread: 0.4 0.4 0.4;
            accelerationValue: 0 -0.2 0;
            rotationAxis: y;
            direction: 1;
            duration: 0.12;
            maxAge: 1.0;
          "
        ></a-entity>

        <!-- è¼•å¾®æ“ºå‹•å‹•ç•«ï¼Œæ¨¡æ“¬èˆå‹• -->
        <a-animation
          attribute="rotation"
          dur="1800"
          easing="ease-in-out-sine"
          direction="alternate"
          repeat="indefinite"
          to="0 10 0"
        ></a-animation>
      </a-entity>
    </a-marker>

    <!-- ç›¸æ©Ÿ -->
    <a-entity camera></a-entity>
  </a-scene>

  <script>
    // éŠæˆ²é‚è¼¯åƒæ•¸
    const SPRING_WORDS = ['ç¦', 'æ˜¥', 'è²¡', 'å®‰', 'æ—º', 'å‰', 'ç¥¥', 'è³€', 'é¾', 'å¹´'];
    const NON_SPRING_WORDS = ['âš½', 'ğŸ”', 'ğŸ§', 'ğŸ§Š', 'ğŸ§¼', 'ğŸº', 'ğŸ’¡', 'ğŸ“', 'ğŸ§½', 'ğŸ§¯'];

    const SPAWN_INTERVAL_MS = 1200;   // ç”Ÿæˆå­—ç‰Œé »ç‡
    const CARD_LIFETIME_MS = 10000;   // ç”Ÿå‘½é€±æœŸï¼ˆè‡ªå‹•ç§»é™¤ï¼‰
    const CARD_SPEED = 0.0012;        // å­—ç‰Œå‘ marker ç§»å‹•çš„é€Ÿåº¦ï¼ˆm/msï¼‰
    const COLLISION_RADIUS = 0.06;    // ç¢°æ’æª¢æ¸¬åŠå¾‘ï¼ˆèˆ‡ hitPoint è·é›¢é–¾å€¼ï¼‰

    let score = 0;
    const scoreEl = document.getElementById('score');

    const markerEl = document.getElementById('hiroMarker');
    const dragonRoot = document.getElementById('dragonRoot');
    const hitPoint = document.getElementById('hitPoint');

    // ç”Ÿæˆå®¹å™¨ï¼šæŠŠå­—ç‰Œæ”¾åˆ°å ´æ™¯ä¸‹ï¼ˆä¸–ç•Œåº§æ¨™ï¼‰ï¼Œè®“å®ƒå€‘æœ marker ç§»å‹•
    const sceneEl = document.querySelector('a-scene');

    // å·¥å…·ï¼šå–å¾—ä¸–ç•Œåº§æ¨™
    function getWorldPosition(aEntity) {
      const obj3D = aEntity.object3D;
      const v = new THREE.Vector3();
      obj3D.getWorldPosition(v);
      return v;
    }

    // å·¥å…·ï¼šç·šæ€§æ’å€¼
    function lerp(a, b, t) { return a + (b - a) * t; }

    // ç”Ÿæˆä¸€å€‹å­—ç‰Œ
    function spawnCard() {
      const isSpring = Math.random() < 0.6; // 60% æ©Ÿç‡ç”Ÿæˆæ–°æ˜¥å­—
      const text = isSpring
        ? SPRING_WORDS[Math.floor(Math.random() * SPRING_WORDS.length)]
        : NON_SPRING_WORDS[Math.floor(Math.random() * NON_SPRING_WORDS.length)];

      // åœ¨ marker å‘¨é‚Šéš¨æ©Ÿä¸€å€‹ã€Œå¤–åœˆã€ä½ç½®ç”Ÿæˆï¼ˆåŠå¾‘ rï¼‰
      const radius = 1.2; // 1.2 å…¬å°ºå¤–çš„ä½ç½®
      const angle = Math.random() * Math.PI * 2;
      const startX = Math.cos(angle) * radius;
      const startZ = Math.sin(angle) * radius;
      const startY = 0.4 + Math.random() * 0.6; // ç¨å¾®æœ‰é«˜åº¦è®ŠåŒ–

      // ç”¨ a-entity + a-plane + a-text
      const wrapper = document.createElement('a-entity');
      wrapper.setAttribute('position', `${startX} ${startY} ${startZ}`);
      wrapper.setAttribute('rotation', `0 ${-THREE.MathUtils.radToDeg(angle)} 0`); // æœå‘ä¸­å¿ƒ
      wrapper.setAttribute('data-is-spring', isSpring ? '1' : '0');
      wrapper.setAttribute('data-created', String(performance.now()));

      // èƒŒæ¿
      const plate = document.createElement('a-plane');
      plate.setAttribute('width', '0.22');
      plate.setAttribute('height', '0.22');
      plate.setAttribute('material', `color: ${isSpring ? '#b30000' : '#39424e'}; opacity:0.92; side:double; metalness:0.0; roughness:0.9`);
      plate.setAttribute('position', '0 0 0');

      // æ–‡å­—
      const textEl = document.createElement('a-text');
      textEl.setAttribute('value', text);
      textEl.setAttribute('color', isSpring ? '#ffd647' : '#ffffff');
      textEl.setAttribute('align', 'center');
      textEl.setAttribute('anchor', 'center');
      textEl.setAttribute('width', '1.2'); // æ”¾å¤§å­—
      textEl.setAttribute('position', '0 0 0.001'); // ç¨å¾®å‰ç§»é¿å… z-fighting
      textEl.setAttribute('shader', 'msdf');
      textEl.setAttribute('font', 'https://cdn.jsdelivr.net/gh/etiennepinchon/aframe-fonts/fonts/roboto/Roboto-Regular.json');

      wrapper.appendChild(plate);
      wrapper.appendChild(textEl);

      // åŠ å…¥å ´æ™¯ï¼ˆä¸–ç•Œåº§æ¨™ï¼‰
      sceneEl.appendChild(wrapper);

      // ç§»å‹•é‚è¼¯ï¼šæ¯å¹€å¾€ marker ä½ç½®é è¿‘
      wrapper.setAttribute('data-tick', '1');
      const tick = (time, delta) => {
        if (!wrapper.parentNode) return; // å·²ç§»é™¤
        // ç”Ÿå‘½é€±æœŸåˆ°æœŸå‰‡åˆªé™¤
        const created = Number(wrapper.getAttribute('data-created'));
        if (performance.now() - created > CARD_LIFETIME_MS) {
          wrapper.parentNode && wrapper.parentNode.removeChild(wrapper);
          return;
        }

        // ç•¥å¾®æœå‘ marker
        const markerPos = getWorldPosition(markerEl);
        const pos = getWorldPosition(wrapper);

        // æ¯å¹€å‘ marker å…§æ’ç§»å‹•
        const dir = new THREE.Vector3().subVectors(markerPos, pos);
        const dist = dir.length();
        if (dist > 0.0001) {
          dir.normalize();
          const move = CARD_SPEED * delta;
          pos.addScaledVector(dir, move);
          // æ›´æ–° wrapper çš„ positionï¼ˆéœ€è½‰è‡³æœ¬åœ°åº§æ¨™ï¼‰
          const parentObj = wrapper.object3D.parent;
          const invParent = new THREE.Matrix4().copy(parentObj.matrixWorld).invert();
          const localPos = pos.clone().applyMatrix4(invParent);
          wrapper.object3D.position.copy(localPos);
        }

        // é¢å‘ç«é¾ï¼ˆæˆ–æœå‘ç§»å‹•æ–¹å‘ï¼‰
        const toDragon = new THREE.Vector3().subVectors(getWorldPosition(dragonRoot), pos).normalize();
        const yaw = Math.atan2(toDragon.x, toDragon.z);
        wrapper.object3D.rotation.set(0, yaw, 0);

        // ç¢°æ’æª¢æ¸¬ï¼šèˆ‡ hitPoint çš„è·é›¢
        const hitPos = getWorldPosition(hitPoint);
        const d = hitPos.distanceTo(pos);
        if (d <= COLLISION_RADIUS) {
          handleCollision(wrapper);
        }

        requestAnimationFrame((t) => tick(t, 16));
      };
      requestAnimationFrame((t) => tick(t, 16));
    }

    // è™•ç†ç¢°æ’ï¼šåŠ /æ‰£åˆ†ä¸¦ç§»é™¤å¡ç‰‡ï¼ŒåŒæ™‚è§¸ç™¼ä¸€å€‹å°çˆ†èŠ±æ•ˆæœ
    function handleCollision(cardEl) {
      if (!cardEl.parentNode) return;
      const isSpring = cardEl.getAttribute('data-is-spring') === '1';
      if (isSpring) {
        score += 15;
      } else {
        score -= 5;
      }
      scoreEl.textContent = score;

      // å°çˆ†èŠ±æ•ˆæœ
      const boom = document.createElement('a-entity');
      boom.setAttribute('position', cardEl.getAttribute('position'));
      boom.setAttribute('particle-system', `
        type: sphere;
        particleCount: 200;
        size: 0.05;
        sizeSpread: 0.03;
        color: ${isSpring ? '#ffe083, #ff6a00, #fff6c0' : '#a0c4ff, #90e0ef, #caf0f8'};
        opacity: 0.95;
        velocitySpread: 0.8 0.8 0.8;
        accelerationValue: 0 -0.3 0;
        duration: 0.08;
        maxAge: 0.6;
      `);
      sceneEl.appendChild(boom);
      setTimeout(() => boom.parentNode && boom.parentNode.removeChild(boom), 700);

      // ç§»é™¤å¡ç‰‡
      cardEl.parentNode && cardEl.parentNode.removeChild(cardEl);
    }

    // ç”Ÿæˆå¾ªç’°
    let spawnTimer = null;
    function startSpawning() {
      if (spawnTimer) return;
      spawnTimer = setInterval(spawnCard, SPAWN_INTERVAL_MS);
    }
    function stopSpawning() {
      if (spawnTimer) {
        clearInterval(spawnTimer);
        spawnTimer = null;
      }
    }

    // ç•¶ marker å¯è¦‹æ™‚é–‹å§‹ç”Ÿæˆï¼Œä¸å¯è¦‹æ™‚åœæ­¢
    markerEl.addEventListener('markerFound', () => startSpawning());
    markerEl.addEventListener('markerLost', () => stopSpawning());

    // åˆå§‹åŒ–åˆ†æ•¸
    scoreEl.textContent = score;

    // é‡ç½®åˆ†æ•¸æŒ‰éˆ•
    document.getElementById('resetBtn').addEventListener('click', () => {
      score = 0;
      scoreEl.textContent = score;
    });

    // é¡åƒé–‹é—œï¼šæ°´å¹³ç¿»è½‰ video èˆ‡ HUD
    const mirrorBtn = document.getElementById('mirrorBtn');
    mirrorBtn.addEventListener('click', () => {
      document.body.classList.toggle('mirrored');
    });

    // ç­‰å¾… AR.js å»ºç«‹ video å…ƒç´ å¾ŒåŠ ä¸Š idï¼Œä¾¿æ–¼ CSS æ§åˆ¶
    const observeVideo = new MutationObserver(() => {
      const vids = document.querySelectorAll('video');
      vids.forEach(v => {
        if (!v.id) v.id = 'arjs-video';
      });
    });
    observeVideo.observe(document.body, { childList: true, subtree: true });

    // ä¿éšœå ´æ™¯åœ¨æ‰‹æ©Ÿè¢å¹•çš„è‡ªå‹•å…¨å±é¡¯ç¤º
    function resizeCanvas() {
      const canvas = document.querySelector('.a-canvas');
      if (canvas) {
        canvas.style.width = '100%';
        canvas.style.height = '100%';
      }
    }
    window.addEventListener('resize', resizeCanvas);
    setTimeout(resizeCanvas, 1000);
  </script>
</body>
</html>
